<!DOCTYPE html>
<html>
<head>
    <title>Test Timeout</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .log { border: 1px solid #ccc; padding: 10px; margin: 10px 0; max-height: 400px; overflow: auto; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>GitHub Fetch Timeout Test</h1>
    <div>
        <button onclick="testFetch('tmr')">Test TMR Fetch</button>
        <button onclick="testFetch('goldcoast')">Test Gold Coast Fetch</button>
        <button onclick="testFetch('timeout')">Test Timeout</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    <div id="log" class="log"></div>

    <script>
        const GITHUB_CONFIG = {
            username: 'crsanju',
            repo: 'Cromton_Traffic_Analysis'
        };

        const URLs = {
            tmr: `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/main/tmr.geojson`,
            goldcoast: `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/main/goldcoast.geojson`
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testFetch(type) {
            clearLog();
            
            if (type === 'timeout') {
                log('Testing Promise.race with timeout...', 'info');
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => {
                        log('Timeout triggered!', 'error');
                        reject(new Error('Test timeout (2s)'));
                    }, 2000)
                );

                const slowPromise = new Promise(() => {
                    log('Slow promise started (never resolves)...', 'info');
                    // Never resolves
                });

                try {
                    await Promise.race([slowPromise, timeoutPromise]);
                } catch(err) {
                    log(`Caught: ${err.message}`, 'error');
                }
                return;
            }

            const url = URLs[type];
            log(`Testing fetch with timeout: ${url}`, 'info');

            try {
                const fetchTimeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => {
                        log('Fetch timeout (10s) triggered', 'error');
                        reject(new Error('GitHub fetch timeout (10s)'));
                    }, 10000)
                );

                const fetchPromise = fetch(url).then(response => {
                    log(`Response received: HTTP ${response.status}`, 'success');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                });

                const response = await Promise.race([
                    fetchPromise,
                    fetchTimeoutPromise
                ]);

                log('Starting JSON parsing...', 'info');

                const parsingTimeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => {
                        log('Parsing timeout (5s) triggered', 'error');
                        reject(new Error('JSON parsing timeout (5s)'));
                    }, 5000)
                );

                const dataPromise = response.json().then(data => {
                    const count = data.records?.length || data.features?.length || 0;
                    log(`JSON parsed: ${count} records`, 'success');
                    return data;
                });

                const data = await Promise.race([
                    dataPromise,
                    parsingTimeoutPromise
                ]);

                log(`Success! Downloaded data:`, 'success');
                log(`  - Type: ${data.records ? 'Records' : data.features ? 'GeoJSON' : 'Unknown'}`, 'info');
                log(`  - Size: ${JSON.stringify(data).length} bytes`, 'info');

            } catch (err) {
                log(`Error: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>
