
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Analysis Dashboard V8 - Updated Queue Logic</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f6f3ef;
            --ink: #1c1c1c;
            --muted: #5f5f5f;
            --card: #ffffff;
            --line: #e1ded8;
            --brand: #1f5e63;
            --brand-2: #0f2f32;
            --accent: #d36b2c;
            --shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        }

        * { box-sizing: border-box; }
        body {
            font-family: "Space Grotesk", "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", "Lucida Sans", sans-serif;
            background: radial-gradient(1200px 600px at 10% -10%, #e8f0ef 0%, transparent 55%),
                        radial-gradient(1200px 600px at 100% -10%, #f3e7dc 0%, transparent 50%),
                        var(--bg);
            color: var(--ink);
            margin: 0;
            padding: 24px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--line);
        }
        h1 {
            text-align: center;
            color: var(--brand-2);
            letter-spacing: 0.5px;
            margin: 10px 0 24px;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 22px; }
        .stack { display: flex; flex-direction: column; gap: 22px; }
        .card {
            background: var(--card);
            padding: 18px;
            border-radius: 12px;
            border: 1px solid var(--line);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
            margin-bottom: 0;
        }
        .card h3 {
            margin: 0 0 12px;
            color: var(--brand-2);
            border-bottom: 2px solid var(--brand);
            padding-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 700;
            font-size: 0.9em;
            color: var(--muted);
        }
        select, input {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 12px;
            border: 1px solid var(--line);
            border-radius: 8px;
            background: #fbfbfa;
            color: var(--ink);
        }
        select:focus, input:focus { outline: 2px solid rgba(31, 94, 99, 0.2); border-color: var(--brand); }
        button {
            background-color: var(--brand);
            color: white;
            padding: 11px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }
        button:hover { background-color: #174a4e; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { border: 1px solid var(--line); padding: 8px; text-align: center; }
        th { background-color: var(--brand); color: white; }
        
        .summary-table th { background-color: #2d3a3b; color: #fff; }
        .summary-table td { font-weight: bold; }
        .row-header { text-align: left; background-color: #f0ebe5; }

        .status-green { background-color: #d4edda; color: #155724; }
        .status-yellow { background-color: #fff3cd; color: #856404; }
        .status-red { background-color: #f8d7da; color: #721c24; }
        
        .hidden { display: none; }
        .params-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .year-calc-info { background-color: #e2e3e5; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9em; }
        .data-table { max-height: 400px; overflow-y: auto; }
        .data-table table { font-size: 0.85em; }
        .data-table th { position: sticky; top: 0; z-index: 1; }
        
        #map { height: 400px; width: 100%; border-radius: 10px; border: 2px solid var(--brand); }
        .map-info { margin-top: 10px; padding: 10px; background: #eef4f3; border-radius: 8px; font-size: 0.9em; }
        .site-id-label {
            background: rgba(255,255,255,0.95);
            border: 1px solid #0056b3;
            color: #003b73;
            font-size: 10px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            box-shadow: none;
            pointer-events: none;
        }

        /* Tab Navigation Styles */
        .tab-bar {
            margin-bottom: 20px;
            padding-bottom: 8px;
        }
        .tab-selector {
            width: 100%;
            max-width: 500px;
            padding: 12px 18px;
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            background-color: #ffffff;
            border: 2px solid var(--brand);
            border-radius: 10px;
            cursor: pointer;
            outline: none;
            transition: 0.2s;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%231f6367%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22%3e%3cpolyline points=%226 9 12 15 18 9%22%3e%3c/polyline%3e%3c/svg%3e');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }
        .tab-selector:hover {
            border-color: #174a4e;
            box-shadow: 0 2px 8px rgba(31, 99, 103, 0.15);
        }
        .tab-selector:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(31, 99, 103, 0.1);
        }
        .tab-content { display: none; animation: fadeEffect 0.2s; }
        .tab-content.active { display: block; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

        /* Navigation Bar */
        .navbar {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        .home-button {
            background-color: var(--brand);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 15px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            width: auto;
        }
        .home-button:hover { background-color: #174a4e; }
        .home-button::before {
            content: 'üè†';
        }

        /* Loader for GeoJSON */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0056b3; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 10px; }

        /* LOS Colors */
        .los-a { background-color: #00eb00; color: black; }
        .los-b { background-color: #92d050; color: black; }
        .los-c { background-color: #ffff00; color: black; }
        .los-d { background-color: #ffc000; color: black; }
        .los-e { background-color: #e26b0a; color: white; }
        .los-f { background-color: #c00000; color: white; }
        
        /* Loading Indicator */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 28px rgba(0,0,0,0.25);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0056b3;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 18px;
            color: #333;
        }

        /* Modal Dialog Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefdfb;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
        }
        .modal-header {
            font-size: 1.3em;
            font-weight: bold;
            color: #1f5e63;
            margin-bottom: 15px;
            border-bottom: 2px solid #1f5e63;
            padding-bottom: 10px;
        }
        .modal-body {
            margin: 20px 0;
            font-size: 0.95em;
            color: #333;
            line-height: 1.6;
        }
        .option-section {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-left: 4px solid #1f5e63;
            border-radius: 6px;
        }
        .option-title {
            font-weight: bold;
            color: #1f5e63;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        .option-inputs {
            display: grid;
            gap: 10px;
        }
        .option-inputs input, .option-inputs select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 25px;
        }
        .modal-btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95em;
        }
        .modal-btn-primary {
            background-color: #1f5e63;
            color: white;
        }
        .modal-btn-primary:hover {
            background-color: #174a4e;
        }
        .modal-btn-secondary {
            background-color: #ddd;
            color: #333;
        }
        .modal-btn-secondary:hover {
            background-color: #bbb;
        }
        .loading-subtext {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        /* Smart Search Landing Page Styles */
        .landing-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1f5e63 0%, #15373a 100%);
            z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            color: white;
            transition: opacity 0.5s;
        }
        .landing-content {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .landing-content h1 { color: white; margin-bottom: 10px; font-size: 2.5em; }
        .landing-content p { color: #e0e0e0; margin-bottom: 30px; font-size: 1.1em; }

        .search-box-container {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .search-box-container input {
            flex-grow: 1; padding: 15px; border: none; border-radius: 5px;
            font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .search-box-container button {
            width: auto; padding: 0 30px; background: #f4c35e; color: #1f2b2c;
        }
        .search-box-container button:hover { background: #e0b24f; }

        .quick-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px;}
        .action-btn { padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; border: none; transition: 0.2s; }
        .action-btn.secondary { background: rgba(255,255,255,0.2); color: white; }
        .action-btn.secondary:hover { background: rgba(255,255,255,0.3); }
        .action-btn.outline { background: transparent; border: 1px solid rgba(255,255,255,0.5); color: white; }
        .action-btn.outline:hover { background: rgba(255,255,255,0.1); }

        .search-status { margin-top: 15px; height: 20px; font-size: 0.9em; color: #f4c35e; }
        .hidden-overlay { opacity: 0; pointer-events: none; }

        #mismatchPanel .landing-content {
            color: #1c1c1c;
        }

        #mismatchPanel label {
            color: #1c1c1c;
        }

        #mismatchPanel input {
            background: #ffffff;
            color: #1c1c1c;
        }

        .map-link { color: var(--brand-2); text-decoration: none; font-weight: 700; }
        .map-link:hover { text-decoration: underline; }

        .container-flex { display: grid; grid-template-columns: 1fr 1fr; gap: 22px; }
        .panel-side, .panel-main { width: 100%; }

        .tmr-tab .card {
            background: linear-gradient(180deg, #ffffff 0%, #f8f4ef 100%);
            border-color: #e7e2d9;
        }

        .tmr-tab h3 {
            border-bottom-color: #d36b2c;
        }

        .tmr-results {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .tmr-table th {
            background-color: #1f5e63;
        }

        .tmr-table tr:nth-child(even) td {
            background-color: #fbf7f1;
        }

        .tmr-tab .year-calc-info {
            background: #eef4f3;
            border: 1px solid #dbe6e4;
        }

        .tmr-tab .data-table {
            max-height: none;
        }

        .tmr-detail-card {
            border: 1px solid #e5e1db;
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
        }

        .tmr-detail-title {
            background: linear-gradient(135deg, #f0f4f3 0%, #e7eef0 100%);
            color: #1f2b2c;
            font-weight: 700;
            padding: 10px 14px;
            font-size: 0.95em;
            letter-spacing: 0.2px;
        }

        .tmr-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88em;
        }

        .tmr-detail-table th,
        .tmr-detail-table td {
            border-bottom: 1px solid #ece7df;
            padding: 8px 10px;
            text-align: right;
        }

        .tmr-detail-table th {
            background: #f7f6f4;
            color: #293233;
            text-transform: uppercase;
            font-size: 0.74em;
            letter-spacing: 0.6px;
        }

        .tmr-detail-table td:first-child,
        .tmr-detail-table th:first-child {
            text-align: left;
            font-weight: 700;
            color: #2f3b3c;
            width: 220px;
        }

        .tmr-detail-table tr:nth-child(even) td {
            background: #faf8f5;
        }

        .tmr-detail-row-highlight td {
            background: #f4efe6 !important;
            font-weight: 700;
        }

        .tmr-detail-row-queue td {
            background: #eef4f8 !important;
            font-weight: 700;
        }

        .tmr-detail-max {
            color: #d36b2c;
            font-weight: 800;
        }

        .tmr-tab .grid {
            grid-template-columns: 1fr;
        }

        .tmr-site-card {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            align-items: start;
        }

        .tmr-site-card .card {
            margin: 0;
        }

        .tmr-collapsible {
            border: 1px solid #e1ded8;
            border-radius: 10px;
            background: #ffffff;
            padding: 0;
            overflow: hidden;
        }

        .tmr-collapsible summary {
            list-style: none;
            cursor: pointer;
            padding: 14px 18px;
            font-weight: 700;
            color: #1f2b2c;
            background: #f4f1ed;
            border-bottom: 1px solid #e1ded8;
        }

        .tmr-collapsible summary::-webkit-details-marker {
            display: none;
        }

        .tmr-collapsible .card {
            border: none;
            box-shadow: none;
            border-radius: 0;
        }

        /* Gold Coast Tab Styling (matches TMR) */
        .gc-tab .card {
            background: linear-gradient(180deg, #ffffff 0%, #f8f4ef 100%);
            border-color: #e7e2d9;
        }

        .gc-tab h3 {
            border-bottom-color: #d36b2c;
        }

        .gc-tab .year-calc-info {
            background: #eef4f3;
            border: 1px solid #dbe6e4;
        }

        .gc-tab .grid {
            grid-template-columns: 1fr;
        }

        .gc-site-card {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            align-items: start;
        }

        .gc-site-card .card {
            margin: 0;
        }

        .gc-collapsible {
            border: 1px solid #e1ded8;
            border-radius: 10px;
            background: #ffffff;
            padding: 0;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .gc-collapsible summary {
            list-style: none;
            cursor: pointer;
            padding: 14px 18px;
            font-weight: 700;
            color: #1f2b2c;
            background: #f4f1ed;
            border-bottom: 1px solid #e1ded8;
        }

        .gc-collapsible summary::-webkit-details-marker {
            display: none;
        }

        .gc-collapsible .card {
            border: none;
            box-shadow: none;
            border-radius: 0;
        }

        .gc-detail-card {
            border: 1px solid #e5e1db;
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
            margin-bottom: 12px;
        }

        .gc-detail-title {
            background: linear-gradient(135deg, #f0f4f3 0%, #e7eef0 100%);
            color: #1f2b2c;
            font-weight: 700;
            padding: 10px 14px;
            font-size: 0.95em;
            letter-spacing: 0.2px;
        }

        /* Print Styles */
        @media print {
            .navbar, .home-button, .tab-bar, button {
                display: none !important;
            }
            
            .tmr-collapsible, .gc-collapsible {
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            
            .tmr-collapsible summary, .gc-collapsible summary {
                display: block;
                background: #f4f1ed;
                padding: 10px;
                font-weight: bold;
                cursor: default;
            }
            
            .tmr-collapsible[open] summary::after,
            .gc-collapsible[open] summary::after {
                content: '';
            }
            
            details {
                display: block !important;
            }
            
            details summary {
                display: block !important;
            }
            
            details[open] {
                display: block !important;
            }
            
            details > *:not(summary) {
                display: block !important;
            }
            
            .card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .tmr-detail-card, .gc-detail-card {
                page-break-inside: avoid;
                box-shadow: none;
            }
        }

        @media (max-width: 1100px) {
            .grid, .container-flex { grid-template-columns: 1fr; }
            .tab-button { width: 100%; justify-content: center; }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div id="landingPage" class="landing-overlay">
    <div class="landing-content">
        <h1>Crompton Traffic Analysis </h1>
        <p>Enter a location to automatically find the nearest traffic data point.</p>
        
        <div class="search-box-container">
            <input type="text" id="landingSearchInput" placeholder="Enter address, suburb, or lat,long..." onkeypress="handleEnter(event)">
            <button onclick="executeSmartSearch()">Search Location</button>
        </div>
        
        <div class="quick-actions">
            <button class="action-btn secondary" onclick="useCurrentLocation()">üìç Use My Location</button>
            <button class="action-btn outline" onclick="closeLandingPage()">Browse Dashboard Manually</button>
        </div>

        <div id="searchStatus" class="search-status"></div>
    </div>
</div>

<div id="mismatchPanel" class="landing-overlay hidden-overlay">
    <div class="landing-content">
        <h1>Road Not In Database</h1>
        <p id="mismatchSummary">We could not find this road in the database.</p>

        <div class="params-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; text-align: left;">
            <div>
                <label for="mismatchPercent">Percent of known road volume (%)</label>
                <input type="number" id="mismatchPercent" value="100" min="0" step="1">
            </div>
            <div>
                <label for="mismatchHouseholds">Total number of households</label>
                <input type="number" id="mismatchHouseholds" value="0" min="0" step="1">
            </div>
        </div>

        <div class="search-status" id="mismatchResult"></div>

        <div class="quick-actions">
            <button class="action-btn secondary" onclick="applyMismatchInputs()">Use Custom TIA</button>
            <button class="action-btn outline" onclick="closeMismatchPanel()">Cancel</button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text">Loading Traffic Data...</div>
        <div class="loading-subtext" id="loadingProgress">Initializing...</div>
        <div style="font-size:0.75em; color:#999; margin-top:15px;" id="loadingDetails"></div>
    </div>
</div>

<div class="container">
    <div class="navbar">
        <button class="home-button" onclick="goToHome()">Home</button>
    </div>
    <h1>Traffic Analysis Dashboard</h1>
    
    <div class="tab-bar">
        <select class="tab-selector" id="tabSelector" onchange="openTabFromDropdown()">
            <option value="tab-hourly" selected>TMR Roads</option>
            <option value="tab-traffic-analysis">Traffic Impact Analysis</option>
            <option value="tab-tia">Gold coast (Legacy)</option>
            <option value="tab-toowoomba">Toowoomba</option>
            <option value="Ipswich">Ipswich Analysis</option>
            <option value="Logan">Logan Analysis</option>
        </select>
    </div>

    <div id="tab-hourly" class="tab-content active tmr-tab">
    <div class="card">
        <h3>1. Site Selection & Location</h3>
        <div class="tmr-site-card">
            <div class="card">
                <label for="siteSelect">Search Site ID or Name:</label>
                <input list="sites" id="siteInput" placeholder="Type to search or click a marker on the map...">
                <datalist id="sites"></datalist>
                <p style="font-size: 0.85em; color:#666; margin-top: 5px;">
                    üí° <strong>Tip:</strong> Type a site ID/name above OR click any marker on the map
                </p>
                <div id="siteInfo" class="hidden">
                    <p><strong>Road:</strong> <span id="roadName"></span></p>
                    <p><strong>Description:</strong> <span id="siteDesc"></span></p>
                </div>
            </div>

            <div id="mapSection" class="card">
                <p id="tmrMapCount" style="font-size:0.85em; color:#555; margin: 0 0 8px 0;">Showing 0 of 0 sites</p>
                <div id="map"></div>
                <div class="map-info">
                    <p><strong>Coordinates:</strong> <span id="mapCoords">-</span></p>
                    <a id="mapLink" href="#" target="_blank" class="map-link">üìç View on Google Maps</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Data Table -->
    <details id="rawDataSection" class="tmr-collapsible hidden">
        <summary>2. Site Traffic Data (Weekday & Weekend Average by Hour)</summary>
        <div class="card">
            <div class="data-table">
                <table id="rawDataTable" class="tmr-table">
                    <thead>
                        <tr>
                            <th>Direction</th>
                            <th>Hour</th>
                            <th>Weekday Avg</th>
                            <th>Weekend Avg</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </details>

    <div class="card">
        <h3>4. Analysis Parameters</h3>
        <div class="year-calc-info">
            <strong>Year Calculation:</strong> Growth applied for <strong><span id="calcYears">0</span> years</strong>.
        </div>
        <div class="params-grid">
            <div><label>Data Year:</label><input type="number" id="dataYear" value="2020" step="1" onchange="updateYears()"></div>
            <div><label>Opening Year:</label><input type="number" id="openingYear" value="2026" step="1" onchange="updateYears()"></div>
            <div><label>Growth (%):</label><input type="number" id="growthRate" value="3.0" step="0.1"></div>
            <div><label>HV (%):</label><input type="number" id="hvPercent" value="7.0" step="0.1"></div>
        </div>
        
        <div class="params-grid" style="margin-top:10px; border-top: 1px solid #ddd; padding-top:10px;">
            <div style="grid-column: span 2;">
                <label>Road Type (Auto-Cap):</label>
                <select id="roadType" onchange="updateAutoCapacity()">
                    <option value="">-- Select Road Type --</option>
                    <option value="freeway">Freeway (100km/h+)</option>
                    <option value="highway">Multi-lane Highway</option>
                    <option value="arterial_high">High-Quality Arterial</option>
                    <option value="arterial_urban">Typical Urban Arterial</option>
                    <option value="signals">Signalised Intersection (Peak)</option>
                </select>
            </div>
            <div><label>K-Factor (%):</label><input type="number" id="kFactor" value="10" step="0.5"></div>
        </div>

        <div class="params-grid">
            <div><label>Lanes (Dir):</label><input type="number" id="lanes" value="2" step="1"></div>
            <div><label>Cap/Ln:</label><input type="number" id="capacity" value="900" step="50"></div>
            <div style="grid-column: span 2;"><label>Directional Split (D%):</label><input type="number" id="dSplit" value="60" step="1"></div>
        </div>
        <button onclick="calculate()">Calculate Analysis</button>
        <button style="margin-top:8px; width:100%; background: #1f5e63; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;" onclick="sendTMRDataToCalc()">üìä View Full Calculations ‚Üí</button>
    </div>

    <div id="results" class="hidden tmr-results">

        <div class="card">
            <h3>5. Detailed TMR Period Breakdown</h3>
            <p style="font-size:0.85em; color:#666; margin: 0 0 10px 0;">AM / OP / PM / EV details with LV/HV split and queue length estimation.</p>
            <div id="tmrDetailedSection"></div>
        </div>
        
        <div class="card">
            <h3>6. Design Volume, VCR & LOS Summary - <span id="displayYear"></span></h3>
            <table class="summary-table tmr-table" id="designVcrSummaryTable">
                <thead>
                    <tr>
                        <th rowspan="2">Metric</th>
                        <th colspan="3">Design Volume (Capacity) *</th>
                        <th colspan="4">VCR (Volume to Capacity Ratio)</th>
                    </tr>
                    <tr>
                        <th>AG</th>
                        <th>G</th>
                        <th>Both Directions</th>
                        <th>AM</th>
                        <th>OP</th>
                        <th>PM</th>
                        <th>EV</th>
                    </tr>
                </thead>
                <tbody id="designVcrSummaryBody">
                    <tr><td colspan="8">Run calculation...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h3>7. TMR Specific Outputs</h3>
            <table class="tmr-table" style="width:100%; border-collapse: collapse;">
                <tr style="background:#eee; text-align:left;">
                    <th style="padding:8px;">Metric</th>
                    <th style="padding:8px;">Value</th>
                </tr>
                <tr><td style="padding:8px;">Design Hour Volume (DHV)</td><td style="padding:8px; font-weight:bold;" id="tmr_dhv_display">-</td></tr>
                <tr><td style="padding:8px;">Peak Directional Flow</td><td style="padding:8px; font-weight:bold;" id="tmr_peak_display">-</td></tr>
            </table>
        </div>

        <div class="card">
            <h3>8. Traffic Profile (Hourly)</h3>
            <canvas id="trafficChart" height="80"></canvas>
        </div>

        <div class="card">
            <h3>9. Report</h3>
            <p style="font-size:0.85em; color:#666; margin: 0 0 10px 0;">Print the current TMR Roads analysis, tables, and charts.</p>
            <button onclick="printTmrReport()" style="background:#d36b2c;">Print Report</button>
        </div>
    </div>
    </div>

    <!-- UNIFIED TRAFFIC IMPACT ANALYSIS TAB -->
    <div id="tab-traffic-analysis" class="tab-content">
        <!-- Scenario Detection and Selection -->
        <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #f0f8f7 0%, #e8f4f2 100%);">
            <h3>Traffic Impact Analysis - Scenario Selection</h3>
            <p style="color: #666; margin-bottom: 15px;">
                This unified analysis tool calculates queue length and performs traffic impact assessment based on your scenario.
            </p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #1f5e63; cursor: pointer;" onclick="selectScenario(1)">
                    <h4 style="color: #1f5e63; margin: 0 0 10px 0;">‚úì Scenario 1: Same Road</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 0;">
                        Entered address is on the <strong>same road</strong> as the traffic data point. System will automatically analyze data and perform traffic impact assessment.
                    </p>
                    <button class="action-btn secondary" style="margin-top: 10px; width: 100%; padding: 8px; border-radius: 4px;">Use This Scenario</button>
                </div>
                
                <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #d36b2c; cursor: pointer;" onclick="selectScenario(2)">
                    <h4 style="color: #d36b2c; margin: 0 0 10px 0;">‚öô Scenario 2: Different Road</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 0;">
                        Entered address is on a <strong>different road</strong> than the traffic data point. Provide percentage of volume or manual calculation.
                    </p>
                    <button class="action-btn secondary" style="margin-top: 10px; width: 100%; padding: 8px; border-radius: 4px; background: rgba(211, 107, 44, 0.2);">Use This Scenario</button>
                </div>
            </div>
            
            <p style="font-size: 0.85em; color: #999; margin-top: 15px; text-align: center;">
                üí° <strong>Tip:</strong> Click a scenario above to begin, or select a site/location to automatically detect the scenario
            </p>
        </div>

        <!-- SCENARIO 1: SAME ROAD - AUTOMATIC ANALYSIS -->
        <div id="scenario-1-panel" style="display: none;">
            <div class="grid">
                <div class="card">
                    <h3>Scenario 1: Automatic Traffic Analysis</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                        Based on your selected site, the system automatically analyzes traffic volume and calculates queue length.
                    </p>
                    
                    <div style="background: #e8f4f2; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #1f5e63;">
                        <p style="margin: 0; font-size: 0.85em;"><strong>Selected Road:</strong></p>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; font-weight: bold; color: #1f5e63;" id="scenario1-selected-road">-</p>
                    </div>

                    <div class="params-grid">
                        <div><label>Current AADT:</label><input type="number" id="s1_aadt_val" placeholder="e.g. 15000"></div>
                        <div><label>Data Year:</label><input type="number" id="s1_aadt_year_data" value="2024"></div>
                        <div><label>Project Year:</label><input type="number" id="s1_aadt_year_proj" value="2031"></div>
                        <div><label>Growth (% p.a):</label><input type="number" id="s1_aadt_growth" value="3.0" step="0.1"></div>
                        <div><label>HV (%):</label><input type="number" id="s1_aadt_hv" value="5.0" step="0.5"></div>
                    </div>

                    <div class="params-grid" style="margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px;">
                        <div style="grid-column: span 2;">
                            <label>Road Type:</label>
                            <select id="s1_aadt_road_type" onchange="updateS1RoadCapacity()">
                                <option value="freeway-100">Freeway (100km/h) - 2100/ln</option>
                                <option value="highway-multi">Highway (Multi-lane) - 1800/ln</option>
                                <option value="arterial">Arterial (Major) - 1400/ln</option>
                                <option value="urban-street">Urban Street (Signals) - 1000/ln</option>
                            </select>
                        </div>
                        <div><label>Lanes (1 Dir):</label><input type="number" id="s1_aadt_lanes" value="2"></div>
                        <div><label>Cap/Ln:</label><input type="number" id="s1_aadt_cap" value="1800"></div>
                    </div>

                    <div class="params-grid" style="margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px;">
                        <div><label>K-Factor (%):</label><input type="number" id="s1_aadt_k" value="10" title="% of AADT in Peak Hour"></div>
                        <div><label>Dir Split (%):</label><input type="number" id="s1_aadt_d" value="60" title="% in Peak Direction"></div>
                    </div>

                    <button onclick="calculateScenario1()" style="margin-top: 15px; width: 100%; background: #28a745; padding: 11px;">Calculate Traffic Analysis</button>
                </div>

                <div class="card">
                    <h3>Performance Results (Peak Hour)</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="background: #eee; text-align: left;">
                            <th style="padding: 8px;">Metric</th>
                            <th style="padding: 8px;">Value</th>
                        </tr>
                        <tr><td style="padding: 8px;">Future AADT</td><td style="padding: 8px;" id="s1_res_fut_aadt">-</td></tr>
                        <tr><td style="padding: 8px;">Design Hr Vol (DHV)</td><td style="padding: 8px; font-weight: bold;" id="s1_res_dhv">-</td></tr>
                        <tr><td style="padding: 8px;">Volume / Capacity (v/c)</td><td style="padding: 8px;" id="s1_res_vc">-</td></tr>
                        <tr><td style="padding: 8px;">Level of Service</td><td style="padding: 8px; font-weight: bold;" id="s1_res_los">-</td></tr>
                    </table>
                    
                    <h4 style="margin-top: 20px; border-bottom: 2px solid #28a745; color: #333;">Queue Estimation (Blockage)</h4>
                    <p style="font-size: 0.9em; color: #666;">Estimated queue length if traffic is blocked for X minutes during peak.</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Blockage Duration</th>
                                <th>Queue Length (m)</th>
                            </tr>
                        </thead>
                        <tbody id="s1_queue_table">
                            <tr><td colspan="2">Run calculation...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SCENARIO 2: DIFFERENT ROAD - CUSTOM INPUTS -->
        <div id="scenario-2-panel" style="display: none;">
            <div class="grid">
                <div class="stack">
                    <div class="card">
                        <h3>Scenario 2: Custom Volume Estimation</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                            Road not in database or analyzing a different location. Estimate traffic volume using one of two methods.
                        </p>

                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #d36b2c;">
                            <p style="margin: 0; font-size: 0.85em;"><strong>Reference Site:</strong></p>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;" id="s2_nearest_site_ref">Loading...</p>
                        </div>

                        <div style="background: #f0f8f7; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <label for="s2_project_name"><strong>Project / Road Name:</strong></label>
                            <input type="text" id="s2_project_name" placeholder="Enter road/location name" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>

                        <!-- METHOD 1: TRIP GENERATION -->
                        <div class="option-section">
                            <div class="option-title">Method 1: Trip Generation from Households</div>
                            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                                Estimate AADT from residential development based on context
                            </p>
                            <div class="option-inputs">
                                <div>
                                    <label style="margin-bottom: 3px;">Development Context</label>
                                    <select id="s2_dev_context" onchange="updateS2Comparison()">
                                        <option value="10.7">Metropolitan (Sydney/High Growth) - 10.7 trips/dwelling</option>
                                        <option value="7.4" selected>Regional / QLD (Standard) - 7.4 trips/dwelling</option>
                                        <option value="2.4">High Density Apartment - 2.4 trips/dwelling</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="margin-bottom: 3px;">Number of Dwellings (Units):</label>
                                    <input type="number" id="s2_dwellings" value="50" min="1" oninput="updateS2Comparison()">
                                </div>
                                <div>
                                    <label style="margin-bottom: 3px;">Road Assignment Factor (%):</label>
                                    <input type="number" id="s2_road_assign" value="100" min="0" max="100" step="5" oninput="updateS2Comparison()">
                                </div>
                                <div style="background: #e8f4f2; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                    <strong style="color: #1f5e63;">Trip Generation AADT:</strong> <span id="s2_trip_gen_result">0</span> vehicles
                                </div>
                            </div>
                        </div>

                        <!-- METHOD 2: PERCENTAGE OF REFERENCE -->
                        <div class="option-section">
                            <div class="option-title">Method 2: Percentage of Reference Site</div>
                            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                                Use a percentage of the nearest reference site's traffic volume
                            </p>
                            <div class="option-inputs">
                                <div>
                                    <label style="margin-bottom: 3px;">Apply Percentage of Reference (%):</label>
                                    <input type="number" id="s2_percent_ref" value="50" min="0" max="100" step="5" oninput="updateS2Comparison()">
                                </div>
                                <div style="background: #e8f4f2; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                    <strong style="color: #1f5e63;">Percentage-Based AADT:</strong> <span id="s2_percent_result">0</span> vehicles
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: #fffbf0; border: 2px solid #d36b2c; border-radius: 6px;">
                            <p style="font-size: 0.9em; margin: 0 0 10px 0;">
                                <strong style="color: #1f5e63;">Selected Volume (Greater of Both Methods):</strong>
                            </p>
                            <div id="s2_greater_volume" style="font-size: 1.15em; color: #d36b2c; font-weight: bold;">
                                0 vehicles
                            </div>
                        </div>

                        <button onclick="calculateScenario2()" style="margin-top: 15px; width: 100%; background: #d36b2c; padding: 11px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700;">Proceed with Analysis</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Results & Queue Analysis</h3>
                    <div id="s2_results_container" style="display: none;">
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                            <tr style="background: #eee; text-align: left;">
                                <th style="padding: 8px;">Metric</th>
                                <th style="padding: 8px;">Value</th>
                            </tr>
                            <tr><td style="padding: 8px;">Estimated AADT</td><td style="padding: 8px; font-weight: bold;" id="s2_res_aadt">-</td></tr>
                            <tr><td style="padding: 8px;">Peak Hour Volume</td><td style="padding: 8px;" id="s2_res_peak">-</td></tr>
                            <tr><td style="padding: 8px;">Estimated Status</td><td style="padding: 8px;" id="s2_res_status">-</td></tr>
                        </table>

                        <h4 style="border-bottom: 2px solid #d36b2c; color: #333;">Queue Length Estimation</h4>
                        <table class="data-table" style="margin-top: 10px;">
                            <thead>
                                <tr>
                                    <th>Blockage Duration</th>
                                    <th>Queue Length (m)</th>
                                </tr>
                            </thead>
                            <tbody id="s2_queue_table">
                                <tr><td colspan="2">Run calculation...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="s2_results_placeholder" style="padding: 20px; text-align: center; color: #999;">
                        <p>Calculate flow scenario above to see results</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- CALCULATIONS REFERENCE SECTION (Always visible) -->
        <div class="card" style="margin-top: 20px;">
            <h3>üìä Calculation Formulas & Reference</h3>
            <div style="padding: 15px; background: #f0f7ff; border-radius: 8px;">
                <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                    This section shows the formulas and calculations used for both scenarios.
                </p>

                <h4 style="color: #1f5e63; margin-top: 15px;">Key Calculations</h4>
                
                <div style="background: white; padding: 10px; border-left: 3px solid #1f5e63; margin: 10px 0;">
                    <strong>1. Future AADT Projection</strong><br>
                    <small>AADT_future = AADT_current √ó (1 + Growth_Rate)^Years</small>
                </div>

                <div style="background: white; padding: 10px; border-left: 3px solid #1f5e63; margin: 10px 0;">
                    <strong>2. Peak Hour Volume</strong><br>
                    <small>Peak_Hour_Vol = Future_AADT √ó (K-Factor / 100) √ó (Direction_Split / 100)</small>
                </div>

                <div style="background: white; padding: 10px; border-left: 3px solid #1f5e63; margin: 10px 0;">
                    <strong>3. Volume/Capacity Ratio</strong><br>
                    <small>V/C Ratio = Peak_Hour_Vol / (Lanes √ó Capacity_per_Lane)</small>
                </div>

                <div style="background: white; padding: 10px; border-left: 3px solid #1f5e63; margin: 10px 0;">
                    <strong>4. 5-Minute Queue Volume</strong><br>
                    <small>Queue_Vol_5min = Peak_Hour_Vol √ó (5 / 60)</small>
                </div>

                <div style="background: white; padding: 10px; border-left: 3px solid #1f5e63; margin: 10px 0;">
                    <strong>5. Queue Length (Meters)</strong><br>
                    <small>Queue_Length = Queue_Volume √ó Vehicle_Length_Factor<br>(Typical: 5m per vehicle average)</small>
                </div>

                <div style="background: white; padding: 10px; border-left: 3px solid #1f5e63; margin: 10px 0;">
                    <strong>6. Level of Service (LOS)</strong><br>
                    <small>
                        LOS A: V/C < 0.60 (Good)<br>
                        LOS B: V/C 0.60-0.75 (Acceptable)<br>
                        LOS C: V/C 0.75-0.90 (Acceptable)<br>
                        LOS D: V/C 0.90-1.00 (Poor)<br>
                        LOS E-F: V/C > 1.00 (Unacceptable)
                    </small>
                </div>

                <p style="font-size: 0.85em; color: #999; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;">
                    üí° All calculations follow standard traffic engineering principles. Results should be verified by a qualified traffic engineer.
                </p>
            </div>
        </div>
    </div>

    <div id="tab-aadt" class="tab-content">
        <div class="grid">
            <div class="card">
                <h3>AADT Inputs</h3>
                <div class="params-grid">
                    <div><label>Current AADT:</label><input type="number" id="aadt_val" placeholder="e.g. 15000"></div>
                    <div><label>Data Year:</label><input type="number" id="aadt_year_data" value="2024"></div>
                    <div><label>Project Year:</label><input type="number" id="aadt_year_proj" value="2031"></div>
                    <div><label>Growth (% p.a):</label><input type="number" id="aadt_growth" value="3.0" step="0.1"></div>
                    <div><label>HV (%):</label><input type="number" id="aadt_hv" value="5.0" step="0.5"></div>
                </div>
                <div class="params-grid" style="margin-top:10px; border-top:1px solid #ddd; padding-top:10px;">
                    <div style="grid-column: span 2;">
                        <label>Road Type:</label>
                        <select id="aadt_road_type" onchange="updateAadtCap()">
                            <option value="2100">Freeway (100km/h)</option>
                            <option value="1800">Highway (Multi-lane)</option>
                            <option value="1400">Arterial (Major)</option>
                            <option value="1000">Urban Street (Signals)</option>
                        </select>
                    </div>
                    <div><label>Lanes (1 Dir):</label><input type="number" id="aadt_lanes" value="2"></div>
                    <div><label>Cap/Ln:</label><input type="number" id="aadt_cap" value="1800"></div>
                </div>
                <div class="params-grid" style="margin-top:10px; border-top:1px solid #ddd; padding-top:10px;">
                    <div><label>K-Factor (%):</label><input type="number" id="aadt_k" value="10" title="% of AADT in Peak Hour"></div>
                    <div><label>Dir Split (%):</label><input type="number" id="aadt_d" value="60" title="% in Peak Direction"></div>
                </div>
                <button onclick="calculateAADTLogic()" style="margin-top:15px; width:100%; background:#28a745;">Calculate AADT Scenarios</button>
                <button style="margin-top:8px; width:100%; background:#1f5e63; color:white;" onclick="sendAADTDataToCalc()">üìä View Full Calculations ‚Üí</button>
            </div>

            <div class="card">
                <h3>Performance Results (Peak Hour)</h3>
                <table style="width:100%; border-collapse: collapse;">
                    <tr style="background:#eee; text-align:left;">
                        <th style="padding:8px;">Metric</th>
                        <th style="padding:8px;">Value</th>
                    </tr>
                    <tr><td style="padding:8px;">Future AADT</td><td style="padding:8px;" id="res_fut_aadt">-</td></tr>
                    <tr><td style="padding:8px;">Design Hr Vol (DHV)</td><td style="padding:8px; font-weight:bold;" id="res_dhv">-</td></tr>
                    <tr><td style="padding:8px;">Volume / Capacity (v/c)</td><td style="padding:8px;" id="res_vc">-</td></tr>
                    <tr><td style="padding:8px;">Level of Service</td><td style="padding:8px; font-weight:bold;" id="res_los">-</td></tr>
                </table>
                
                <h4 style="margin-top:20px; border-bottom: 2px solid #dc3545;">Queue Estimation (Blockage)</h4>
                <p style="font-size:0.9em; color:#666;">Estimated queue length if traffic is blocked for X minutes during peak.</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Blockage Duration</th>
                            <th>Queue Length (m)</th>
                        </tr>
                    </thead>
                    <tbody id="aadt_queue_table">
                        <tr><td colspan="2">Run calculation...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-tia" class="tab-content gc-tab">
    <div class="card">
        <h3>1. Site Selection & Parameters</h3>
        <div class="gc-site-card">
            <div class="card">
                <h4 style="margin-top:0; color: #1f5e63;">TIA Parameters</h4>
                    <div class="year-calc-info">
                        <strong>Project:</strong> <input type="text" id="tia_project" placeholder="Site Name" style="width:150px; padding:2px;">
                    </div>
                    <div class="params-grid">
                        <div><label>Current AADT:</label><input type="number" id="tia_aadt" value="8022"></div>
                        <div><label>Count Year:</label><input type="number" id="tia_year_data" value="2017"></div>
                        <div><label>Opening Year:</label><input type="number" id="tia_year_open" value="2026"></div>
                        <div><label>Growth (%):</label><input type="number" id="tia_growth" value="2.5" step="0.1"></div>
                    </div>
                    <div class="params-grid" style="margin-top:10px;">
                        <div><label>Lanes (Dir):</label><input type="number" id="tia_lanes" value="1"></div>
                        <div><label>CV (%):</label><input type="number" id="tia_hv" value="5.0" title="Commercial Vehicle Percentage"></div>
                        <div style="grid-column: span 2;"><em style="font-size: 0.85em; color: #666;">Design capacity auto-calculated per Gold Coast formula</em></div>
                    </div>
                    <div class="params-grid" style="margin-top:10px; border-top:1px solid #ddd; padding-top:10px;">
                        <div style="grid-column: span 4;">
                            <p style="font-size: 0.85em; color: #555; margin: 5px 0;">
                                <strong>Note:</strong> Design Capacity is auto-calculated per Gold Coast formula: 
                                MAX(ROUNDUP(0.15 √ó AADT / 2, 0), 500)
                            </p>
                            <p id="tiaDirectionLabelsPreview" style="font-size: 0.85em; color: #1f5e63; margin: 5px 0 0 0;">
                                <strong>Detected directions:</strong> Northbound / Southbound
                            </p>
                        </div>
                    </div>
                    <button id="gcTiaCalcBtn" onclick="calculateTIA(); return false;" style="margin-top:15px; width:100%; background:#1f5e63; color:white; padding:12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:1em; position:relative; z-index:10; transition:all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2);" onmouseover="this.style.background='#28a745'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';" onmouseout="this.style.background='#1f5e63'; this.style.transform='none'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)';">üöÄ Run TIA Calculation</button>
                </div>

            <div id="gcMapSection" class="card">
                <h4 style="margin-top:0; color: #1f5e63;">Site Location (Gold Coast)</h4>
                <p style="font-size:0.85em; color:#555; margin: 0 0 8px 0;">Embedded Gold Coast GeoJSON loaded automatically.</p>
                <div id="interactiveMap" style="height: 400px; width: 100%; border: 2px solid #0056b3; border-radius:4px;"></div>
                <div id="goldCoastCoordDisplay" style="margin-top:10px; padding:10px; background:#f9f9f9; border-radius:4px; display:none;">
                    <p style="font-size:0.9em; color:#666; margin:0;">
                        <strong>Coordinates:</strong> <span id="goldCoastCoordinates">-</span><br>
                        üìç <a id="goldCoastMapLink" href="#" target="_blank" style="color:#0056b3; text-decoration:none;">View on Google Maps</a>
                    </p>
                </div>
                <p style="font-size:0.85em; margin-top:8px; color: #666;">
                    üí° <strong>Tip:</strong> Click any marker on the map above to auto-fill TIA inputs OR manually enter values in the form
                </p>
            </div>
        </div>
    </div>

    <div class="card" id="roadNotFoundMsg" style="display:none; background-color:#fff3cd; border-left: 5px solid #f39c12; border-radius: 6px;">
        <h3 style="color:#d68910; margin-top:0;">‚ö†Ô∏è Road Not in Database</h3>
        <p style="color:#666; margin-bottom:10px;">The road you entered is not available in the traffic count database. Use the <strong>Custom TIA</strong> tab to estimate traffic volumes from:</p>
        <ul style="margin: 10px 0; padding-left: 20px; color:#666;">
            <li>Household/unit counts (trip generation)</li>
            <li>Percentage of nearby reference sites</li>
        </ul>
        <button onclick="openTab(event, 'customTIA')" style="background-color:#f39c12; cursor: pointer; padding: 8px 15px; border: none; border-radius: 4px; font-weight: bold; color: white;">‚ûú Go to Custom TIA</button>
    </div>

    <details class="gc-collapsible" id="gcResultsSection">
        <summary>2. TIA Results & Queue Analysis</summary>
        <div class="card">
            <h4 style="margin-top:0; color: #1f5e63;">Peak Hour Analysis</h4>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Future AADT</td><td id="tia_res_aadt">-</td><td>-</td></tr>
                            <tr><td>Peak Hourly Vol (Design)</td><td id="tia_res_vol">-</td><td>80th Highest</td></tr>
                            <tr><td>Volume / Capacity (VCR)</td><td id="tia_res_vcr">-</td><td id="tia_res_los_badge">-</td></tr>
                        </tbody>
                    </table>
                </div>
    </details>

    <details class="gc-collapsible" id="gcQueueSection">
        <summary>3. Directional Queue Length Estimation</summary>
        <div class="card">
            <p style="font-size:0.85em; color:#666; margin-bottom:12px;">
                Includes 80th highest hour and off-peak traffic (45% of remaining volume), with CV-based queue lengths.
            </p>
            <div id="tiaDirectionalQueueSection" style="display:flex; flex-direction:column; gap:12px;">
                <div style="font-size:0.85em; color:#777;">Run TIA calculation to view directional queue tables.</div>
            </div>
        </div>
    </details>

    <details class="gc-collapsible" id="gcImpactSection">
        <summary>4. Traffic Impact Analysis (VCR)</summary>
        <div class="card">
                    <div id="trafficImpactAnalysisSection" style="display:none;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.9em; margin-top:10px;">
                            <thead>
                                <tr style="background:#f4f6f8; font-weight:bold;">
                                    <th style="padding:8px; border:1px solid #ddd; text-align:left;"></th>
                                    <th style="padding:8px; border:1px solid #ddd; text-align:center;">Design Volume (Capacity) *</th>
                                    <th style="padding:8px; border:1px solid #ddd; text-align:center;" colspan="2">VCR (Degree of Saturation)</th>
                                </tr>
                                <tr style="background:#e8eef3; font-weight:bold; font-size:0.85em;">
                                    <th style="padding:6px; border:1px solid #ddd;"></th>
                                    <th style="padding:6px; border:1px solid #ddd; text-align:right;" id="tia_design_capacity">-</th>
                                    <th style="padding:6px; border:1px solid #ddd; text-align:center;">Peak</th>
                                    <th style="padding:6px; border:1px solid #ddd; text-align:center;">Off-Peak</th>
                                </tr>
                            </thead>
                            <tbody id="tia_vcr_scenarios">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                        <p style="font-size:0.8em; color:#666; margin-top:8px;">* Greater of 30th Highest Hour of AADT or 500</p>
                    </div>
        </div>
    </details>

    <details class="gc-collapsible" id="gcPedestrianSection">
        <summary>5. Pedestrian Delay</summary>
        <div class="card">
                    <div id="pedestrianDelaySection" style="display:none;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.85em; margin-top:10px; background:#f9f9f9;">
                            <tr><td style="padding:6px; border:1px solid #ddd; font-weight:bold;">Assumptions:</td><td style="padding:6px; border:1px solid #ddd;"></td></tr>
                            <tr><td style="padding:6px; border:1px solid #ddd;">Pedestrian travel speed:</td><td style="padding:6px; border:1px solid #ddd; text-align:right;">1.2 m/s</td></tr>
                            <tr><td style="padding:6px; border:1px solid #ddd;">Approximate expected delay time at the controlled crossings</td><td style="padding:6px; border:1px solid #ddd; text-align:right;">60 s</td></tr>
                            <tr><td style="padding:6px; border:1px solid #ddd;">Approximate expected delay time at the uncontrolled crossing</td><td style="padding:6px; border:1px solid #ddd; text-align:right;">10 s</td></tr>
                        </table>
        </div>
    </details>

    <details class="gc-collapsible" id="gcDetourSection">
        <summary>6. Estimated Delay - Detour Routes (Optional)</summary>
        <div class="card">
            <p style="font-size:0.85em; color:#666; margin-bottom:12px;">
                Enter detour route details to calculate estimated delay times. This is optional and site-specific.
            </p>
            
            <div style="background: #f0f8f7; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <label style="display:block; margin-bottom:8px; font-weight:bold; color:#1f5e63;">Number of Detour Routes:</label>
                <input type="number" id="gc_detour_count" value="1" min="0" max="5" style="width:100px; padding:6px;" onchange="generateDetourInputs()">
                <button onclick="generateDetourInputs()" style="margin-left:10px; padding:6px 12px; background:#1f5e63; color:white; border:none; border-radius:4px; cursor:pointer;">Generate Fields</button>
            </div>

            <div id="detourInputsSection" style="margin-bottom:15px;">
                <!-- Will be populated with input fields -->
            </div>

            <button onclick="calculateDetourRoutes()" style="width:100%; padding:10px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-bottom:10px;">Calculate Detour Routes</button>

            <div id="detourRoutesSection" style="display:none; margin-top:10px;">
                <!-- Will be populated with detour route tables -->
            </div>
        </div>
    </details>

    <details class="gc-collapsible" id="gcMaxDelaySection">
        <summary>7. Estimated Maximum Pedestrian Delay (Optional)</summary>
        <div class="card">
            <p style="font-size:0.85em; color:#666; margin-bottom:12px;">
                Configure pedestrian delay parameters for your specific location.
            </p>
            
            <div style="background: #f0f8f7; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #1f5e63;">
                <h4 style="margin-top:0; color:#1f5e63;">Pedestrian Delay Inputs</h4>
                <div class="params-grid">
                    <div><label>Location Name:</label><input type="text" id="ped_location" placeholder="e.g., Surf Parade, Broadbeach" style="width:100%; padding:6px;"></div>
                    <div><label>Existing Distance (m):</label><input type="number" id="ped_existing_dist" value="60" style="width:100%; padding:6px;"></div>
                    <div><label>Detoured Distance (m):</label><input type="number" id="ped_detoured_dist" value="150" style="width:100%; padding:6px;"></div>
                    <div><label>Controlled Crossings:</label><input type="number" id="ped_controlled_cross" value="2" min="0" style="width:100%; padding:6px;"></div>
                    <div><label>Uncontrolled Crossings:</label><input type="number" id="ped_uncontrolled_cross" value="0" min="0" style="width:100%; padding:6px;"></div>
                </div>
                <button onclick="calculateMaxPedestrianDelay()" style="width:100%; margin-top:10px; padding:10px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Calculate Pedestrian Delay</button>
            </div>
                    <div id="maxPedestrianDelaySection" style="display:none;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.85em; margin-top:10px;">
                            <thead>
                                <tr style="background:#f4f6f8; font-weight:bold;">
                                    <th style="padding:8px; border:1px solid #ddd;"></th>
                                    <th style="padding:8px; border:1px solid #ddd; text-align:center;" colspan="2">Distance (m)</th>
                                    <th style="padding:8px; border:1px solid #ddd; text-align:center;">No. of controlled Crossings</th>
                                    <th style="padding:8px; border:1px solid #ddd; text-align:center;">No. of uncontrolled Crossings</th>
                                    <th style="padding:8px; border:1px solid #ddd; text-align:center;" colspan="2">Time (s)</th>
                                    <th style="padding:8px; border:1px solid #ddd; text-align:center;">Added Delay (s)</th>
                                    <th style="padding:8px; border:1px solid #ddd; text-align:center;">Added Delay (mins)</th>
                                </tr>
                                <tr style="background:#e8eef3; font-size:0.8em;">
                                    <th style="padding:6px; border:1px solid #ddd;"></th>
                                    <th style="padding:6px; border:1px solid #ddd; text-align:center;">Existing Route</th>
                                    <th style="padding:6px; border:1px solid #ddd; text-align:center;">Detoured Route</th>
                                    <th style="padding:6px; border:1px solid #ddd;"></th>
                                    <th style="padding:6px; border:1px solid #ddd;"></th>
                                    <th style="padding:6px; border:1px solid #ddd; text-align:center;">Existing Route</th>
                                    <th style="padding:6px; border:1px solid #ddd; text-align:center;">Detoured Route</th>
                                    <th style="padding:6px; border:1px solid #ddd;"></th>
                                    <th style="padding:6px; border:1px solid #ddd;"></th>
                                </tr>
                            </thead>
                            <tbody id="max_ped_delay_tbody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
        </div>
    </details>

    <div class="card">
        <h3>8. Export & Printing</h3>
        <p style="font-size:0.85em; color:#666; margin: 0 0 10px 0;">Print the current Gold Coast TIA analysis, tables, and results.</p>
        <button style="width: 100%; background: #1f5e63; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;" onclick="window.print()">üñ®Ô∏è Print Report</button>
        <button style="width: 100%; margin-top: 8px; background: #d36b2c; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;" onclick="sendTIADataToCalc()">üìä View Full Calculations ‚Üí</button>
    </div>
    </div>

    <!-- Custom TIA Tab -->
    <div id="customTIA" class="tab-content">
        <div class="grid">
            <div class="stack">
                <div class="card">
                    <h3>Custom TIA - Road Not in Database</h3>
                    
                    <div class="year-calc-info">
                        <strong>Project Name:</strong>
                        <input type="text" id="customTiaProject" placeholder="Enter road/location name" style="width:100%; padding: 8px; margin-top:5px;">
                    </div>

                    <div style="background: #f0f8f7; padding: 12px; border-radius: 6px; margin-bottom: 20px; margin-top: 15px; border-left: 4px solid #1f5e63;">
                        <p style="margin: 0; font-size: 0.9em;"><strong>Reference Site (Nearest):</strong></p>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;" id="customNearestSiteRef">Loading...</p>
                    </div>

                    <div class="option-section">
                        <div class="option-title">Method 1: Trip Generation from Households</div>
                        <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                            Estimate AADT from residential units based on development context
                        </p>
                        <div class="option-inputs">
                            <div>
                                <label style="margin-bottom: 3px;">Development Context</label>
                                <select id="customDevContext" onchange="updateCustomComparison()">
                                    <option value="10.7">Metropolitan (Sydney/High Growth)</option>
                                    <option value="7.4" selected>Regional / QLD (Standard)</option>
                                    <option value="2.4">High Density Apartment</option>
                                </select>
                            </div>
                            <div>
                                <label style="margin-bottom: 3px;">Number of Dwellings (Units):</label>
                                <input type="number" id="customDwellings" value="50" min="1" oninput="updateCustomComparison()">
                            </div>
                            <div>
                                <label style="margin-bottom: 3px;">Road Assignment Factor (%):</label>
                                <input type="number" id="customRoadAssign" value="100" min="0" max="100" step="5" oninput="updateCustomComparison()">
                            </div>
                            <div style="background: #e8f4f2; padding: 10px; border-radius: 4px;">
                                <strong style="color: #1f5e63;">Trip Generation AADT:</strong> <span id="customTripGenResult">0</span> vph
                            </div>
                        </div>
                    </div>

                    <div class="option-section">
                        <div class="option-title">Method 2: Percentage of Reference Site</div>
                        <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                            Use a percentage of the nearest site's traffic volume
                        </p>
                        <div class="option-inputs">
                            <div>
                                <label style="margin-bottom: 3px;">Apply Percentage of Reference (%):</label>
                                <input type="number" id="customPercentRef" value="50" min="0" max="100" step="5" oninput="updateCustomComparison()">
                            </div>
                            <div style="background: #e8f4f2; padding: 10px; border-radius: 4px;">
                                <strong style="color: #1f5e63;">Percentage-Based AADT:</strong> <span id="customPercentRefResult">0</span> vph
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #fffbf0; border: 2px solid #d36b2c; border-radius: 6px;">
                        <p style="font-size: 0.9em; margin: 0 0 10px 0;">
                            <strong style="color: #1f5e63;">Selected Volume (Greater of Both Methods):</strong>
                        </p>
                        <div id="customGreaterVolumeDisplay" style="font-size: 1.15em; color: #d36b2c;">
                            0 vph
                        </div>
                    </div>

                    <button onclick="applyCustomTIAToGoldCoast()" style="margin-top:20px; background-color:#28a745; padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white;">Continue to TIA Calculation</button>
                    <button style="margin-top:8px; width:100%; background: #1f5e63; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;" onclick="sendCustomTIADataToCalc()">üìä View Full Calculations ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <div id="Ipswich" class="tab-content gc-tab">
        <div class="card">
            <h3>1. Site Selection & Parameters</h3>
            <div class="gc-site-card">
                <div class="card">
                    <h4 style="margin-top:0; color: #1f5e63;">Select Ipswich Site</h4>
                    <div class="control-group">
                        <label>üîç Search Site:</label>
                        <input type="text" id="ipswichSearch" placeholder="Search road name..." onkeyup="filterIpswichList()">
                        <select id="ipswichSiteSelect" size="4" onchange="selectIpswichSite(this.value)" style="font-size:0.9em; padding:8px;">
                            <option>Loading sites...</option>
                        </select>
                        <div id="ipswichCalcArea" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
                            <h4 style="margin:0 0 10px 0; color:#1f5e63;">üìç <span id="ipswichSelectedName" style="color:#d35400;">-</span></h4>
                            <p style="font-size:0.9em; color:#666; margin: 5px 0 15px 0;">
                                <strong>Coordinates:</strong> <span id="ipswichCoordinates">-</span><br>
                                üìç <a id="ipswichMapLink" href="#" target="_blank" style="color:#0056b3; text-decoration:none;">View on Google Maps</a>
                            </p>

                            <h4 style="margin:15px 0 10px 0; color: #1f5e63;">TIA Parameters</h4>
                            <div class="params-grid">
                                <div><label>Base AADT (<span id="ipswichBaseYear">2022</span>):</label><input type="number" id="ipswichInputAADT" onchange="updateIpswichAnalysis()"></div>
                                <div><label>Target Year:</label><input type="number" id="ipswichTargetYear" value="2026" onchange="updateIpswichAnalysis()"></div>
                                <div><label>Growth Rate (%):</label><input type="number" id="ipswichInputGrowth" step="0.1" value="2.5" onchange="updateIpswichAnalysis()"></div>
                                <div><label>CV (%):</label><input type="number" id="ipswichInputHV" step="0.1" value="9.6" onchange="updateIpswichAnalysis()"></div>
                            </div>

                            <div class="control-group" style="margin-top:15px;">
                                <label>Analysis Road Adjustment:</label>
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="ipswichAnalysisRoad" placeholder="Same as count loc" style="flex:2;" onchange="updateIpswichAnalysis()">
                                    <input type="number" id="ipswichAnalysisPct" value="100" placeholder="%" style="width:70px; padding:8px;" onchange="updateIpswichAnalysis()">
                                    <span style="line-height:35px;">%</span>
                                </div>
                                <small style="color:#666; display:block; margin-top:5px;">Enter % if analyzing a different road (e.g., 25%)</small>
                            </div>

                            <div class="control-group" style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
                                <label>Design Capacity (auto-calculated):</label>
                                <input type="number" id="ipswichCapacity" value="500" readonly
                                       style="background-color: #f0f0f0; cursor: not-allowed; padding:8px; font-weight:bold;">
                                <small style="color:#666; display:block; margin-top:5px;">Formula: MAX(ROUNDUP(0.15 √ó Daily_Limit / 2, 0), 500)</small>
                            </div>

                            <button onclick="updateIpswichAnalysis(); return false;" style="margin-top:15px; width:100%; background:#1f5e63; color:white; padding:12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:1em; position:relative; z-index:10; transition:all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2);" onmouseover="this.style.background='#28a745'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';" onmouseout="this.style.background='#1f5e63'; this.style.transform='none'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)';">üöÄ Calculate Analysis</button>
                        </div>
                    </div>
                </div>

                <div id="ipswichMapSection" class="card">
                    <h4 style="margin-top:0; color: #1f5e63;">Site Location (Ipswich)</h4>
                    <p style="font-size:0.85em; color:#555; margin: 0 0 8px 0;">Ipswich GeoJSON loaded from GitHub.</p>
                    <div id="ipswichMap" style="height: 400px; width: 100%; border: 2px solid #0056b3; border-radius:4px;"></div>
                    <p style="font-size:0.85em; margin-top:8px; color: #666;">
                        üí° <strong>Tip:</strong> Click any marker on the map to select a site OR search the list above
                    </p>
                </div>
            </div>
        </div>

        <details class="gc-collapsible" id="ipswichResultsSection">
            <summary>2. Ipswich Analysis Results</summary>
            <div class="card">
                <h4 style="margin-top:0; color: #1f5e63;">Peak Hour Analysis</h4>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Projected AADT</td><td id="ipswichResAADT">-</td><td>-</td></tr>
                        <tr><td>Peak Hourly Vol (Design)</td><td id="ipswichResPeakFlow">-</td><td>80th Highest</td></tr>
                        <tr><td>Volume / Capacity (VCR)</td><td id="ipswichResVCR">-</td><td id="ipswichResLOS">-</td></tr>
                    </tbody>
                </table>
            </div>
        </details>

        <details class="gc-collapsible" id="ipswichQueueSection">
            <summary>3. Directional Queue Length Estimation</summary>
            <div class="card">
                <p style="font-size:0.85em; color:#666; margin-bottom:12px;">
                    Includes 80th highest hour and off-peak traffic (45% of remaining volume), with CV-based queue lengths.
                </p>
                <div id="ipswichQueueContent" style="display:flex; flex-direction:column; gap:12px;">
                    <div style="font-size:0.85em; color:#777;">Select a site and calculate to view directional queue tables.</div>
                </div>
            </div>
        </details>

        <details class="gc-collapsible" id="ipswichImpactSection">
            <summary>4. Traffic Impact Analysis (VCR)</summary>
            <div class="card">
                <div id="ipswichImpactContent" style="display:none; margin-top:10px;">
                </div>
                <div style="display:block; font-size:0.85em; color:#777;" id="ipswichImpactPlaceholder">
                    Select a site and calculate to view traffic impact analysis.
                </div>
            </div>
        </details>
    </div>

<div id="Logan" class="tab-content gc-tab">
    <div class="card">
        <h3>1. Site Selection & Parameters</h3>
        <div class="gc-site-card">
            <div class="card">
                <h4 style="margin-top:0; color: #1f5e63;">Select Logan Site</h4>
                <div class="control-group">
                    <label>üîç Search Site:</label>
                    <input type="text" id="loganSearch" placeholder="Search road name..." onkeyup="filterLoganList()">
                    <select id="loganSiteSelect" size="4" onchange="selectLoganSite(this.value)" style="font-size:0.9em; padding:8px;">
                        <option>Loading sites...</option>
                    </select>
                    <div id="loganCalcArea" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
                        <h4 style="margin:0 0 10px 0; color:#1f5e63;">üìç <span id="loganSelectedName" style="color:#27ae60;">-</span></h4>
                        <p style="font-size:0.9em; color:#666; margin: 5px 0 15px 0;">
                            <strong>Coordinates:</strong> <span id="loganCoordinates">-</span><br>
                            üìç <a id="loganMapLink" href="#" target="_blank" style="color:#0056b3; text-decoration:none;">View on Google Maps</a>
                        </p>

                        <h4 style="margin:15px 0 10px 0; color: #1f5e63;">TIA Parameters</h4>
                        <div class="params-grid">
                            <div><label>Base AADT (<span id="loganBaseYear">2022</span>):</label><input type="number" id="loganInputAADT" onchange="updateLoganAnalysis()"></div>
                            <div><label>Target Year:</label><input type="number" id="loganTargetYear" value="2026" onchange="updateLoganAnalysis()"></div>
                            <div><label>Growth Rate (%):</label><input type="number" id="loganInputGrowth" step="0.1" value="2.5" onchange="updateLoganAnalysis()"></div>
                            <div><label>CV (%):</label><input type="number" id="loganInputHV" step="0.1" value="20.4" onchange="updateLoganAnalysis()"></div>
                        </div>

                        <div class="control-group" style="margin-top:15px;">
                            <label>Analysis Road Adjustment:</label>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="loganAnalysisRoad" placeholder="Same as count loc" style="flex:2;" onchange="updateLoganAnalysis()">
                                <input type="number" id="loganAnalysisPct" value="100" placeholder="%" style="width:70px; padding:8px;" onchange="updateLoganAnalysis()">
                                <span style="line-height:35px;">%</span>
                            </div>
                            <small style="color:#666; display:block; margin-top:5px;">Enter % if analyzing a different road (e.g., 25%)</small>
                        </div>

                        <div class="control-group" style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
                            <label>Design Capacity (auto-calculated):</label>
                            <input type="number" id="loganCapacity" value="500" readonly
                                   style="background-color: #f0f0f0; cursor: not-allowed; padding:8px; font-weight:bold;">
                            <small style="color:#666; display:block; margin-top:5px;">Formula: MAX(ROUNDUP(0.15 √ó Daily_Limit / 2, 0), 500)</small>
                        </div>

                        <button onclick="updateLoganAnalysis(); return false;" style="margin-top:15px; width:100%; background:#1f5e63; color:white; padding:12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:1em; position:relative; z-index:10; transition:all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2);" onmouseover="this.style.background='#28a745'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';" onmouseout="this.style.background='#1f5e63'; this.style.transform='none'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)';">üöÄ Calculate Analysis</button>
                    </div>
                </div>
            </div>

            <div id="loganMapSection" class="card">
                <h4 style="margin-top:0; color: #1f5e63;">Site Location (Logan)</h4>
                <p style="font-size:0.85em; color:#555; margin: 0 0 8px 0;">Logan GeoJSON loaded from GitHub.</p>
                <div id="loganMap" style="height: 400px; width: 100%; border: 2px solid #0056b3; border-radius:4px;"></div>
                <p style="font-size:0.85em; margin-top:8px; color: #666;">
                    üí° <strong>Tip:</strong> Click any marker on the map to select a site OR search the list above
                </p>
            </div>
        </div>
    </div>

    <details class="gc-collapsible" id="loganResultsSection">
        <summary>2. Logan Analysis Results</summary>
        <div class="card">
            <h4 style="margin-top:0; color: #1f5e63;">Peak Hour Analysis</h4>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Projected AADT</td><td id="loganResAADT">-</td><td>-</td></tr>
                    <tr><td>Peak Hourly Vol (Design)</td><td id="loganResPeakFlow">-</td><td>80th Highest</td></tr>
                    <tr><td>Volume / Capacity (VCR)</td><td id="loganResVCR">-</td><td id="loganResLOS">-</td></tr>
                </tbody>
            </table>
        </div>
    </details>

    <details class="gc-collapsible" id="loganQueueSection">
        <summary>3. Directional Queue Length Estimation</summary>
        <div class="card">
            <p style="font-size:0.85em; color:#666; margin-bottom:12px;">
                Includes 80th highest hour and off-peak traffic (45% of remaining volume), with CV-based queue lengths.
            </p>
            <div id="loganQueueContent" style="display:flex; flex-direction:column; gap:12px;">
                <div style="font-size:0.85em; color:#777;">Select a site and calculate to view directional queue tables.</div>
            </div>
        </div>
    </details>

    <details class="gc-collapsible" id="loganImpactSection">
        <summary>4. Traffic Impact Analysis (VCR)</summary>
        <div class="card">
            <div id="loganImpactContent" style="display:none; margin-top:10px;"></div>
            <div style="display:block; font-size:0.85em; color:#777;" id="loganImpactPlaceholder">
                Select a site and calculate to view traffic impact analysis.
            </div>
        </div>
    </details>
</div>

<div id="tab-toowoomba" class="tab-content gc-tab">
    <div class="card">
        <h3>1. Site Selection & Parameters</h3>
        <div class="gc-site-card">
            <div class="card">
                <h4 style="margin-top:0; color: #1f5e63;">Select Toowoomba Site</h4>
                <div class="control-group">
                    <label>üîç Search Site:</label>
                    <input type="text" id="toowoombaSearch" placeholder="Search road name..." onkeyup="filterToowoombaList()">
                    <select id="toowoombaSiteSelect" size="4" onchange="selectToowoombaSite(this.value)" style="font-size:0.9em; padding:8px;">
                        <option>Loading sites...</option>
                    </select>
                    <div id="toowoombaCalcArea" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
                        <h4 style="margin:0 0 10px 0; color:#1f5e63;">üìç <span id="toowoombaSelectedName" style="color:#27ae60;">-</span></h4>
                        <p style="font-size:0.9em; color:#666; margin: 5px 0 15px 0;">
                            <strong>Coordinates:</strong> <span id="toowoombaCoordinates">-</span><br>
                            üìç <a id="toowoombaMapLink" href="#" target="_blank" style="color:#0056b3; text-decoration:none;">View on Google Maps</a>
                        </p>

                        <h4 style="margin:15px 0 10px 0; color: #1f5e63;">TIA Parameters</h4>
                        <div class="params-grid">
                            <div><label>Base AADT (<span id="toowoombaBaseYear">2022</span>):</label><input type="number" id="toowoombaInputAADT" onchange="updateToowoombaAnalysis()"></div>
                            <div><label>Target Year:</label><input type="number" id="toowoombaTargetYear" value="2026" onchange="updateToowoombaAnalysis()"></div>
                            <div><label>Growth Rate (%):</label><input type="number" id="toowoombaInputGrowth" step="0.1" value="2.5" onchange="updateToowoombaAnalysis()"></div>
                            <div><label>CV (%):</label><input type="number" id="toowoombaInputHV" step="0.1" value="13.0" title="Commercial Vehicle Percentage" onchange="updateToowoombaAnalysis()"></div>
                        </div>

                        <div class="control-group" style="margin-top:15px;">
                            <label>Analysis Road Adjustment:</label>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="toowoombaAnalysisRoad" placeholder="Same as count loc" style="flex:2;" onchange="updateToowoombaAnalysis()">
                                <input type="number" id="toowoombaAnalysisPct" value="100" placeholder="%" style="width:70px; padding:8px;" onchange="updateToowoombaAnalysis()">
                                <span style="line-height:35px;">%</span>
                            </div>
                            <small style="color:#666; display:block; margin-top:5px;">Enter % if analyzing a different road (e.g., 25%)</small>
                        </div>

                        <div class="control-group" style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
                            <label>Design Capacity (auto-calculated):</label>
                            <input type="number" id="toowoombaCapacity" value="500" readonly 
                                   style="background-color: #f0f0f0; cursor: not-allowed; padding:8px; font-weight:bold;">
                            <small style="color:#666; display:block; margin-top:5px;">Formula: MAX(ROUNDUP(0.15 √ó Daily_Limit / 2, 0), 500)</small>
                        </div>

                        <button onclick="updateToowoombaAnalysis(); return false;" style="margin-top:15px; width:100%; background:#1f5e63; color:white; padding:12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:1em; position:relative; z-index:10; transition:all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2);" onmouseover="this.style.background='#28a745'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';" onmouseout="this.style.background='#1f5e63'; this.style.transform='none'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)';">üöÄ Calculate Analysis</button>
                    </div>
                </div>
            </div>

            <div id="toowoombaMapSection" class="card">
                <h4 style="margin-top:0; color: #1f5e63;">Site Location (Toowoomba)</h4>
                <p style="font-size:0.85em; color:#555; margin: 0 0 8px 0;">Toowoomba GeoJSON loaded from GitHub.</p>
                <div id="toowoombaMap" style="height: 400px; width: 100%; border: 2px solid #0056b3; border-radius:4px;"></div>
                <p style="font-size:0.85em; margin-top:8px; color: #666;">
                    üí° <strong>Tip:</strong> Click any marker on the map to select a site OR search the list above
                </p>
            </div>
        </div>
    </div>

    <details class="gc-collapsible" id="toowoombaResultsSection">
        <summary>2. Toowoomba Analysis Results</summary>
        <div class="card">
            <h4 style="margin-top:0; color: #1f5e63;">Peak Hour Analysis</h4>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Projected AADT</td><td id="toowoombaResAADT">-</td><td>-</td></tr>
                    <tr><td>Peak Hourly Vol (Design)</td><td id="toowoombaResPeakFlow">-</td><td>80th Highest</td></tr>
                    <tr><td>Volume / Capacity (VCR)</td><td id="toowoombaResVCR">-</td><td id="toowoombaResLOS">-</td></tr>
                </tbody>
            </table>
        </div>
    </details>

    <details class="gc-collapsible" id="toowoombaQueueSection">
        <summary>3. Directional Queue Length Estimation</summary>
        <div class="card">
            <p style="font-size:0.85em; color:#666; margin-bottom:12px;">
                Includes 80th highest hour and off-peak traffic (45% of remaining volume), with CV-based queue lengths.
            </p>
            <div id="toowoombaQueueContent" style="display:flex; flex-direction:column; gap:12px;">
                <div style="font-size:0.85em; color:#777;">Select a site and calculate to view directional queue tables.</div>
            </div>
        </div>
    </details>

    <details class="gc-collapsible" id="toowoombaImpactSection">
        <summary>4. Traffic Impact Analysis (VCR)</summary>
        <div class="card">
            <div id="toowoombaImpactContent" style="display:none; margin-top:10px;">
                <!-- Will be populated by JavaScript -->
            </div>
            <div style="display:block; font-size:0.85em; color:#777;" id="toowoombaImpactPlaceholder">
                Select a site and calculate to view traffic impact analysis.
            </div>
        </div>
    </details>
</div>

<div id="tab-qc" class="tab-content">
    <!-- Results Container -->
    <div id="calculation-results-container" style="margin-bottom: 20px;">
        <div style="padding: 20px; text-align: center; color: #999;">
            <p>Select a site from any data source and click "Calculate" to view results</p>
        </div>
    </div>

    <div class="card">
        <h3>üìã Questions & Input Fields from Macro</h3>
        <div style="padding: 15px; background: #f9f9f9; border-radius: 8px;">
            <h4 style="color: var(--brand-2); margin-top: 0;">Primary Conditions</h4>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>PWS (Pedestrian Work Site)</strong> - Yes/No input field</li>
                <li><strong>DTCA (Direction Traffic Count Applicable)</strong> - Yes/No input field to determine if direction-specific VADT is used</li>
                <li><strong>DHVPA (Direction HV % Applicable)</strong> - Yes/No input field to use direction-specific heavy vehicle percentages</li>
                <li><strong>DRTPA (Direction RT % Applicable)</strong> - Yes/No input field to use direction-specific right turn percentages</li>
                <li><strong>RTR (Right Turn Restriction)</strong> - Yes/No input field affecting minimum queue thresholds</li>
            </ul>

            <h4 style="color: var(--brand-2);">Required Traffic Data</h4>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>VADT (Vehicle AADT)</strong> - Overall daily traffic count</li>
                <li><strong>D1_VADT, D2_VADT</strong> - Direction 1 and Direction 2 specific AADT values (if DTCA = Yes)</li>
                <li><strong>D1_Lanes, D2_Lanes</strong> - Number of lanes in each direction</li>
                <li><strong>HVP (Heavy Vehicle %)</strong> - Overall percentage of heavy vehicles</li>
                <li><strong>D1_HVP, D2_HVP</strong> - Direction-specific heavy vehicle percentages (if DHVPA = Yes)</li>
                <li><strong>RTP (Right Turn %)</strong> - Overall percentage of right-turning vehicles</li>
                <li><strong>D1_RTP, D2_RTP</strong> - Direction-specific right turn percentages (if DRTPA = Yes)</li>
            </ul>

            <h4 style="color: var(--brand-2);">Risk Assessment Fields</h4>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>Likelihood*</strong> - Risk likelihood scale (paired with direction/risk suffix)</li>
                <li><strong>Consequence*</strong> - Risk consequence scale (paired with direction/risk suffix)</li>
                <li><strong>I_Risk*</strong> - Initial risk rating (calculated from Likelihood √ó Consequence)</li>
                <li><strong>R_Likelihood*, R_Consequence*, R_Risk*</strong> - Residual risk assessment fields</li>
            </ul>
        </div>
    </div>

    <div class="card">
        <h3>üî¢ Calculations & Formulas</h3>
        <div style="padding: 15px; background: #f0f7ff; border-radius: 8px;">
            <h4 style="color: var(--brand-2); margin-top: 0;">1. Peak Hour Traffic (Light Vehicles)</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> D_VADT √ó 0.12 √ó 0.8 ‚àí Peak_HV ‚àí Peak_RT<br>
                <small><em>Returns vehicles in peak hour for light vehicle direction</em></small>
            </div>

            <h4 style="color: var(--brand-2);">2. Peak Hour Traffic (Heavy Vehicles)</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> VADT √ó 0.12 √ó (HV% √∑ 100)<br>
                <strong>Or (Direction-specific):</strong> D_VADT √ó 0.12 √ó (D_HVP% √∑ 100)<br>
                <small><em>Returns peak hour heavy vehicle volume</em></small>
            </div>

            <h4 style="color: var(--brand-2);">3. Peak Hour Traffic (Right Turns)</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> VADT √ó 0.12 √ó (RTP% √∑ 100)<br>
                <strong>Or (Direction-specific):</strong> D_VADT √ó 0.12 √ó (D_RTP% √∑ 100)<br>
                <small><em>Returns peak hour right-turn volume</em></small>
            </div>

            <h4 style="color: var(--brand-2);">4. Off-Peak Traffic</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> Peak_Traffic √ó 0.42<br>
                <strong>Or:</strong> Peak_Traffic √ó (42 √∑ 100)<br>
                <small><em>Off-peak hour volume is 42% of peak hour volume</em></small>
            </div>

            <h4 style="color: var(--brand-2);">5. Peak Traffic Per Lane</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> Peak_Traffic √∑ Number_of_Lanes<br>
                <small><em>Distributes total peak traffic across available lanes</em></small>
            </div>

            <h4 style="color: var(--brand-2);">6. 5-Minute Peak Traffic</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> Per_Lane_Traffic √ó (5 √∑ 60)<br>
                <small><em>Converts hourly per-lane traffic to 5-minute volume slice</em></small>
            </div>

            <h4 style="color: var(--brand-2);">7. 2-Minute Queue Length</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> (LV_5M √ó 2.4) + (HV_5M √ó 8) + (RT_5M √ó 25.2)<br>
                <strong>Minimum thresholds:</strong><br>
                <ul style="margin: 5px 0; padding-left: 15px;">
                    <li>IF RTR = Yes: MIN = 89 vehicles</li>
                    <li>IF RTR = No: MIN = 26 vehicles</li>
                </ul>
                <small><em>Estimates 2-minute queue in physical queue length and vehicles</em></small>
            </div>

            <h4 style="color: var(--brand-2);">8. 5-Minute Queue Length</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> (LV_5M √ó 6) + (HV_5M √ó 20) + (RT_5M √ó 63)<br>
                <strong>Minimum thresholds:</strong><br>
                <ul style="margin: 5px 0; padding-left: 15px;">
                    <li>IF RTR = Yes: MIN = 89 vehicles</li>
                    <li>IF RTR = No: MIN = 26 vehicles</li>
                </ul>
                <small><em>Estimates 5-minute queue in physical queue length and vehicles</em></small>
            </div>

            <h4 style="color: var(--brand-2);">9. Design Volume</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> VADT √ó 0.12 √∑ (D1_Lanes + D2_Lanes)<br>
                <strong>Minimum:</strong> 500 vehicles/hour<br>
                <strong>Rounded up to nearest integer</strong><br>
                <small><em>Capacity-based design volume for the road section</em></small>
            </div>

            <h4 style="color: var(--brand-2);">10. Volume/Capacity Ratio (VCR)</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Formula:</strong> (Peak_LV + Peak_HV + Peak_RT) √∑ Design_Volume<br>
                <strong>VCR Categories:</strong><br>
                <ul style="margin: 5px 0; padding-left: 15px;">
                    <li>VCR < 0.6: Green (Good condition)</li>
                    <li>0.6 ‚â§ VCR < 0.8: Blue (Acceptable)</li>
                    <li>0.8 ‚â§ VCR < 1.0: Yellow (Approaching capacity)</li>
                    <li>VCR ‚â• 1.0: Red (Over capacity)</li>
                </ul>
                <small><em>Indicates how efficiently the road section operates</em></small>
            </div>

            <h4 style="color: var(--brand-2);">11. VCR - Single Lane Closure (SLC)</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Conditions:</strong>
                <ul style="margin: 5px 0; padding-left: 15px;">
                    <li>IF Lanes = 2: Apply weighted calculation for 2-lane capacity</li>
                    <li>IF Lanes > 2: Apply weighted calculation for multi-lane capacity</li>
                    <li>IF Lanes < 2: Result = "N/A" (not applicable for single-lane roads)</li>
                </ul>
                <small><em>VCR under emergency single-lane closure scenario</em></small>
            </div>

            <h4 style="color: var(--brand-2);">12. VCR - Single Lane Reversible Flow (SLRF)</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>Conditions:</strong>
                <ul style="margin: 5px 0; padding-left: 15px;">
                    <li>IF D1_Lanes = 1 AND D2_Lanes = 1: Calculate reversal capacity adjustment</li>
                    <li>Otherwise: Result = "N/A" (not applicable for roads > 1 lane per direction)</li>
                </ul>
                <small><em>VCR when one direction becomes reversible (both directions use one lane)</em></small>
            </div>

            <h4 style="color: var(--brand-2);">13. Rounding & Number Handling</h4>
            <div style="background: white; padding: 10px; border-left: 3px solid var(--brand); margin: 10px 0;">
                <strong>NumberRoundUp Function:</strong> Int((number √ó multiplier) + 0.999999999999999) √∑ multiplier<br>
                <strong>CeilingVBA Function:</strong> Rounds up to nearest significance value (e.g., 5 for queue data)<br>
                <strong>Validation:</strong> IsNumeric() checks before calculations to prevent errors<br>
                <small><em>All results rounded appropriately for queue and traffic reporting</em></small>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>üìä Data Constants & Multipliers</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr style="background: var(--brand); color: white;">
                    <th style="padding: 8px; text-align: left;">Parameter</th>
                    <th style="padding: 8px; text-align: center;">Value/Factor</th>
                    <th style="padding: 8px; text-align: left;">Description</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">Peak Hour Factor</td>
                    <td style="padding: 8px; text-align: center;">0.12 (12%)</td>
                    <td style="padding: 8px;">Peak hour is 12% of daily traffic</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">Direction Split (LV)</td>
                    <td style="padding: 8px; text-align: center;">0.8 (80%)</td>
                    <td style="padding: 8px;">Light vehicle direction proportion</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">Off-Peak Factor</td>
                    <td style="padding: 8px; text-align: center;">0.42 (42%)</td>
                    <td style="padding: 8px;">Off-peak traffic = 42% of peak</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">2-Min LV Queue (vpm)</td>
                    <td style="padding: 8px; text-align: center;">2.4</td>
                    <td style="padding: 8px;">Light vehicle queue length factor</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">2-Min HV Queue (vpm)</td>
                    <td style="padding: 8px; text-align: center;">8.0</td>
                    <td style="padding: 8px;">Heavy vehicle queue length factor</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">2-Min RT Queue (vpm)</td>
                    <td style="padding: 8px; text-align: center;">25.2</td>
                    <td style="padding: 8px;">Right turn queue length factor</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">5-Min LV Queue (vpm)</td>
                    <td style="padding: 8px; text-align: center;">6.0</td>
                    <td style="padding: 8px;">Light vehicle 5-min queue factor</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">5-Min HV Queue (vpm)</td>
                    <td style="padding: 8px; text-align: center;">20.0</td>
                    <td style="padding: 8px;">Heavy vehicle 5-min queue factor</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">5-Min RT Queue (vpm)</td>
                    <td style="padding: 8px; text-align: center;">63.0</td>
                    <td style="padding: 8px;">Right turn 5-min queue factor</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">Design Volume Factor</td>
                    <td style="padding: 8px; text-align: center;">0.12</td>
                    <td style="padding: 8px;">Daily to design hour conversion</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Minimum Design Volume</td>
                    <td style="padding: 8px; text-align: center;">500 vph</td>
                    <td style="padding: 8px;">Minimum road capacity threshold</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <h3>üîÑ Implementation Notes</h3>
        <div style="padding: 15px; background: #f0f8f0; border-radius: 8px;">
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>Direction Parameters:</strong> When DTCA = "Yes", uses D1/D2 specific values; when "No", calculates from overall VADT</li>
                <li><strong>HV & RT Distribution:</strong> Applied using direction-specific percentages if DHVPA/DRTPA = "Yes"</li>
                <li><strong>Queue Calculations:</strong> Based on 5-minute traffic slices per lane with RTR affecting minimum thresholds</li>
                <li><strong>VCR Color Coding:</strong> Used for quick visual assessment of road capacity status</li>
                <li><strong>Rounding:</strong> All traffic counts rounded up to nearest whole number; queues rounded up to nearest 5</li>
                <li><strong>Risk Matrix:</strong> Likelihood √ó Consequence produces Initial Risk; Residual Risk calculated separately for after-mitigation assessment</li>
            </ul>
        </div>
    </div>
</div>



<script>
// Meta Data from your CSV
const dowFactors = {
    "Urban arterial 1 (Capital City)": {"Mon": 0.98}, "Urban arterial 1 (Other)": {"Mon": 1.01},
    "Urban arterial 2 (Capital City)": {"Mon": 0.99}, "Urban arterial 2 (Others)": {"Mon": 1},
    "Urban CBD (Capital City)": {"Mon": 1.02}, "Urban industrial (Others)": {"Mon": 0.85},
    "Rural urban fringe": {"Mon": 1.14}, "Rural strategic 1": {"Mon": 1.05},
    "Rural strategic 2": {"Mon": 1.11}, "Rural recreation summer": {"Mon": 1.07}, "Rural recreation winter": {"Mon": 1.15}
};

const partDayFactors = {
    "Urban arterial (Capital City)": {"7-9am": 5.63}, "Urban arterial (Others)": {"7-9am": 7.31},
    "Urban CBD (Capital City)": {"7-9am": 7.86}, "Urban industrial (Others)": {"7-9am": 5.57},
    "Rural urban fringe": {"7-9am": 8.61}, "Rural strategic 1": {"7-9am": 8.4},
    "Rural strategic 2": {"7-9am": 10.2}, "Rural recreation summer": {"7-9am": 16.9}, "Rural recreation winter": {"7-9am": 13.8}
};

// GitHub Configuration
const GITHUB_CONFIG = {
    username: 'crsanju',
    repo: 'Cromton_Traffic_Analysis',
    branch: '828cc3faa7d44bdc483d06def9af6c9f1c409ed5',
    tmrDataFile: 'tmr.geojson',
    goldCoastDataFile: 'goldcoast.geojson'
};

const GITHUB_TMR_URL = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/main/${GITHUB_CONFIG.tmrDataFile}`;
const GITHUB_GOLDCOAST_URL = 'https://raw.githubusercontent.com/crsanju/Cromton_Traffic_Analysis/main/goldcoast.geojson';

// Fetch data from GitHub with timeout
// Robust fetchGitHubData with proper error handling and guaranteed timeout
async function fetchGitHubData(url) {
    const maxAttempts = 3;
    
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        try {
            console.log(`[Attempt ${attempt}/${maxAttempts}] Fetching from: ${url}`);
            updateLoadingProgress(`Fetching data...`, `Attempt ${attempt}`);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            
            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log(`‚úì Successfully loaded data (attempt ${attempt})`);
            return data;
            
        } catch (err) {
            console.warn(`Attempt ${attempt} failed:`, err.message);
            if (attempt === maxAttempts) {
                throw err;
            }
            await new Promise(r => setTimeout(r, 1000 * attempt));
        }
    }
}

// Data getters (updated for GitHub)
window.getGitHubTMRData = async function() {
    return await fetchGitHubData(GITHUB_TMR_URL);
};

window.getGitHubGeoJSON = async function() {
    return await fetchGitHubData(GITHUB_GOLDCOAST_URL);
};

// Hide loading overlay
function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// Update loading progress
function updateLoadingProgress(message, details = '') {
    const progressEl = document.getElementById('loadingProgress');
    const detailsEl = document.getElementById('loadingDetails');
    if (progressEl) progressEl.textContent = message;
    if (detailsEl) detailsEl.textContent = details;
    console.log('Loading:', message, details);
}

// Initialize updateLoadingProgress early
if (typeof window.updateLoadingProgress === 'undefined') {
    window.updateLoadingProgress = updateLoadingProgress;
}

// Show error message
function showError(message) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.innerHTML = `
            <div class="loading-content">
                <h2 style="color: #c00000;">‚ö†Ô∏è Error Loading GitHub Data</h2>
                <p style="margin: 20px 0;">${message}</p>
                <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
                    This may be due to:<br>
                    ‚Ä¢ Network/internet connection issues<br>
                    ‚Ä¢ GitHub being temporarily unavailable<br>
                    ‚Ä¢ Large file size taking too long to load
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="retryLoadData()" style="margin: 0; background-color: #28a745; padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white;">
                        üîÑ Retry
                    </button>
                    <button onclick="checkGitHubConnectivity()" style="margin: 0; background-color: #17a2b8; padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white;">
                        üîó Check Connectivity
                    </button>
                    <button onclick="skipLoadData()" style="margin: 0; background-color: #0056b3; padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white;">
                        ‚è≠Ô∏è Continue Without Data
                    </button>
                </div>
            </div>
        `;
    }
}

    // Retry loading data
    function retryLoadData() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading Traffic Data...</div>
                    <div class="loading-subtext">Retrying GitHub fetch...</div>
                </div>
            `;
        }
        clearTimeout(globalLoadTimeout);
        // Restart the timeout for the retry
        globalLoadTimeout = setTimeout(() => {
            console.error('Global data load timeout exceeded');
            showError('Data loading took too long. Please try "Retry" or "Continue Without Data".');
        }, 45000);
        loadTrafficData();
    }

    // Skip loading data and continue
    function skipLoadData() {
        console.log('Skipping GitHub data load, using application without traffic data');
        clearTimeout(globalLoadTimeout);
        hideLoading();
        // Show notification
        alert('‚ö†Ô∏è Continuing without TMR data.\n\nYou can still use the Gold Coast TIA tab manually by entering AADT values.');
        // Show a notification that the app is working in limited mode
        const container = document.querySelector('.container');
        if (container) {
            const notif = document.createElement('div');
            notif.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 12px; margin-bottom: 20px; color: #856404;';
            notif.innerHTML = '‚ö†Ô∏è <strong>Limited Mode:</strong> GitHub traffic data unavailable. Some features may be limited. You can still use manual input, custom TIA, and calculations.';
            container.insertBefore(notif, container.firstChild);
        }
    }

    // Check GitHub connectivity
    async function checkGitHubConnectivity() {
        console.log('Checking GitHub connectivity...');
        const testUrl = 'https://api.github.com';
        try {
            const response = await fetch(testUrl, { method: 'HEAD' });
            console.log('GitHub API responsive:', response.ok);
            alert('‚úÖ GitHub is reachable. Issue may be with the file URLs.\n\nTMR URL: ' + GITHUB_TMR_URL + '\n\nGold Coast URL: ' + GITHUB_GOLDCOAST_URL);
        } catch (err) {
            console.error('GitHub not reachable:', err);
            alert('‚ùå GitHub is not reachable. Please check your internet connection.');
        }
    }

    function getEmbeddedGeoJSON() {
        return getGitHubGeoJSON();
    }

</script>

<script>
    // ============================================
    // UNIFIED AADT & CALCULATION DATA STORE
    // ============================================
    const roadAnalysisData = {
        source: 'database', // 'database', 'manual', 'calculated'
        roadName: '',
        aadt: 0,
        direction1AADT: 0,
        direction2AADT: 0,
        lanes: 2,
        hvPercent: 15, // Default 15%
        rtPercent: 0,
        year: new Date().getFullYear(),
        growthRate: 2.5,
        targetYear: new Date().getFullYear() + 5,
        rtrApplicable: false // Right Turn Restriction
    };

    // Function to update road data from any source
    function updateRoadData(dataObj) {
        Object.assign(roadAnalysisData, dataObj);
        console.log('Road data updated:', roadAnalysisData);
    }

    // ============================================
    // MASTER CALCULATION ENGINE
    // ============================================
    function performMasterCalculation() {
        const data = roadAnalysisData;
        
        // Validate minimum data
        if (!data.aadt || data.aadt === 0) {
            console.warn('No AADT value provided');
            return null;
        }

        try {
            // 1. PROJECT AADT TO TARGET YEAR
            const yearsToGrow = data.targetYear - data.year;
            const growthFactor = Math.pow(1 + (data.growthRate / 100), yearsToGrow);
            const projectedAADT = data.aadt * growthFactor;

            // 2. CALCULATE DIRECTIONAL SPLIT
            const dir1AADT = data.direction1AADT || (projectedAADT * 0.5);
            const dir2AADT = data.direction2AADT || (projectedAADT * 0.5);

            // 3. PEAK HOUR VOLUME (DHV - Directional Hourly Volume)
            // Formula: AADT √ó 0.12 (12% peak hour factor from macro)
            const peakHourVol = dir1AADT * 0.12;

            // 4. VEHICLE TYPE SPLIT
            const hvDecimal = data.hvPercent / 100;
            const peakHV = peakHourVol * hvDecimal;
            const peakLV = peakHourVol * (1 - hvDecimal);

            // 5. OFF-PEAK VOLUME
            // Formula: Peak √ó 0.42 (42% of peak from macro)
            const offPeakHourVol = peakHourVol * 0.42;
            const offPeakHV = offPeakHourVol * hvDecimal;
            const offPeakLV = offPeakHourVol * (1 - hvDecimal);

            // 6. PER-LANE CALCULATIONS
            const lanesCount = Math.max(data.lanes, 1);
            const peakPerLane = peakHourVol / lanesCount;
            const vol5MinPerLane = peakPerLane / 12; // 5-minute slice

            // 7. RIGHT TURN ADJUSTMENT
            const rtDecimal = (data.rtPercent || 0) / 100;
            const rtVolume = peakHourVol * rtDecimal;

            // 8. DESIGN CAPACITY
            // Formula from macro: MAX(ROUNDUP(0.15 √ó Total_AADT / 2, 0), 500)
            const totalAADT = projectedAADT;
            const designCapacity = Math.max(Math.ceil((0.15 * totalAADT) / 2), 500);

            // 9. VOLUME/CAPACITY RATIO (VCR)
            const vcr = peakHourVol / designCapacity;

            // 10. LEVEL OF SERVICE
            let los, losColor;
            if (vcr < 0.6) { los = 'A'; losColor = '#27ae60'; } // Green
            else if (vcr < 0.8) { los = 'B'; losColor = '#3498db'; } // Blue
            else if (vcr < 0.9) { los = 'C'; losColor = '#f39c12'; } // Orange
            else if (vcr < 1.0) { los = 'D'; losColor = '#e67e22'; } // Dark Orange
            else { los = 'F'; losColor = '#e74c3c'; } // Red

            // 11. QUEUE CALCULATIONS (from macro)
            // Queue factors: 2-min (LV: 2.4, HV: 8, RT: 25.2)
            //                5-min (LV: 6, HV: 20, RT: 63)
            const lv5min = vol5MinPerLane * (1 - hvDecimal);
            const hv5min = vol5MinPerLane * hvDecimal;
            const rt5min = vol5MinPerLane * rtDecimal;

            const queue2min = Math.ceil((lv5min * 2.4) + (hv5min * 8) + (rt5min * 25.2));
            const queue5min = Math.ceil((lv5min * 6) + (hv5min * 20) + (rt5min * 63));

            // Apply minimum thresholds (from macro)
            const minThreshold = data.rtrApplicable ? 89 : 26;
            const queue2minAdjusted = Math.max(queue2min, minThreshold);
            const queue5minAdjusted = Math.max(queue5min, minThreshold);

            // 12. SINGLE LANE CLOSURE (SLC) VCR
            let vcrSLC = null;
            if (lanesCount >= 2) {
                // Assume reduced capacity with one lane closed
                const reducedCapacity = designCapacity * 0.7;
                vcrSLC = peakHourVol / reducedCapacity;
            }

            // 13. SINGLE LANE REVERSIBLE FLOW (SLRF)
            let vcrSLRF = null;
            if (data.direction1AADT && data.direction2AADT && lanesCount === 1) {
                // Both directions share one lane
                const combinedPeak = (data.direction1AADT + data.direction2AADT) * 0.12;
                vcrSLRF = combinedPeak / designCapacity;
            }

            // Return comprehensive results
            return {
                metadata: {
                    roadName: data.roadName || 'Road Analysis',
                    analysisYear: data.targetYear,
                    source: data.source,
                    calculationDate: new Date().toLocaleDateString()
                },
                aadt: {
                    current: Math.round(data.aadt),
                    projected: Math.round(projectedAADT),
                    direction1: Math.round(dir1AADT),
                    direction2: Math.round(dir2AADT),
                    growthRate: data.growthRate,
                    yearsProjected: yearsToGrow
                },
                peakHour: {
                    total: Math.round(peakHourVol),
                    lightVehicles: Math.round(peakLV),
                    heavyVehicles: Math.round(peakHV),
                    rightTurns: Math.round(rtVolume),
                    hvPercent: data.hvPercent
                },
                offPeak: {
                    total: Math.round(offPeakHourVol),
                    lightVehicles: Math.round(offPeakLV),
                    heavyVehicles: Math.round(offPeakHV)
                },
                perLane: {
                    lanes: lanesCount,
                    peakHourly: Math.round(peakPerLane),
                    peak5min: Math.round(vol5MinPerLane)
                },
                capacity: {
                    design: Math.round(designCapacity),
                    vcr: vcr.toFixed(3),
                    vcrSLC: vcrSLC ? vcrSLC.toFixed(3) : 'N/A',
                    vcrSLRF: vcrSLRF ? vcrSLRF.toFixed(3) : 'N/A',
                    los: los,
                    losColor: losColor
                },
                queue: {
                    queue2min: queue2minAdjusted,
                    queue5min: queue5minAdjusted,
                    minThreshold: minThreshold,
                    lv5min: Math.round(lv5min),
                    hv5min: Math.round(hv5min),
                    rt5min: Math.round(rt5min)
                }
            };
        } catch (error) {
            console.error('Calculation error:', error);
            return null;
        }
    }

    // Function to navigate to calculations tab and display results
    function navigateToCalculations(event) {
        const results = performMasterCalculation();
        if (!results) {
            alert('Please ensure all required fields are filled');
            return;
        }
        openTab(event || { target: { className: '' } }, 'tab-qc');
        setTimeout(() => displayCalculationResults(results), 100);
    }

    // Function to display results on the Q&C tab
    function displayCalculationResults(results) {
        if (!results) return;

        const container = document.getElementById('calculation-results-container');
        if (!container) {
            console.warn('Results container not found');
            return;
        }

        const html = `
        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- AADT Section -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #1f5e63;">
                    <h4 style="margin-top: 0; color: #1f5e63;">üìä AADT Analysis</h4>
                    <table style="width: 100%; font-size: 0.9em;">
                        <tr>
                            <td style="padding: 5px 0;"><strong>Current AADT:</strong></td>
                            <td style="text-align: right;"><strong>${results.aadt.current.toLocaleString()}</strong></td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Growth Rate:</td>
                            <td style="text-align: right;">${results.aadt.growthRate}% over ${results.aadt.yearsProjected} years</td>
                        </tr>
                        <tr style="border-top: 1px solid #e1ded8;">
                            <td style="padding: 5px 0;"><strong>Projected ${results.metadata.analysisYear}:</strong></td>
                            <td style="text-align: right;"><strong style="font-size: 1.1em;">${results.aadt.projected.toLocaleString()}</strong></td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Direction 1:</td>
                            <td style="text-align: right;">${results.aadt.direction1.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Direction 2:</td>
                            <td style="text-align: right;">${results.aadt.direction2.toLocaleString()}</td>
                        </tr>
                    </table>
                </div>

                <!-- Peak Hour Section -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #d36b2c;">
                    <h4 style="margin-top: 0; color: #d36b2c;">‚è∞ Peak Hour Volumes</h4>
                    <table style="width: 100%; font-size: 0.9em;">
                        <tr>
                            <td style="padding: 5px 0;"><strong>Total Peak Hour:</strong></td>
                            <td style="text-align: right;"><strong>${results.peakHour.total}</strong> veh/hr</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Light Vehicles (${100 - results.peakHour.hvPercent}%):</td>
                            <td style="text-align: right;">${results.peakHour.lightVehicles}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Heavy Vehicles (${results.peakHour.hvPercent}%):</td>
                            <td style="text-align: right;">${results.peakHour.heavyVehicles}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Right Turns:</td>
                            <td style="text-align: right;">${results.peakHour.rightTurns}</td>
                        </tr>
                        <tr style="border-top: 1px solid #e1ded8;">
                            <td style="padding: 5px 0;"><strong>Off-Peak:</strong></td>
                            <td style="text-align: right;"><strong>${results.offPeak.total}</strong> veh/hr</td>
                        </tr>
                    </table>
                </div>

                <!-- Capacity Section -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #0f2f32;">
                    <h4 style="margin-top: 0; color: #0f2f32;">üöó Capacity & V/C Analysis</h4>
                    <table style="width: 100%; font-size: 0.9em;">
                        <tr>
                            <td style="padding: 5px 0;"><strong>Design Capacity:</strong></td>
                            <td style="text-align: right;"><strong>${results.capacity.design}</strong> veh/hr</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">V/C Ratio:</td>
                            <td style="text-align: right;"><strong>${results.capacity.vcr}</strong></td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">V/C (SLC):</td>
                            <td style="text-align: right;">${results.capacity.vcrSLC}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">V/C (SLRF):</td>
                            <td style="text-align: right;">${results.capacity.vcrSLRF}</td>
                        </tr>
                        <tr style="border-top: 1px solid #e1ded8; background: ${results.capacity.losColor}33;">
                            <td style="padding: 5px 0;"><strong>Level of Service:</strong></td>
                            <td style="text-align: right;"><strong style="font-size: 1.2em; color: ${results.capacity.losColor};">${results.capacity.los}</strong></td>
                        </tr>
                    </table>
                </div>

                <!-- Queue Section -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #5f5f5f;">
                    <h4 style="margin-top: 0; color: #5f5f5f;">üìè Queue Estimates</h4>
                    <table style="width: 100%; font-size: 0.9em;">
                        <tr>
                            <td style="padding: 5px 0;"><strong>2-Minute Queue:</strong></td>
                            <td style="text-align: right;"><strong>${results.queue.queue2min}</strong> m</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">5-Minute Queue:</td>
                            <td style="text-align: right;"><strong>${results.queue.queue5min}</strong> m</td>
                        </tr>
                        <tr style="font-size: 0.85em; color: #666;">
                            <td style="padding: 5px 0;">LV (5min): ${results.queue.lv5min} | HV: ${results.queue.hv5min} | RT: ${results.queue.rt5min}</td>
                            <td style="text-align: right;">Min: ${results.queue.minThreshold}</td>
                        </tr>
                        <tr style="border-top: 1px solid #e1ded8;">
                            <td colspan="2" style="padding: 8px 0; text-align: center; font-size: 0.85em; color: #5f5f5f;">
                                <em>Based on ${results.perLane.lanes} lane(s)</em>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Metadata -->
            <div style="background: white; padding: 12px; border-radius: 8px; border-top: 2px solid #e1ded8; font-size: 0.85em; color: #666; text-align: right;">
                <strong>Source:</strong> ${results.metadata.source} | <strong>Calculated:</strong> ${results.metadata.calculationDate}
            </div>
        </div>
        `;

        container.innerHTML = html;
    }

    let sitesData = {};
    let markerClusterGroup = null;

    // Debounce utility for performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Initialize Dropdown
    // --- TOOWOOMBA MODULE (Updated to match Logan layout) ---

    let toowoombaDataGlobal = null;
    let toowoombaLayerGroup = L.layerGroup();
    let toowoombaMapInstance = null;

    function getToowoombaName(props) {
        return props.Road_Name || props.ROAD_NAME || props.Street || props.STREET || props.Location || props.COUNTER_LOCATION || "Unknown Road";
    }

    function getToowoombaId(props, fallbackId) {
        return props.OBJECTID || props.SiteID || props.Site_ID || props.id || fallbackId || "N/A";
    }

    async function initToowoomba() {
        // 1. Initialize Map
        if (!toowoombaMapInstance) {
            toowoombaMapInstance = L.map('toowoombaMap').setView([-27.5598, 151.9507], 11); // Center on Toowoomba
            addTileLayerWithFallback(
                toowoombaMapInstance,
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                { attribution: '&copy; OpenStreetMap contributors' },
                'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                { attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }
            );
        }

        // 2. Fetch Data using robust retry mechanism
        if (!toowoombaDataGlobal) {
            try {
                console.log('Fetching Toowoomba data with retry mechanism...');
                const toowoombaUrl = 'https://raw.githubusercontent.com/crsanju/Cromton_Traffic_Analysis/refs/heads/main/toowoomba.geojson';
                toowoombaDataGlobal = await fetchGitHubData(toowoombaUrl);
                console.log('‚úì Toowoomba data loaded successfully');
                
                populateToowoombaMap();
                populateToowoombaList();
            } catch (error) {
                console.error("Error loading Toowoomba data:", error);
                // Fallback: show alert but don't block
                console.warn("‚ö†Ô∏è Could not load Toowoomba data. Using fallback.");
                // Continue anyway - user can still use the tab
                toowoombaDataGlobal = { features: [] };
            }
        }
        
        // Resize fix
        setTimeout(() => { toowoombaMapInstance.invalidateSize(); }, 200);
    }

    function populateToowoombaMap() {
        toowoombaLayerGroup.clearLayers();
        
        if (toowoombaDataGlobal && toowoombaDataGlobal.features) {
            toowoombaDataGlobal.features.forEach(feature => {
                const props = feature.properties || {};
                const geom = feature.geometry;

                const name = getToowoombaName(props);
                const id = getToowoombaId(props, feature.id);
                
                // Handle LineString geometry (Toowoomba has road segments, not points)
                if (geom && geom.coordinates) {
                    let lat, lon;
                    if (geom.type === 'Point') {
                        lon = geom.coordinates[0];
                        lat = geom.coordinates[1];
                    } else if (geom.type === 'LineString' && geom.coordinates.length > 0) {
                        // Use midpoint of the line
                        const coords = geom.coordinates;
                        const midIdx = Math.floor(coords.length / 2);
                        lon = coords[midIdx][0];
                        lat = coords[midIdx][1];
                    } else {
                        return; // Skip if no valid coordinates
                    }

                    const marker = L.circleMarker([lat, lon], {
                        radius: 5,
                        fillColor: "#9b59b6", // Purple for Toowoomba
                        color: "#fff",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    marker.bindPopup(`<b>${name}</b><br>ID: ${id}<br><button onclick="selectToowoombaSite('${id}')">Analyze</button>`);
                    marker.on('click', () => selectToowoombaSite(id));
                    toowoombaLayerGroup.addLayer(marker);
                }
            });
            toowoombaLayerGroup.addTo(toowoombaMapInstance);
        }
    }

    function populateToowoombaList() {
        const select = document.getElementById('toowoombaSiteSelect');
        select.innerHTML = "";
        
        if (toowoombaDataGlobal && toowoombaDataGlobal.features) {
            const features = [...toowoombaDataGlobal.features].sort((a, b) => {
                const nameA = getToowoombaName(a.properties || {});
                const nameB = getToowoombaName(b.properties || {});
                return nameA.localeCompare(nameB);
            });

            features.forEach(feature => {
                const props = feature.properties || {};
                const name = getToowoombaName(props);
                const id = getToowoombaId(props, feature.id);
                
                const opt = document.createElement("option");
                opt.value = id;
                opt.innerText = `${name} (${id})`;
                select.appendChild(opt);
            });
        }
    }

    function filterToowoombaList() {
        const query = document.getElementById('toowoombaSearch').value.toLowerCase();
        const select = document.getElementById('toowoombaSiteSelect');
        select.innerHTML = "";
        
        if (toowoombaDataGlobal && toowoombaDataGlobal.features) {
            toowoombaDataGlobal.features.filter(f => {
                const p = f.properties || {};
                const text = `${p.Road_Name || ''} ${p.ROAD_NAME || ''} ${p.Street || ''} ${p.STREET || ''} ${p.Location || ''} ${p.COUNTER_LOCATION || ''} ${p.SUBURB || ''} ${p.OBJECTID || ''} ${p.SiteID || ''}`.toLowerCase();
                return text.includes(query);
            }).forEach(feature => {
                const props = feature.properties || {};
                const name = getToowoombaName(props);
                const id = getToowoombaId(props, feature.id);
                
                const opt = document.createElement("option");
                opt.value = id;
                opt.innerText = `${name} (${props.SUBURB || ''})`;
                select.appendChild(opt);
            });
        }
    }

    let currentToowoombaFeature = null;

    function selectToowoombaSite(siteId) {
        if (!toowoombaDataGlobal || !toowoombaDataGlobal.features) return;

        currentToowoombaFeature = toowoombaDataGlobal.features.find(feature => {
            const props = feature.properties || {};
            const featureId = getToowoombaId(props, feature.id);
            return String(featureId) === String(siteId) || 
                String(props.SiteID || '') === String(siteId);
        });
        
        if (!currentToowoombaFeature) return;

        const props = currentToowoombaFeature.properties || {};

        document.getElementById('toowoombaCalcArea').style.display = 'block';

        const name = getToowoombaName(props);
        document.getElementById('toowoombaSelectedName').innerText = name;
        document.getElementById('toowoombaAnalysisRoad').placeholder = name || "Analysis Road";

        // Extract and display coordinates
        if (currentToowoombaFeature.geometry && currentToowoombaFeature.geometry.coordinates) {
            const coords = currentToowoombaFeature.geometry.coordinates;
            let lat, lon;
            
            if (currentToowoombaFeature.geometry.type === 'Point') {
                lon = coords[0];
                lat = coords[1];
            } else if (currentToowoombaFeature.geometry.type === 'LineString' && coords.length > 0) {
                // Use midpoint for line features
                const midIndex = Math.floor(coords.length / 2);
                lon = coords[midIndex][0];
                lat = coords[midIndex][1];
            }
            
            if (lat && lon) {
                document.getElementById('toowoombaCoordinates').innerText = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                document.getElementById('toowoombaMapLink').href = `https://www.google.com/maps?q=${lat},${lon}`;
            } else {
                document.getElementById('toowoombaCoordinates').innerText = '-';
                document.getElementById('toowoombaMapLink').href = '#';
            }
        } else {
            document.getElementById('toowoombaCoordinates').innerText = '-';
            document.getElementById('toowoombaMapLink').href = '#';
        }

        // Extract Traffic Data
        let aadt = props.AADT ?? props.ADT ?? props.adt ?? props.Volume ?? props.Count;
        if (aadt == null || isNaN(aadt)) {
            aadt = 0;
        }

        let year = props.YEAR || props.Year || props.Count_Year || 2020;
        
        if (props.Count_Date || props.COUNT_DATE || props.Date) {
            const d = new Date(props.Count_Date || props.COUNT_DATE || props.Date);
            if (!isNaN(d.getFullYear())) year = d.getFullYear();
        }

        let growth = props.GROWTH_RATE || props.Growth_Rate || 2.5;
        if (growth < 1) growth = growth * 100;

        let hv = props.HV_PCT ?? props.HV ?? props.Heavy_Vehicle_Percent ?? 5.0;
        if (hv < 1) hv = hv * 100;

        document.getElementById('toowoombaBaseYear').innerText = year;
        document.getElementById('toowoombaInputAADT').value = Math.round(Number(aadt) || 0);
        document.getElementById('toowoombaInputGrowth').value = Number(growth).toFixed(1);
        document.getElementById('toowoombaInputHV').value = Number(hv).toFixed(1);

        // Handle LineString geometry
        const geom = currentToowoombaFeature.geometry;
        if (geom && geom.coordinates) {
            let lat, lon;
            if (geom.type === 'Point') {
                lon = geom.coordinates[0];
                lat = geom.coordinates[1];
            } else if (geom.type === 'LineString' && geom.coordinates.length > 0) {
                const coords = geom.coordinates;
                const midIdx = Math.floor(coords.length / 2);
                lon = coords[midIdx][0];
                lat = coords[midIdx][1];
            }
            if (lat && lon) {
                toowoombaMapInstance.setView([lat, lon], 15);
            }
        }

        updateToowoombaAnalysis();
    }

    function updateToowoombaAnalysis() {
        const baseAADT = parseFloat(document.getElementById('toowoombaInputAADT').value) || 0;
        const baseYear = parseInt(document.getElementById('toowoombaBaseYear').innerText);
        const targetYear = parseInt(document.getElementById('toowoombaTargetYear').value);
        const growthRate = parseFloat(document.getElementById('toowoombaInputGrowth').value) / 100;
        const hvPercent = parseFloat(document.getElementById('toowoombaInputHV').value) / 100;
        const analysisPct = parseFloat(document.getElementById('toowoombaAnalysisPct').value) / 100;

        // 1. PROJECT AADT (Toowoomba Formula - Compound Growth)
        const years = Math.max(0, targetYear - baseYear);
        const projectedAADT = baseAADT * Math.pow((1 + growthRate), years);
        
        // Apply "Analysis Road" Percentage
        const finalAADT = projectedAADT * analysisPct;

        // 2. PEAK HOUR CALCULATION (Toowoomba 80th Highest Hour Formula)
        // Excel: Peak = (AADT * 15%) * 85%
        const peakHour80th = (finalAADT * 0.15) * 0.85;
        
        // 3. OFF-PEAK HOUR CALCULATION (Toowoomba Formula)
        // Excel: Off-peak = ((AADT - Peak) * 15%) * 45%
        const offPeakHour = ((finalAADT - peakHour80th) * 0.15) * 0.45;
        
        // 4. Hourly per lane (assuming 2 lanes total, single direction analysis)
        const lanes = 1; // Per direction
        const hourlyPerLane = peakHour80th / lanes;
        
        // 5. Volume per 5 minutes per lane
        const vol5MinPerLane = hourlyPerLane / 12;
        
        // 6. Split into LV and HV
        const volLV = vol5MinPerLane * (1 - hvPercent);
        const volHV = vol5MinPerLane * hvPercent;
        
        // 7. Design Capacity Calculation (Toowoomba Formula)
        // Excel: =IF(ROUNDUP(0.15*Daily_Limit/2,0)<=500, 500, ROUNDUP(0.15*Daily_Limit/2,0))
        // Using standard Toowoomba Local Street default
        const dayLimit = 750; // Toowoomba Local Street daily limit
        const calc30thHour = Math.round((0.15 * dayLimit) / 2);
        const designCapacity = Math.max(calc30thHour, 500);
        
        // 8. VCR Calculation (Volume / Capacity)
        const vcr = peakHour80th / designCapacity;

        // 9. LOS Logic (Toowoomba thresholds)
        let los = "F";
        let losClass = "los-f";
        if (vcr <= 0.60) { los = "A"; losClass = "los-a"; }
        else if (vcr <= 0.70) { los = "B"; losClass = "los-b"; }
        else if (vcr <= 0.90) { los = "C"; losClass = "los-c"; }
        else if (vcr <= 0.95) { los = "D"; losClass = "los-d"; }
        else if (vcr <= 1.00) { los = "E"; losClass = "los-e"; }

        // 10. Update Results Display
        document.getElementById('toowoombaResAADT').innerText = Math.round(finalAADT).toLocaleString();
        document.getElementById('toowoombaResPeakFlow').innerText = Math.round(peakHour80th).toLocaleString() + ' veh/hr';
        document.getElementById('toowoombaResVCR').innerText = vcr.toFixed(3);
        
        const badge = document.getElementById('toowoombaResLOS');
        if (badge) {
            badge.innerText = "LOS " + los;
            badge.className = "";
            badge.classList.add(losClass);
            badge.style.padding = "5px 10px"; 
            badge.style.borderRadius = "4px"; 
            badge.style.fontWeight = "bold";
        }

        // 11. Queue Calculation (Toowoomba TMR Formula)
        const queueFactors = [
            { id: 'q_2m', min: 2, lvFactor: 2.4, hvFactor: 8 },
            { id: 'q_5m', min: 5, lvFactor: 6, hvFactor: 20 },
            { id: 'q_10m', min: 10, lvFactor: 12, hvFactor: 40 },
            { id: 'q_15m', min: 15, lvFactor: 18, hvFactor: 60 }
        ];

        let queueHtml = "";
        queueFactors.forEach(factor => {
            const qLength = (volLV * factor.lvFactor) + (volHV * factor.hvFactor);
            queueHtml += `
            <tr>
                <td style="padding:6px; border:1px solid #ddd;">${factor.min} min</td>
                <td style="padding:6px; border:1px solid #ddd; text-align:right;">${Math.round(qLength).toLocaleString()} m</td>
            </tr>
        `;
        });

        const toowoombaQueueTable = document.getElementById('toowoombaResQueueTable');
        if (toowoombaQueueTable) {
            toowoombaQueueTable.innerHTML = queueHtml;
        }
        
        // Update capacity field
        document.getElementById('toowoombaCapacity').value = designCapacity;

        // Open results section
        const resultsSection = document.getElementById('toowoombaResultsSection');
        if (resultsSection) {
            resultsSection.open = true;
        }

        // 12. Build Directional Queue Tables (matching Gold Coast layout)
        buildToowoombaDirectionalQueues(peakHour80th, offPeakHour, hvPercent, lanes);

        // 13. Build Traffic Impact Analysis (VCR Scenarios)
        buildToowoombaTrafficImpactAnalysis(peakHour80th, offPeakHour, designCapacity, lanes);

        // Pass data to unified calculation system
        const roadName = document.getElementById('toowoombaSelectedName').innerText || 'Toowoomba Site';
        passToCalculations_Manual(
            roadName,
            baseAADT,
            lanes,
            parseFloat(document.getElementById('toowoombaInputHV').value) || 13.0,
            0,
            baseYear,
            parseFloat(document.getElementById('toowoombaInputGrowth').value) || 2.5,
            targetYear
        );
    }

    function buildToowoombaDirectionalQueues(peakHour, offPeakHour, cvRatio, laneCount) {
        const section = document.getElementById('toowoombaQueueSection');
        const contentElement = document.getElementById('toowoombaQueueContent');
        
        if (!section || !contentElement) return;

        const directionLabels = ['Direction 1', 'Direction 2'];
        const directionPeakHour = peakHour / 2;
        const directionOffPeakHour = offPeakHour / 2;

        function buildDirectionalQueue(directionLabel, dirPeakHour, dirOffPeakHour, cvRatio, laneCount) {
            const hourlyPeak = dirPeakHour;
            const hourlyPeakCv = hourlyPeak * cvRatio;
            const hourlyOffPeak = dirOffPeakHour;
            const hourlyOffPeakCv = hourlyOffPeak * cvRatio;

            const hourlyPeakPerLane = hourlyPeak / laneCount;
            const hourlyPeakCvPerLane = hourlyPeakCv / laneCount;
            const hourlyOffPeakPerLane = hourlyOffPeak / laneCount;
            const hourlyOffPeakCvPerLane = hourlyOffPeakCv / laneCount;

            const peakVol5 = hourlyPeakPerLane / 12;
            const peakCvVol5 = hourlyPeakCvPerLane / 12;
            const offPeakVol5 = hourlyOffPeakPerLane / 12;
            const offPeakCvVol5 = hourlyOffPeakCvPerLane / 12;

            function queueLength(volume5Total, volume5Cv, lvFactor, hvFactor) {
                return (volume5Total * lvFactor) + (volume5Cv * hvFactor);
            }

            const q2Peak = queueLength(peakVol5, peakCvVol5, 2.4, 8);
            const q5Peak = queueLength(peakVol5, peakCvVol5, 6, 20);
            const q10Peak = queueLength(peakVol5, peakCvVol5, 12, 40);
            const q15Peak = queueLength(peakVol5, peakCvVol5, 18, 60);

            const q2Off = queueLength(offPeakVol5, offPeakCvVol5, 2.4, 8);
            const q5Off = queueLength(offPeakVol5, offPeakCvVol5, 6, 20);
            const q10Off = queueLength(offPeakVol5, offPeakCvVol5, 12, 40);
            const q15Off = queueLength(offPeakVol5, offPeakCvVol5, 18, 60);

            return `
                <div style="margin:15px 0; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #dee2e6;">
                    <h4 style="margin:0 0 15px 0; color:#1f5e63;">Queue Length Estimation: Toowoomba - ${directionLabel}</h4>
                    <table style="width:100%; border-collapse:collapse; font-size:0.88em;">
                        <tr style="background:#f4f6f8; font-weight:bold;">
                            <td style="padding:8px; border:1px solid #ddd;" colspan="2"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">80th Highest Hour<br>(Peak traffic estimate)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">CV</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">Off-peak traffic<br>(Estimated Highest Hour - 45% of remaining volume)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">CV</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd; font-weight:bold;" colspan="2">Hourly Average</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakCv).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakCv).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd; font-weight:bold;" colspan="2">Hourly Average per Lane</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakPerLane).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakCvPerLane).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakPerLane).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakCvPerLane).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd; font-weight:bold;" colspan="2">Queue length estimation</td>
                            <td style="padding:8px; border:1px solid #ddd;" colspan="4"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">Volume</td>
                            <td style="padding:8px; border:1px solid #ddd;">per 5 mins</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(peakVol5).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(peakCvVol5).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(offPeakVol5).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(offPeakCvVol5).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">2 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q2Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right; background:#cfe8b3;">${Math.round(q2Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">5 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q5Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q5Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">10 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q10Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q10Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">15 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q15Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q15Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        const html = buildDirectionalQueue(directionLabels[0], directionPeakHour, directionOffPeakHour, cvRatio, laneCount) + 
                     buildDirectionalQueue(directionLabels[1], directionPeakHour, directionOffPeakHour, cvRatio, laneCount);

        if (contentElement) {
            contentElement.innerHTML = html;
        }

        const queueSection = document.getElementById('toowoombaQueueSection');
        if (queueSection) {
            queueSection.open = true;
        }
    }

    function buildToowoombaTrafficImpactAnalysis(peakHour, offPeakHour, designCap, laneCount) {
        // Show impact section and hide placeholder
        const section = document.getElementById('toowoombaImpactSection');
        const contentElement = document.getElementById('toowoombaImpactContent');
        const placeholder = document.getElementById('toowoombaImpactPlaceholder');
        
        if (!section || !contentElement) return;
        
        if (placeholder) placeholder.style.display = 'none';
        contentElement.style.display = 'block';

        const dirPeakHour = peakHour / 2;
        const dirOffPeakHour = offPeakHour / 2;

        function getVcrClass(vcr) {
            if (vcr === 'N/A') return '';
            if (vcr <= 0.60) return 'los-a';
            if (vcr <= 0.70) return 'los-b';
            if (vcr <= 0.90) return 'los-c';
            if (vcr <= 0.95) return 'los-d';
            if (vcr <= 1.00) return 'los-e';
            return 'los-f';
        }

        function formatVcr(vcr) {
            return vcr === 'N/A' ? 'N/A' : vcr.toFixed(2);
        }

        const scenarios = [
            {
                label: 'Direction 1',
                peak: dirPeakHour / designCap,
                offPeak: dirOffPeakHour / designCap
            },
            {
                label: 'Direction 2',
                peak: dirPeakHour / designCap,
                offPeak: dirOffPeakHour / designCap
            },
            {
                label: '1 Lane Closure Direction 1',
                peak: laneCount > 1 ? (dirPeakHour / (laneCount - 1)) / designCap : 'N/A',
                offPeak: laneCount > 1 ? (dirOffPeakHour / (laneCount - 1)) / designCap : 'N/A'
            },
            {
                label: '1 Lane Closure Direction 2',
                peak: laneCount > 1 ? (dirPeakHour / (laneCount - 1)) / designCap : 'N/A',
                offPeak: laneCount > 1 ? (dirOffPeakHour / (laneCount - 1)) / designCap : 'N/A'
            },
            {
                label: 'Single Lane Reversible Flow',
                peak: (dirPeakHour * 2) / designCap,
                offPeak: (dirOffPeakHour * 2) / designCap
            }
        ];

        const html = `
            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                <tr style="background:#f4f6f8; font-weight:bold;">
                    <td style="padding:8px; border:1px solid #ddd; font-weight:bold;">Design Volume (Capacity) *</td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">${Math.round(designCap).toLocaleString()}</td>
                    <td style="padding:8px; border:1px solid #ddd;" colspan="2"></td>
                </tr>
                <tr style="background:#f4f6f8; font-weight:bold;">
                    <td style="padding:8px; border:1px solid #ddd;">VCR (Degrees of Saturation)</td>
                    <td style="padding:8px; border:1px solid #ddd;"></td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">Peak</td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">Off-Peak</td>
                </tr>
                ${scenarios.map(s => `
                    <tr>
                        <td style="padding:8px; border:1px solid #ddd; font-weight:bold;">${s.label}</td>
                        <td style="padding:8px; border:1px solid #ddd;"></td>
                        <td style="padding:8px; border:1px solid #ddd; text-align:center; ${s.peak !== 'N/A' ? 'background-color:' : ''}" class="${s.peak !== 'N/A' ? getVcrClass(s.peak) : ''}">${formatVcr(s.peak)}</td>
                        <td style="padding:8px; border:1px solid #ddd; text-align:center; ${s.offPeak !== 'N/A' ? 'background-color:' : ''}" class="${s.offPeak !== 'N/A' ? getVcrClass(s.offPeak) : ''}">${formatVcr(s.offPeak)}</td>
                    </tr>
                `).join('')}
            </table>
        `;

        if (contentElement) {
            contentElement.innerHTML = html;
        }

        const impactSection = document.getElementById('toowoombaImpactSection');
        if (impactSection) {
            impactSection.open = true;
        }
    }

    async function getEmbeddedTmrRawData() {
        try {
            return await getGitHubTMRData();
        } catch (err) {
            console.warn('GitHub data failed, using fallback minimal dataset');
            // Return a minimal fallback dataset so app still works
            return {
                fields: [
                    { id: 'SITE_ID' },
                    { id: 'DESCRIPTION' },
                    { id: 'ROAD_NAME' },
                    { id: 'LATITUDE' },
                    { id: 'LONGITUDE' }
                ],
                records: [
                    [1, 'Test Site 1', 'Main Street', -33.8688, 151.2093],
                    [2, 'Test Site 2', 'Oxford Street', -33.8736, 151.2087],
                    [3, 'Test Site 3', 'Queen Street', -33.8710, 151.2059]
                ]
            };
        }
    }

    function normalizeTrafficData(rawData) {
        if (rawData && Array.isArray(rawData.fields) && Array.isArray(rawData.records)) {
            return rawData;
        }

        function getFieldValue(source, fieldId) {
            if (!source) return undefined;
            if (source[fieldId] !== undefined) return source[fieldId];

            const aliases = {
                SITE_ID: ['SITE_ID', 'Site_ID', 'SITEID', 'SiteID', 'site_id', 'siteid'],
                DESCRIPTION: ['DESCRIPTION', 'Desc', 'DESC', 'description'],
                ROAD_NAME: ['ROAD_NAME', 'Road_Name', 'ROADNAME', 'road_name', 'roadname'],
                GAZETTAL_DIRECTION: ['GAZETTAL_DIRECTION', 'GAZETTAL', 'DIRECTION', 'Direction'],
                HOURS: ['HOURS', 'HOUR', 'Hour', 'TIME', 'Time'],
                MON: ['MON', 'Mon', 'MONDAY', 'Monday'],
                TUE: ['TUE', 'Tue', 'TUESDAY', 'Tuesday'],
                WED: ['WED', 'Wed', 'WEDNESDAY', 'Wednesday'],
                THU: ['THU', 'Thu', 'THURSDAY', 'Thursday'],
                FRI: ['FRI', 'Fri', 'FRIDAY', 'Friday'],
                SAT: ['SAT', 'Sat', 'SATURDAY', 'Saturday'],
                SUN: ['SUN', 'Sun', 'SUNDAY', 'Sunday'],
                WEEKDAY_AVERAGE: ['WEEKDAY_AVERAGE', 'WEEKDAY_AVG', 'WEEKDAY', 'Weekday_Avg', 'Weekday'],
                WEEKEND_AVERAGE: ['WEEKEND_AVERAGE', 'WEEKEND_AVG', 'WEEKEND', 'Weekend_Avg', 'Weekend']
            };

            const lookup = aliases[fieldId] || [];
            for (const key of lookup) {
                if (source[key] !== undefined) return source[key];
            }
            return undefined;
        }

        if (rawData && rawData.type === 'FeatureCollection' && Array.isArray(rawData.features)) {
            const fieldIds = [
                'SITE_ID', 'DESCRIPTION', 'SITE_DISTANCE', 'LONGITUDE', 'LATITUDE',
                'RSECT_ID', 'ROAD_NAME', 'TDIST_START', 'TDIST_END', 'GAZETTAL_DIRECTION',
                'HOURS', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN',
                'WEEKDAY_AVERAGE', 'WEEKEND_AVERAGE'
            ];

            return {
                fields: [{ id: '_id', type: 'int' }, ...fieldIds.map(id => ({ id }))],
                records: rawData.features.map((feature, index) => {
                    const properties = feature.properties || {};
                    const coordinates = feature.geometry && Array.isArray(feature.geometry.coordinates)
                        ? feature.geometry.coordinates
                        : [null, null];

                    return [
                        index + 1,
                        ...fieldIds.map(fieldId => {
                            if (fieldId === 'LONGITUDE') {
                                return getFieldValue(properties, fieldId) ?? coordinates[0];
                            }
                            if (fieldId === 'LATITUDE') {
                                return getFieldValue(properties, fieldId) ?? coordinates[1];
                            }
                            return getFieldValue(properties, fieldId);
                        })
                    ];
                })
            };
        }

        const avgVolumes = rawData && rawData['2024 Avg Volumes'];
        if (Array.isArray(avgVolumes)) {
            const fieldIds = [
                'SITE_ID', 'DESCRIPTION', 'SITE_DISTANCE', 'LONGITUDE', 'LATITUDE',
                'RSECT_ID', 'ROAD_NAME', 'TDIST_START', 'TDIST_END', 'GAZETTAL_DIRECTION',
                'HOURS', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN',
                'WEEKDAY_AVERAGE', 'WEEKEND_AVERAGE'
            ];

            return {
                fields: [{ id: '_id', type: 'int' }, ...fieldIds.map(id => ({ id }))],
                records: avgVolumes.map((row, index) => [
                    index + 1,
                    ...fieldIds.map(fieldId => getFieldValue(row, fieldId))
                ])
            };
        }

        throw new Error('Unsupported TMR JSON format.');
    }

    async function loadTrafficData() {
        console.log('==== Starting Traffic Data Load ====');
        const loadingDetails = document.getElementById('loadingDetails');
        
        try {
            console.log('GitHub TMR URL:', GITHUB_TMR_URL);
            updateLoadingProgress('Loading TMR Data...', 'Connecting to GitHub');
            
            // Load TMR Data
            const tmrRaw = await getEmbeddedTmrRawData();
            const normalized = normalizeTrafficData(tmrRaw);
            sitesData = parseTrafficData(normalized);
            
            console.log('Step 2: TMR data received, processing...');
            const siteCount = Object.keys(sitesData).length;
            console.log(`Loaded ${siteCount} sites from TMR data`);
            
            // Initialize UI
            console.log('Step 3: Initializing site list...');
            updateLoadingProgress('Initializing components...', 'Building site index');
            await initializeSiteList();
            
            // Load Gold Coast Data in background
            console.log('Step 4: Loading Gold Coast GeoJSON...');
            updateLoadingProgress('Loading Map Data...', 'Finalizing components');
            const gcGeo = await getEmbeddedGeoJSON();
            window.goldCoastDataRaw = gcGeo;
            
            console.log('‚úì Complete: All data loaded successfully');
            
        } catch (error) {
            console.error('Fatal Load Error:', error);
            // Show error but allow app to be usable
            if (loadingDetails) {
                loadingDetails.innerHTML = "‚ö†Ô∏è GitHub data unavailable. Continuing in manual mode...";
            }
        } finally {
            // ALWAYS hide loading screen regardless of success/failure
            // This is the key fix - guarantees the overlay closes
            console.log('Hiding loading overlay...');
            setTimeout(() => {
                hideLoading();
                console.log('‚úì Loading overlay hidden');
            }, 500);
        }
    }

    function selectSiteFromMap(siteId) {
        siteInput.value = siteId;
        siteInput.dispatchEvent(new Event('change'));
        
        // Scroll to and focus on the search field for visual feedback
        siteInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        siteInput.focus();
        
        // Add visual highlight effect
        siteInput.style.transition = 'background-color 0.3s';
        siteInput.style.backgroundColor = '#ffffcc';
        setTimeout(() => {
            siteInput.style.backgroundColor = '';
        }, 1000);
    }

    function parseTrafficData(jsonData) {
        const sites = {};
        const fieldMap = {};
        
        // Create field index map
        jsonData.fields.forEach((field, index) => {
            fieldMap[field.id] = index;
        });
        
        // Process each record
        jsonData.records.forEach(record => {
            const siteId = String(record[fieldMap['SITE_ID']]);
            const description = record[fieldMap['DESCRIPTION']].replace(/"/g, '');
            const roadName = record[fieldMap['ROAD_NAME']].replace(/"/g, '');
            const direction = record[fieldMap['GAZETTAL_DIRECTION']];
            const hours = record[fieldMap['HOURS']];
            const weekdayAvg = record[fieldMap['WEEKDAY_AVERAGE']];
            const longitude = record[fieldMap['LONGITUDE']];
            const latitude = record[fieldMap['LATITUDE']];
            
            // Initialize site if not exists
            if (!sites[siteId]) {
                sites[siteId] = {
                    description: description,
                    road_name: roadName,
                    longitude: longitude,
                    latitude: latitude,
                    directions: {
                        'GAZETTAL': new Array(24).fill(0),
                        'AGAINST GAZETTAL': new Array(24).fill(0)
                    },
                    hour_order: {
                        'GAZETTAL': [],
                        'AGAINST GAZETTAL': []
                    },
                    rawRows: []
                };
            }
            
            // Parse hour range (e.g., "0 to 1" -> hour 0)
            const hourMatch = hours.match(/^(\d+)\s+to\s+(\d+)$/);
            if (hourMatch && sites[siteId].directions[direction]) {
                const hourIndex = parseInt(hourMatch[1]);
                if (hourIndex >= 0 && hourIndex < 24) {
                    const orderList = sites[siteId].hour_order[direction];
                    if (orderList && !orderList.includes(hourIndex)) {
                        orderList.push(hourIndex);
                    }
                    sites[siteId].directions[direction][hourIndex] = weekdayAvg;
                }
            }

            sites[siteId].rawRows.push({
                direction: direction || 'Unknown',
                hourLabel: hours || '-',
                mon: record[fieldMap['MON']] ?? '-',
                tue: record[fieldMap['TUE']] ?? '-',
                wed: record[fieldMap['WED']] ?? '-',
                thu: record[fieldMap['THU']] ?? '-',
                fri: record[fieldMap['FRI']] ?? '-',
                sat: record[fieldMap['SAT']] ?? '-',
                sun: record[fieldMap['SUN']] ?? '-',
                weekdayAvg: record[fieldMap['WEEKDAY_AVERAGE']] ?? '-',
                weekendAvg: record[fieldMap['WEEKEND_AVERAGE']] ?? '-'
            });
        });
        
        return sites;
    }
    
    const siteInput = document.getElementById('siteInput');
    const sitesList = document.getElementById('sites');
    let hourlyMap;
    let hourlySiteLayer;
    let hourlySiteMarkers = {};
    let selectedHourlySiteId = null;

    function addTileLayerWithFallback(targetMap, primaryUrl, primaryOptions, fallbackUrl, fallbackOptions) {
        const primaryLayer = L.tileLayer(primaryUrl, primaryOptions);
        const fallbackLayer = L.tileLayer(fallbackUrl, fallbackOptions);
        let errorCount = 0;
        let fallbackAdded = false;

        primaryLayer.on('tileerror', () => {
            errorCount += 1;
            if (!fallbackAdded && errorCount >= 5) {
                fallbackAdded = true;
                targetMap.addLayer(fallbackLayer);
                targetMap.removeLayer(primaryLayer);
            }
        });

        primaryLayer.addTo(targetMap);
    }

    function initHourlyMap() {
        if (hourlyMap) return;

        hourlyMap = L.map('map').setView([-28.00, 153.40], 10);
        addTileLayerWithFallback(
            hourlyMap,
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            { attribution: '&copy; OpenStreetMap contributors' },
            'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            { attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }
        );
    }

    function resetSelectedHourlyMarker() {
        if (selectedHourlySiteId && hourlySiteMarkers[selectedHourlySiteId]) {
            hourlySiteMarkers[selectedHourlySiteId].setStyle({
                radius: 5,
                fillColor: '#ff7800',
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        }
    }

    function highlightHourlyMarker(siteId) {
        resetSelectedHourlyMarker();
        selectedHourlySiteId = siteId;

        if (hourlySiteMarkers[siteId]) {
            hourlySiteMarkers[siteId].setStyle({
                radius: 8,
                fillColor: '#0056b3',
                color: '#003366',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.95
            });
            hourlySiteMarkers[siteId].openPopup();
        }
    }

    function populateHourlyMapSites(searchTerm = '') {
        if (!hourlyMap) return;

        const normalizedSearch = String(searchTerm || '').trim().toLowerCase();
        const mapCountEl = document.getElementById('tmrMapCount');

        // Remove existing layers
        if (hourlySiteLayer) {
            hourlyMap.removeLayer(hourlySiteLayer);
        }
        if (markerClusterGroup) {
            hourlyMap.removeLayer(markerClusterGroup);
        }

        hourlySiteMarkers = {};
        const bounds = [];
        
        // Create marker cluster group for better performance
        markerClusterGroup = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });

        let markerCount = 0;
        const totalSites = Object.keys(sitesData).length;
        
        // Use requestAnimationFrame for smoother rendering
        const entries = Object.entries(sitesData);
        const batchSize = 100; // Process markers in batches
        let currentIndex = 0;

        function processBatch() {
            const endIndex = Math.min(currentIndex + batchSize, entries.length);
            
            for (let i = currentIndex; i < endIndex; i++) {
                const [siteId, data] = entries[i];
                
                if (!data || !data.latitude || !data.longitude) continue;

                const searchable = `${siteId} ${data.road_name || ''} ${data.description || ''}`.toLowerCase();
                if (normalizedSearch && !searchable.includes(normalizedSearch)) continue;

                const lat = Number(data.latitude);
                const lon = Number(data.longitude);
                if (Number.isNaN(lat) || Number.isNaN(lon)) continue;

                const marker = L.circleMarker([lat, lon], {
                    radius: 5,
                    fillColor: '#ff7800',
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.bindPopup(`
                    <strong>${siteId}</strong><br>
                    ${data.road_name}<br>
                    ${data.description}<br>
                    ${lat.toFixed(6)}, ${lon.toFixed(6)}<br>
                    <button onclick="selectSiteFromMap('${siteId}')" style="background-color: #0056b3; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-top: 5px;">Select for Analysis</button>
                `);

                marker.bindTooltip(`${siteId}`, {
                    permanent: true,
                    direction: 'top',
                    offset: [0, -8],
                    className: 'site-id-label'
                });

                marker.on('click', () => {
                    selectSiteFromMap(siteId);
                });

                hourlySiteMarkers[siteId] = marker;
                markerClusterGroup.addLayer(marker);
                bounds.push([lat, lon]);
                markerCount++;
            }
            
            currentIndex = endIndex;
            
            if (currentIndex < entries.length) {
                // Process next batch
                requestAnimationFrame(processBatch);
            } else {
                // Finished processing all markers
                hourlyMap.addLayer(markerClusterGroup);
                
                if (mapCountEl) {
                    mapCountEl.textContent = `Showing ${markerCount} of ${totalSites} sites`;
                }

                if (bounds.length > 0) {
                    hourlyMap.fitBounds(bounds, { padding: [20, 20] });
                }

                if (selectedHourlySiteId && hourlySiteMarkers[selectedHourlySiteId]) {
                    highlightHourlyMarker(selectedHourlySiteId);
                } else if (selectedHourlySiteId && !hourlySiteMarkers[selectedHourlySiteId]) {
                    selectedHourlySiteId = null;
                }
            }
        }
        
        // Start processing
        processBatch();
    }
    

    window.selectSiteFromMap = function(siteId) {
        siteInput.value = siteId;
        siteInput.dispatchEvent(new Event('change'));
        
        // Scroll to and focus on the search field for visual feedback
        siteInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        siteInput.focus();
        
        // Add visual highlight effect
        siteInput.style.transition = 'background-color 0.3s';
        siteInput.style.backgroundColor = '#ffffcc';
        setTimeout(() => {
            siteInput.style.backgroundColor = '';
        }, 1000);
    };
    
    // Initialize Datalist (optimized with batching)
    function initializeSiteList() {
        return new Promise((resolve) => {
            const entries = Object.entries(sitesData);
            const batchSize = 200;
            let currentIndex = 0;
            
            sitesList.innerHTML = ''; // Clear existing options
            
            function processBatch() {
                const fragment = document.createDocumentFragment();
                const endIndex = Math.min(currentIndex + batchSize, entries.length);
                
                for (let i = currentIndex; i < endIndex; i++) {
                    const [id, data] = entries[i];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${id} - ${data.description}`;
                    fragment.appendChild(option);
                }
                
                sitesList.appendChild(fragment);
                currentIndex = endIndex;
                
                if (currentIndex < entries.length) {
                    // Process next batch
                    requestAnimationFrame(processBatch);
                } else {
                    // Finished - initialize map and resolve
                    initHourlyMap();
                    populateHourlyMapSites();
                    resolve();
                }
            }
            
            processBatch();
        });
    }
    
    // Load data on page load with global timeout and error handling
    // CRITICAL FAILSAFE TIMEOUT: Ensures loading screen ALWAYS disappears
    // If data doesn't load in 15 seconds, hide the overlay anyway
    const failsafeTimeout = setTimeout(() => {
        const loader = document.getElementById('loadingOverlay');
        if (loader && loader.style.display !== 'none') {
            console.warn('‚ö†Ô∏è Failsafe: Hiding loader due to 15-second timeout');
            hideLoading();
        }
    }, 15000);
    
    // Start loading traffic data
    loadTrafficData()
        .catch(err => {
            console.error('loadTrafficData error:', err);
        })
        .finally(() => {
            clearTimeout(failsafeTimeout);
        });

    // Debounced search for better performance
    const debouncedSearch = debounce((value) => {
        populateHourlyMapSites(value);
    }, 300);

    siteInput.addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
    });

    // Setup Gold Coast TIA project listener and initialize custom TIA on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        setupGoldCoastProjectListener();
        updateCustomComparison();
        
        // Ensure Gold Coast TIA button is clickable
        const gcTiaBtn = document.getElementById('gcTiaCalcBtn');
        if (gcTiaBtn) {
            console.log('‚úÖ Gold Coast TIA calculation button found and ready');
            gcTiaBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('üñ±Ô∏è TIA button clicked via event listener');
                calculateTIA();
            });
        } else {
            console.error('‚ùå Could not find Gold Coast TIA button (gcTiaCalcBtn)');
        }
    });

    siteInput.addEventListener('change', () => {
        const siteId = siteInput.value;
        const data = sitesData[siteId];
        if (data) {
            populateHourlyMapSites();
            document.getElementById('siteInfo').classList.remove('hidden');
            document.getElementById('roadName').textContent = data.road_name;
            document.getElementById('siteDesc').textContent = data.description;
            
            // Show and update Google Maps link
            if (data.latitude && data.longitude) {
                const lat = data.latitude;
                const lon = data.longitude;
                document.getElementById('mapCoords').textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                document.getElementById('mapLink').href = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;

                if (hourlyMap) {
                    hourlyMap.setView([lat, lon], 14);
                }
                highlightHourlyMarker(siteId);
            }
            
            // Show raw data table
            displayRawData(data);
            const rawSection = document.getElementById('rawDataSection');
            rawSection.classList.remove('hidden');
            rawSection.open = true;
        } else {
               populateHourlyMapSites(siteInput.value);
             document.getElementById('siteInfo').classList.add('hidden');
             const rawSection = document.getElementById('rawDataSection');
             rawSection.classList.add('hidden');
             rawSection.open = false;
               document.getElementById('mapCoords').textContent = '-';
               document.getElementById('mapLink').href = '#';
               resetSelectedHourlyMarker();
               selectedHourlySiteId = null;
        }
    });

    function displayRawData(site) {
        const tbody = document.getElementById('rawDataTable').querySelector('tbody');
        tbody.innerHTML = '';

        const rows = Array.isArray(site.rawRows) ? site.rawRows : [];
        if (rows.length === 0) {
            const row = tbody.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 10;
            cell.textContent = 'No detailed records available.';
            return;
        }

        rows.forEach(record => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = record.direction;
            row.insertCell(1).textContent = record.hourLabel;
            row.insertCell(2).textContent = record.weekdayAvg;
            row.insertCell(3).textContent = record.weekendAvg;
        });
    }

    function updateYears() {
        const dYear = parseFloat(document.getElementById('dataYear').value);
        const oYear = parseFloat(document.getElementById('openingYear').value);
        const diff = oYear - dYear;
        document.getElementById('calcYears').textContent = diff > 0 ? diff : 0;
    }
    
    function updateAutoCapacity() {
        const roadType = document.getElementById('roadType').value;
        const capacityInput = document.getElementById('capacity');
        
        // Temporary fixed setting requested: keep Cap/Ln at 900
        if (roadType) {
            capacityInput.value = 900;
            
            // Visual feedback that the value was updated
            capacityInput.style.backgroundColor = "#e7f3ff";
            setTimeout(() => { capacityInput.style.backgroundColor = ""; }, 500);
        }
    }

    function printTmrReport() {
        window.print();
    }
    
    // Initial call
    updateYears();
    updateAadtCap();

    let chartInstance = null;

    function getLOS(vcr) {
        if (vcr <= 0.60) return 'A';
        if (vcr <= 0.70) return 'B';
        if (vcr <= 0.80) return 'C';
        if (vcr <= 0.90) return 'D';
        if (vcr <= 1.00) return 'E';
        return 'F';
    }

    function getStatusClass(vcr) {
        if (vcr <= 0.80) return 'status-green'; 
        if (vcr <= 0.90) return 'status-yellow'; 
        return 'status-red'; 
    }

    function calculate() {
        // Standard calculation using site data
        const siteId = siteInput.value;
        if (!sitesData[siteId]) { alert("Select a site first"); return; }
        
        const site = sitesData[siteId];
        const selectedRoadName = site.road_name || site.ROAD_NAME || 'Selected Site';

        // Calculate total AADT from database hourly records (AC36 reference)
        const gazData = site.directions['GAZETTAL'] || new Array(24).fill(0);
        const agData = site.directions['AGAINST GAZETTAL'] || new Array(24).fill(0);
        const totalDailyCount = gazData.reduce((a, b) => a + b, 0) + agData.reduce((a, b) => a + b, 0);

        // Exact TMR specifics (AC41/AC42)
        const tmrResults = calculateTMRSpecifics(totalDailyCount);

        // Update TMR-specific outputs if card is present
        if (document.getElementById('tmr_dhv_display')) {
            document.getElementById('tmr_dhv_display').innerText = tmrResults.dhv.toLocaleString() + ' vph';
            document.getElementById('tmr_peak_display').innerText = tmrResults.peakFlow.toLocaleString() + ' vph';
        }

        const growth = parseFloat(document.getElementById('growthRate').value);
        const dYear = parseFloat(document.getElementById('dataYear').value);
        const oYear = parseFloat(document.getElementById('openingYear').value);
        const years = Math.max(0, oYear - dYear);
        
        const hv = parseFloat(document.getElementById('hvPercent').value);
        const baseLanes = parseFloat(document.getElementById('lanes').value);
        const capPerLane = parseFloat(document.getElementById('capacity').value);
        const hvRatio = Math.max(0, Math.min(1, hv / 100));
        const growthFactor = Math.pow(1 + growth / 100, years);
        
        document.getElementById('displayYear').textContent = oYear;

        const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
        const datasetGaz = gazData;
        const datasetAg = agData;
        const datasetGazFut = datasetGaz.map(v => v * growthFactor);
        const datasetAgFut = datasetAg.map(v => v * growthFactor);

        updateChart(labels, datasetGaz, datasetGazFut, datasetAg, datasetAgFut);
        function range(start, end) {
            return Array.from({ length: end - start + 1 }, (_, i) => start + i);
        }

        function buildSMap(againstOrdered, gazOrdered) {
            const s = {};
            for (let i = 0; i < 24; i += 1) {
                s[2 + i] = againstOrdered[i] || 0;
                s[26 + i] = gazOrdered[i] || 0;
            }
            return s;
        }

        function sumIndices(s, indices) {
            return indices.reduce((sum, idx) => sum + (s[idx] || 0), 0);
        }

        const againstOrder = site.hour_order && site.hour_order['AGAINST GAZETTAL'] ? site.hour_order['AGAINST GAZETTAL'] : [];
        const gazOrder = site.hour_order && site.hour_order['GAZETTAL'] ? site.hour_order['GAZETTAL'] : [];
        const defaultOrder = Array.from({ length: 24 }, (_, i) => i);
        const againstHourOrder = againstOrder.length === 24 ? againstOrder : defaultOrder;
        const gazHourOrder = gazOrder.length === 24 ? gazOrder : defaultOrder;

        const againstOrdered = againstHourOrder.map(hour => agData[hour] || 0);
        const gazOrdered = gazHourOrder.map(hour => gazData[hour] || 0);
        const s = buildSMap(againstOrdered, gazOrdered);

        const periodOrder = ['AM', 'OP', 'PM', 'EV'];
        const againstIndices = {
            AM: range(23, 24),
            OP: [25, ...range(4, 9)],
            PM: range(10, 11),
            EV: [...range(12, 22), ...range(2, 3)]
        };
        const gazIndices = {
            AM: range(47, 48),
            OP: [49, ...range(28, 33)],
            PM: range(34, 35),
            EV: [...range(34, 46), ...range(26, 27)]
        };
        const periodFactors = {
            AM: 0.60,
            OP: 0.15,
            PM: 0.60,
            EV: 0.15
        };
        const queueFactors = {
            2: { lv: 2.4, hv: 8 },
            5: { lv: 6, hv: 20 },
            10: { lv: 12, hv: 40 },
            15: { lv: 18, hv: 60 },
            30: { lv: 36, hv: 120 }
        };

        function splitLvHv(total, hvPct) {
            const hvValue = Math.ceil(total * hvPct);
            const lvValue = Math.ceil(total - (total * hvPct));
            return { lv: lvValue, hv: hvValue, total: lvValue + hvValue };
        }

        function buildDirectionResult(indices) {
            const base = {};
            const future = {};
            const dhv = {};
            const vol5 = {};
            const hourlyAvgPerLane = {};
            const queue = { 2: {}, 5: {}, 10: {}, 15: {} };
            const hoursCount = {};

            periodOrder.forEach(period => {
                const periodIndices = indices[period];
                const baseTotal = sumIndices(s, periodIndices);
                const baseSplit = splitLvHv(baseTotal, hvRatio);
                base[period] = baseSplit;

                const futureLv = Math.ceil(baseSplit.lv * growthFactor);
                const futureHv = Math.ceil(baseSplit.hv * growthFactor);
                const futureTotal = futureLv + futureHv;
                future[period] = { lv: futureLv, hv: futureHv, total: futureTotal };

                const factor = periodFactors[period];
                const dhvLv = Math.ceil((futureLv * factor * 0.85) / baseLanes);
                const dhvHv = Math.ceil((futureHv * factor * 0.85) / baseLanes);
                dhv[period] = { lv: dhvLv, hv: dhvHv, total: dhvLv + dhvHv };

                const vol5Lv = Math.ceil(dhvLv * 5 / 60);
                const vol5Hv = Math.ceil(dhvHv * 5 / 60);
                vol5[period] = { lv: vol5Lv, hv: vol5Hv, total: vol5Lv + vol5Hv };

                const periodHours = periodIndices.length;
                hoursCount[period] = periodHours;
                const hourlyTotal = periodHours > 0 ? (futureTotal / periodHours) / baseLanes : 0;
                hourlyAvgPerLane[period] = {
                    lv: Math.round(hourlyTotal * (1 - hvRatio)),
                    hv: Math.round(hourlyTotal * hvRatio),
                    total: hourlyTotal
                };

                [2, 5, 10, 15].forEach(duration => {
                    const factors = queueFactors[duration];
                    const qLen = (vol5Lv * factors.lv) + (vol5Hv * factors.hv);
                    queue[duration][period] = qLen;
                });
            });

            const totalBase = periodOrder.reduce((sum, period) => sum + base[period].total, 0);
            const totalFuture = periodOrder.reduce((sum, period) => sum + future[period].total, 0);
            const capacity = Math.max(Math.ceil((0.12 * totalFuture) / baseLanes), 500);

            const queueMax = {
                2: Math.max(...periodOrder.map(period => queue[2][period])),
                5: Math.max(...periodOrder.map(period => queue[5][period])),
                10: Math.max(...periodOrder.map(period => queue[10][period])),
                15: Math.max(...periodOrder.map(period => queue[15][period]))
            };

            return {
                base,
                future,
                dhv,
                vol5,
                hourlyAvgPerLane,
                hoursCount,
                totalBase,
                totalFuture,
                capacity,
                queue,
                queueMax
            };
        }

        function buildDirectionDetailedTable(title, result, baseYear, futureYear) {
            return `
                <div class="tmr-detail-card">
                    <div class="tmr-detail-title">${title}</div>
                    <table class="tmr-detail-table">
                        <tr>
                            <th></th>
                            <th colspan="2">AM</th>
                            <th colspan="2">OP</th>
                            <th colspan="2">PM</th>
                            <th colspan="2">EV</th>
                            <th>Total</th>
                        </tr>
                        <tr>
                            <td>${baseYear}</td>
                            ${periodOrder.map(period => `<td>${result.base[period].lv.toLocaleString()}</td><td>${result.base[period].hv.toLocaleString()}</td>`).join('')}
                            <td>${Math.round(result.totalBase).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td>${futureYear}</td>
                            ${periodOrder.map(period => `<td>${result.future[period].lv.toLocaleString()}</td><td>${result.future[period].hv.toLocaleString()}</td>`).join('')}
                            <td>${Math.round(result.totalFuture).toLocaleString()}</td>
                        </tr>
                        <tr class="tmr-detail-row-highlight">
                            <td>Hrly Avg / lane</td>
                            ${periodOrder.map(period => `<td>${result.hourlyAvgPerLane[period].lv.toLocaleString()}</td><td>${result.hourlyAvgPerLane[period].hv.toLocaleString()}</td>`).join('')}
                            <td></td>
                        </tr>
                        <tr class="tmr-detail-row-queue">
                            <td>Volume per 5 mins</td>
                            ${periodOrder.map(period => `<td>${result.vol5[period].lv.toLocaleString()}</td><td>${result.vol5[period].hv.toLocaleString()}</td>`).join('')}
                            <td class="tmr-detail-max">Max Queue</td>
                        </tr>
                        <tr>
                            <td>Per 2 minutes (m)</td>
                            ${periodOrder.map(period => `<td colspan="2">${Math.round(result.queue[2][period]).toLocaleString()}</td>`).join('')}
                            <td class="tmr-detail-max">${Math.round(result.queueMax[2]).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td>Per 5 minutes (m)</td>
                            ${periodOrder.map(period => `<td colspan="2">${Math.round(result.queue[5][period]).toLocaleString()}</td>`).join('')}
                            <td class="tmr-detail-max">${Math.round(result.queueMax[5]).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td>Per 10 minutes (m)</td>
                            ${periodOrder.map(period => `<td colspan="2">${Math.round(result.queue[10][period]).toLocaleString()}</td>`).join('')}
                            <td class="tmr-detail-max">${Math.round(result.queueMax[10]).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td>Per 15 minutes (m)</td>
                            ${periodOrder.map(period => `<td colspan="2">${Math.round(result.queue[15][period]).toLocaleString()}</td>`).join('')}
                            <td class="tmr-detail-max">${Math.round(result.queueMax[15]).toLocaleString()}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        const againstResult = buildDirectionResult(againstIndices);
        const gazResult = buildDirectionResult(gazIndices);

        const detailHtml =
            buildDirectionDetailedTable(`${selectedRoadName} - Against Gazettal`, againstResult, dYear, oYear) +
            buildDirectionDetailedTable(`${selectedRoadName} - Gazettal`, gazResult, dYear, oYear);
        document.getElementById('tmrDetailedSection').innerHTML = detailHtml;

        function vcrByPeriod(result, capacity) {
            return periodOrder.map(period => {
                const vcr = result.dhv[period].total / capacity;
                return { vcr, los: getLOS(vcr) };
            });
        }

        const againstVcr = vcrByPeriod(againstResult, againstResult.capacity);
        const gazVcr = vcrByPeriod(gazResult, gazResult.capacity);
        const bothCapacity = Math.max(againstResult.capacity, gazResult.capacity);

        const closureAgainst = baseLanes > 1
            ? periodOrder.map(period => ({ vcr: (againstResult.dhv[period].total * baseLanes) / bothCapacity, los: getLOS((againstResult.dhv[period].total * baseLanes) / bothCapacity) }))
            : null;
        const closureGaz = baseLanes > 1
            ? periodOrder.map(period => ({ vcr: (gazResult.dhv[period].total * baseLanes) / bothCapacity, los: getLOS((gazResult.dhv[period].total * baseLanes) / bothCapacity) }))
            : null;
        const reversibleFlow = baseLanes > 1
            ? null
            : periodOrder.map(period => {
                const vcr = (againstResult.dhv[period].total + gazResult.dhv[period].total) / bothCapacity;
                return { vcr, los: getLOS(vcr) };
            });

        const summaryBody = document.getElementById('designVcrSummaryBody');

        function vcrCells(results) {
            return results.map(r => `<td class="${getStatusClass(r.vcr)}">${r.vcr.toFixed(2)} (${r.los})</td>`).join('');
        }

        summaryBody.innerHTML = `
            <tr>
                <td class="row-header">Against Gazettal</td>
                <td>${againstResult.capacity.toLocaleString()}</td>
                <td>${gazResult.capacity.toLocaleString()}</td>
                <td>${bothCapacity.toLocaleString()}</td>
                ${vcrCells(againstVcr)}
            </tr>
            <tr>
                <td class="row-header">Gazettal</td>
                <td>${againstResult.capacity.toLocaleString()}</td>
                <td>${gazResult.capacity.toLocaleString()}</td>
                <td>${bothCapacity.toLocaleString()}</td>
                ${vcrCells(gazVcr)}
            </tr>
            <tr>
                <td class="row-header">Single Lane Closure - Against Gazettal</td>
                <td>${againstResult.capacity.toLocaleString()}</td>
                <td>${gazResult.capacity.toLocaleString()}</td>
                <td>${bothCapacity.toLocaleString()}</td>
                ${closureAgainst ? vcrCells(closureAgainst) : '<td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td>'}
            </tr>
            <tr>
                <td class="row-header">Single Lane Closure - Gazettal</td>
                <td>${againstResult.capacity.toLocaleString()}</td>
                <td>${gazResult.capacity.toLocaleString()}</td>
                <td>${bothCapacity.toLocaleString()}</td>
                ${closureGaz ? vcrCells(closureGaz) : '<td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td>'}
            </tr>
            <tr>
                <td class="row-header">Single Lane Reversible Flow</td>
                <td>${againstResult.capacity.toLocaleString()}</td>
                <td>${gazResult.capacity.toLocaleString()}</td>
                <td>${bothCapacity.toLocaleString()}</td>
                ${reversibleFlow ? vcrCells(reversibleFlow) : '<td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td>'}
            </tr>
        `;

        // Pass data to unified calculation system
        const roadNameEl = document.getElementById('roadName');
        const roadName = roadNameEl ? roadNameEl.innerText : 'TMR Site';
        passToCalculations_Manual(roadName, totalDailyCount || site.aadt || 0, baseLanes, hv, 0, dYear, growth, oYear);

        document.getElementById('results').classList.remove('hidden');
    }

    function processDetail(dirName, futureVols, hvPercent, lanes, contentId, queueDivId, tableId, lvId, hvId, totId) {
        const sum = futureVols.reduce((a,b)=>a+b, 0);
        if (sum === 0) {
            document.getElementById(contentId).innerHTML = 'No data';
            document.getElementById(queueDivId).classList.add('hidden');
            return;
        }
        document.getElementById(contentId).innerHTML = '';
        document.getElementById(queueDivId).classList.remove('hidden');

        // Find absolute peak volume
        let peakVol = 0;
        futureVols.forEach(v => { if(v > peakVol) peakVol = v; });

        // Calculate 5-minute Volume PER LANE
        const volPerLane = peakVol / lanes;
        const vol5min = volPerLane / 12;
        
        const volHV = vol5min * (hvPercent / 100);
        const volLV = vol5min - volHV;

        document.getElementById(totId).textContent = vol5min.toFixed(1);
        document.getElementById(lvId).textContent = volLV.toFixed(1);
        document.getElementById(hvId).textContent = volHV.toFixed(1);

        const steps = [
            { min: 2, lv: 2.4, hv: 8 },
            { min: 5, lv: 6, hv: 20 },
            { min: 10, lv: 12, hv: 40 },
            { min: 15, lv: 18, hv: 60 },
            { min: 30, lv: 36, hv: 120 }
        ];

        let html = '';
        steps.forEach(step => {
            const queue = (volLV * step.lv) + (volHV * step.hv);
            html += `
                <tr>
                    <td>${step.min} min</td>
                    <td>${step.lv}</td>
                    <td>${step.hv}</td>
                    <td><strong>${Math.round(queue)}</strong></td>
                </tr>
            `;
        });
        document.getElementById(tableId).innerHTML = html;
    }

    function processAadtQueue(peakVol) {
        // This helper maps manual peak volume into the existing queue logic
        const growth = parseFloat(document.getElementById('growthRate').value);
        const dYear = parseFloat(document.getElementById('dataYear').value);
        const oYear = parseFloat(document.getElementById('openingYear').value);
        const years = Math.max(0, oYear - dYear);
        const growthFactor = Math.pow(1 + growth/100, years);
        
        const hvPercent = parseFloat(document.getElementById('hvPercent').value);
        const lanes = parseInt(document.getElementById('lanes').value);
        
        const futPeakVol = peakVol * growthFactor;
        const volPerLane = futPeakVol / lanes;
        const vol5min = volPerLane / 12; // 5-min slice per lane
        
        const volHV = vol5min * (hvPercent / 100);
        const volLV = vol5min - volHV;

        // Update UI for Gazettal direction (using AADT-derived peak)
        document.getElementById('lvGaz').textContent = volLV.toFixed(1);
        document.getElementById('hvGaz').textContent = volHV.toFixed(1);
        document.getElementById('totGaz').textContent = vol5min.toFixed(1);
        
        // Generate queue table
        updateBlockageTable('blockageTableGaz', volLV, volHV);
        
        // Clear Against Gazettal (not applicable for AADT input)
        document.getElementById('against-content').innerHTML = '<em>AADT mode: Gazettal direction only</em>';
        document.getElementById('against-queue').classList.add('hidden');
        
        // Show results
        document.getElementById('gazettal-queue').classList.remove('hidden');
        document.getElementById('results').classList.remove('hidden');
        document.getElementById('displayYear').textContent = oYear;
        
        // Clear summary table for AADT mode
        const tbody = document.querySelector('#summaryTable tbody');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;"><em>AADT Mode: VCR summary not available. See queue estimation below.</em></td></tr>';
    }

    function updateBlockageTable(tableId, volLV, volHV) {
        const steps = [
            { min: 2, lv: 2.4, hv: 8 },
            { min: 5, lv: 6, hv: 20 },
            { min: 10, lv: 12, hv: 40 },
            { min: 15, lv: 18, hv: 60 },
            { min: 30, lv: 36, hv: 120 }
        ];

        let html = '';
        steps.forEach(step => {
            const queue = (volLV * step.lv) + (volHV * step.hv);
            html += `
                <tr>
                    <td>${step.min} min</td>
                    <td>${step.lv}</td>
                    <td>${step.hv}</td>
                    <td><strong>${Math.round(queue)}</strong></td>
                </tr>
            `;
        });
        document.getElementById(tableId).innerHTML = html;
    }

    function updateChart(labels, gCur, gFut, aCur, aFut) {
        if (chartInstance) chartInstance.destroy();
        const ctx = document.getElementById('trafficChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Gazettal (Cur)', data: gCur, borderColor: '#0056b3', tension: 0.3, pointRadius: 0 },
                    { label: 'Gazettal (Fut)', data: gFut, borderColor: '#0056b3', borderDash: [5,5], tension: 0.3, pointRadius: 0 },
                    { label: 'Against (Cur)', data: aCur, borderColor: '#dc3545', tension: 0.3, pointRadius: 0 },
                    { label: 'Against (Fut)', data: aFut, borderColor: '#dc3545', borderDash: [5,5], tension: 0.3, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: { y: { beginAtZero: true, title: {display:true, text: 'Volume (vph)'} } }
            }
        });
    }

    // --- TAB FUNCTIONALITY ---
    function openTabFromDropdown() {
        const selector = document.getElementById('tabSelector');
        const tabName = selector.value;
        const tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        
        // Initialize Gold Coast map when tab is opened
        if (tabName === 'tab-tia' && !window.goldCoastMapLoaded) {
            window.goldCoastMapLoaded = true;
            setTimeout(() => {
                if (typeof loadEmbeddedGeoJSON === 'function') {
                    loadEmbeddedGeoJSON();
                }
            }, 100);
        }

        // Initialize Toowoomba map when tab is opened
        if (tabName === 'tab-toowoomba') {
            if (!toowoombaMapInitialized) {
                toowoombaMapInitialized = true;
                initToowoomba();
            } else if (toowoombaMapInstance) {
                toowoombaMapInstance.invalidateSize();
            }
        }

        // Initialize Logan map when tab is opened
        if (tabName === 'Logan') {
            if (!loganMapInitialized) {
                loganMapInitialized = true;
                initLogan();
            } else if (loganMapInstance) {
                loganMapInstance.invalidateSize();
            }
        }

        // Initialize Ipswich map when tab is opened
        if (tabName === 'Ipswich') {
            if (!ipswichMapInitialized) {
                ipswichMapInitialized = true;
                initIpswich();
            } else if (ipswichMapInstance) {
                ipswichMapInstance.invalidateSize();
            }
        }
    }
    
    // Legacy function for backwards compatibility
    function openTab(evt, tabName) {
        openTabFromDropdown();
    }

    // --- AADT CALCULATOR LOGIC ---
    function updateAadtCap() {
        document.getElementById('aadt_cap').value = document.getElementById('aadt_road_type').value;
    }

    function calculateAADTLogic() {
        // 1. Get Inputs
        const aadt = parseFloat(document.getElementById('aadt_val').value) || 0;
        const yearData = parseInt(document.getElementById('aadt_year_data').value);
        const yearProj = parseInt(document.getElementById('aadt_year_proj').value);
        const growth = parseFloat(document.getElementById('aadt_growth').value) / 100;
        const hv = parseFloat(document.getElementById('aadt_hv').value) / 100;
        const lanes = parseInt(document.getElementById('aadt_lanes').value);
        const capacity = parseInt(document.getElementById('aadt_cap').value);
        const k = parseFloat(document.getElementById('aadt_k').value) / 100;
        const d = parseFloat(document.getElementById('aadt_d').value) / 100;

        // 2. Forecast AADT
        const yearsDiff = Math.max(0, yearProj - yearData);
        // Compound growth formula
        const futureAadt = aadt * Math.pow((1 + growth), yearsDiff);

        // 3. Peak Hour Calculations
        const dhv = futureAadt * k * d; // Directional Design Hourly Volume
        const volPerLane = dhv / lanes;
        const vcRatio = volPerLane / capacity;

        // 4. Determine LOS (Approximation based on v/c)
        let los = "A", losClass = "los-a";
        if (vcRatio > 1.00) { los = "F"; losClass = "los-f"; }
        else if (vcRatio > 0.90) { los = "E"; losClass = "los-e"; }
        else if (vcRatio > 0.75) { los = "D"; losClass = "los-d"; }
        else if (vcRatio > 0.55) { los = "C"; losClass = "los-c"; }
        else if (vcRatio > 0.35) { los = "B"; losClass = "los-b"; }

        // 5. Update Results UI
        document.getElementById('res_fut_aadt').innerText = Math.round(futureAadt).toLocaleString();
        document.getElementById('res_dhv').innerText = Math.round(dhv).toLocaleString() + " veh/hr";
        document.getElementById('res_vc').innerText = vcRatio.toFixed(2);
        
        const losEl = document.getElementById('res_los');
        losEl.innerText = los;
        losEl.className = ""; // clear old classes
        losEl.classList.add(losClass); // add color class
        losEl.style.padding = "5px 10px";
        losEl.style.borderRadius = "4px";

        // 6. Queue Blockage Calculation (TMR Formula)
        // Use 5-minute basis for calculations
        const vol5MinPerLane = volPerLane / 12;     // 5-minute arrival rate per lane
        
        // Split into LV and HV based on percentage
        const volHV = vol5MinPerLane * hv;
        const volLV = vol5MinPerLane - volHV;

        // TMR Queue Factors (from TMR Guidelines)
        const factors = [
            { min: 2,  lvFactor: 2.4, hvFactor: 8 },
            { min: 5,  lvFactor: 6,   hvFactor: 20 },
            { min: 10, lvFactor: 12,  hvFactor: 40 },
            { min: 15, lvFactor: 18,  hvFactor: 60 }
        ];

        let html = "";
        factors.forEach(f => {
            // Calculate Queue Length in Meters using TMR factors
            const qLen = (volLV * f.lvFactor) + (volHV * f.hvFactor);
            html += `
            <tr>
                <td>${f.min} min</td>
                <td><strong>${Math.round(qLen)}</strong> m</td>
            </tr>
        `;
        });
        document.getElementById('aadt_queue_table').innerHTML = html;

        // Pass data to unified calculation system
        passToCalculations_Manual('AADT Calculation', aadt, lanes, hv, 0, yearData, growth, yearProj);
    }

    // Pass AADT Calc data to unified calculation system
    function sendAADTDataToCalc() {
        const aadt = parseFloat(document.getElementById('aadt_val').value) || 0;
        const yearData = parseInt(document.getElementById('aadt_year_data').value);
        const yearProj = parseInt(document.getElementById('aadt_year_proj').value);
        const growth = parseFloat(document.getElementById('aadt_growth').value) || 2.5;
        const hv = parseFloat(document.getElementById('aadt_hv').value) || 15;
        const lanes = parseInt(document.getElementById('aadt_lanes').value) || 2;

        if (aadt === 0) {
            alert('Please enter an AADT value first');
            return;
        }

        passToCalculations_Manual(
            'AADT Calculation',
            aadt,
            lanes,
            hv,
            0,
            yearData,
            growth,
            yearProj
        );
        
        navigateToCalculations();
    }

    // --- NEW TIA & MAP LOGIC ---

    // 1. TIA Calculation Function (Matches Excel Logic)
    window.calculateTIA = function calculateTIA() {
        console.log('üöÄ calculateTIA() function called - starting TIA calculation...');
        
        // Visual feedback
        const btn = document.getElementById('gcTiaCalcBtn');
        if (btn) {
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.innerHTML = '‚è≥ Calculating...';
        }
        
        try {
            // Inputs
            const curAADT = parseFloat(document.getElementById('tia_aadt').value) || 0;
            const yearData = parseFloat(document.getElementById('tia_year_data').value);
            const yearOpen = parseFloat(document.getElementById('tia_year_open').value);
            const growth = parseFloat(document.getElementById('tia_growth').value);
            const lanes = parseFloat(document.getElementById('tia_lanes').value);
            const cvPercent = parseFloat(document.getElementById('tia_hv').value) / 100; // CV% as decimal
            
            console.log('TIA Inputs:', { curAADT, yearData, yearOpen, growth, lanes, cvPercent });
            
            if (curAADT === 0) {
                alert('‚ö†Ô∏è Please enter a valid Current AADT value to run the calculation.');
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.innerHTML = 'üöÄ Run TIA Calculation';
                }
                return;
            }
        
            // 1. Calculate Future AADT (Compound Growth) - Gold Coast Formula
            const years = yearOpen - yearData;
            const futureAADT = curAADT * Math.pow((1 + growth / 100), years);
        
        // 2. Peak Hour Calculation (Gold Coast 80th Highest Hour Formula)
        // Excel: Peak = (AADT_direction * 15%) * 85%
        // Assuming single direction analysis or user provides directional AADT
        const peakHour80th = (futureAADT * 0.15) * 0.85;
        
        // 3. Off-Peak Hour (Gold Coast Formula)
        // Excel: Off-peak = ((AADT_direction - Peak) * 15%) * 45%
        const offPeakHour = ((futureAADT - peakHour80th) * 0.15) * 0.45;
        
        // 4. Hourly per lane
        const hourlyPerLane = peakHour80th / lanes;
        
        // 5. Volume per 5 minutes per lane
        const vol5MinPerLane = hourlyPerLane / 12;
        
        // 6. Split into LV and HV (Gold Coast uses CV% for commercial vehicles)
        const volHV = vol5MinPerLane * cvPercent;
        const volLV = vol5MinPerLane - volHV;
        
        // 7. Design Capacity Calculation (Gold Coast Formula)
        // Excel: =IF(ROUNDUP(0.15*AADT/2,0)<=500, 500, ROUNDUP(0.15*AADT/2,0))
        // This is for 30th highest hour estimation - assumes total AADT (both directions)
        const totalAADT = futureAADT * 2; // Approximate both directions
        const calc30thHour = Math.round((0.15 * totalAADT) / 2);
        const designCapacity = Math.max(calc30thHour, 500);
        
        // 8. VCR Calculation (Gold Coast: Volume / Capacity, no PCE adjustment)
        const vcr = peakHour80th / designCapacity;

        // 9. LOS Logic (Gold Coast thresholds)
        let los = "F";
        let losClass = "los-f";
        if (vcr <= 0.60) { los = "A"; losClass = "los-a"; }
        else if (vcr <= 0.70) { los = "B"; losClass = "los-b"; }
        else if (vcr <= 0.90) { los = "C"; losClass = "los-c"; }
        else if (vcr <= 0.95) { los = "D"; losClass = "los-d"; }
        else if (vcr <= 1.00) { los = "E"; losClass = "los-e"; }

        // 10. Update TIA Results
        const aadtEl = document.getElementById('tia_res_aadt');
        if (aadtEl) aadtEl.innerText = Math.round(futureAADT).toLocaleString();
        
        const volEl = document.getElementById('tia_res_vol');
        if (volEl) volEl.innerText = Math.round(peakHour80th).toLocaleString() + ' veh/hr';
        
        const vcrEl = document.getElementById('tia_res_vcr');
        if (vcrEl) vcrEl.innerText = vcr.toFixed(3);
        
        const badge = document.getElementById('tia_res_los_badge');
        if (badge) {
            badge.innerText = "LOS " + los;
            badge.className = "";
            badge.classList.add(losClass);
            badge.style.padding = "5px 10px"; badge.style.borderRadius = "4px"; badge.style.fontWeight = "bold";
        }

        // 11. Queue Calculation (Gold Coast TMR Formula)
        // Excel: ROUNDUP(vol5min_LV * lvFactor + vol5min_HV * hvFactor, 0)
        const queueFactors = [
            { id: 'q_2m', min: 2, lvFactor: 2.4, hvFactor: 8 },
            { id: 'q_5m', min: 5, lvFactor: 6, hvFactor: 20 },
            { id: 'q_10m', min: 10, lvFactor: 12, hvFactor: 40 },
            { id: 'q_15m', min: 15, lvFactor: 18, hvFactor: 60 },
            { id: 'q_30m', min: 30, lvFactor: 36, hvFactor: 120 }
        ];

        let queue5mMeters = 0;
        
        queueFactors.forEach(factor => {
            // Gold Coast Formula: (volLV * lvFactor) + (volHV * hvFactor)
            const qLength = (volLV * factor.lvFactor) + (volHV * factor.hvFactor);
            
            if (factor.id === 'q_5m') {
                queue5mMeters = qLength;
            }
            
            // Only update if element exists in DOM
            const qEl = document.getElementById(factor.id);
            if (qEl) {
                qEl.innerText = Math.round(qLength).toLocaleString();
            }
        });

        // 12. Directional queue tables (Northbound/Southbound) with peak + off-peak
        function buildDirectionalQueueTable(directionLabel, directionPeakHour, directionOffPeakHour, cvRatio, laneCount, projectLabel) {
            const hourlyPeak = directionPeakHour;
            const hourlyPeakCv = hourlyPeak * cvRatio;
            const hourlyOffPeak = directionOffPeakHour;
            const hourlyOffPeakCv = hourlyOffPeak * cvRatio;

            const hourlyPeakPerLane = hourlyPeak / laneCount;
            const hourlyPeakCvPerLane = hourlyPeakCv / laneCount;
            const hourlyOffPeakPerLane = hourlyOffPeak / laneCount;
            const hourlyOffPeakCvPerLane = hourlyOffPeakCv / laneCount;

            const peakVol5 = hourlyPeakPerLane / 12;
            const peakCvVol5 = hourlyPeakCvPerLane / 12;
            const offPeakVol5 = hourlyOffPeakPerLane / 12;
            const offPeakCvVol5 = hourlyOffPeakCvPerLane / 12;

            function queueLength(volume5Total, volume5Cv, lvFactor, hvFactor) {
                return (volume5Total * lvFactor) + (volume5Cv * hvFactor);
            }

            const q2Peak = queueLength(peakVol5, peakCvVol5, 2.4, 8);
            const q5Peak = queueLength(peakVol5, peakCvVol5, 6, 20);
            const q10Peak = queueLength(peakVol5, peakCvVol5, 12, 40);
            const q15Peak = queueLength(peakVol5, peakCvVol5, 18, 60);

            const q2Off = queueLength(offPeakVol5, offPeakCvVol5, 2.4, 8);
            const q5Off = queueLength(offPeakVol5, offPeakCvVol5, 6, 20);
            const q10Off = queueLength(offPeakVol5, offPeakCvVol5, 12, 40);
            const q15Off = queueLength(offPeakVol5, offPeakCvVol5, 18, 60);

            return `
                <div class="gc-detail-card">
                    <div class="gc-detail-title">Queue Length Estimation: ${projectLabel} - ${directionLabel}</div>
                    <table style="width:100%; border-collapse:collapse; font-size:0.88em;">
                        <tr style="background:#f4f6f8; font-weight:bold;">
                            <td style="padding:5px; border:1px solid #ddd;" colspan="2"></td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:center;">80th Highest Hour<br>(Peak traffic estimate)</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:center;">CV</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:center;">Off-peak traffic<br>(Estimated Highest Hour - 45% of remaining volume)</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:center;">CV</td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #ddd; font-weight:bold;" colspan="2">Hourly Average</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeak).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakCv).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeak).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakCv).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #ddd; font-weight:bold;" colspan="2">Hourly Average per Lane</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakPerLane).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakCvPerLane).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakPerLane).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakCvPerLane).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #ddd; font-weight:bold;" colspan="2">Queue length estimation</td>
                            <td style="padding:5px; border:1px solid #ddd;" colspan="4"></td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #ddd;">Volume</td>
                            <td style="padding:5px; border:1px solid #ddd;">per 5 mins</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(peakVol5).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(peakCvVol5).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(offPeakVol5).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(offPeakCvVol5).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #ddd;">2 mins. Queue</td>
                            <td style="padding:5px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(q2Peak).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd;"></td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right; background:#cfe8b3;">${Math.round(q2Off).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #ddd;">5 mins. Queue</td>
                            <td style="padding:5px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(q5Peak).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd;"></td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(q5Off).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #ddd;">10 mins. Queue</td>
                            <td style="padding:5px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(q10Peak).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd;"></td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(q10Off).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #ddd;">15 mins. Queue</td>
                            <td style="padding:5px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(q15Peak).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd;"></td>
                            <td style="padding:5px; border:1px solid #ddd; text-align:right;">${Math.round(q15Off).toLocaleString()}</td>
                            <td style="padding:5px; border:1px solid #ddd;"></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        const directionPeakHour = peakHour80th / 2;
        const directionOffPeakHour = offPeakHour / 2;
        const projectLabel = document.getElementById('tia_project').value || 'Gold Coast Site';
        const directionLabels = Array.isArray(window.currentGoldCoastDirectionLabels) && window.currentGoldCoastDirectionLabels.length === 2
            ? window.currentGoldCoastDirectionLabels
            : ['Northbound', 'Southbound'];
        const directionPreviewEl = document.getElementById('tiaDirectionLabelsPreview');
        if (directionPreviewEl) {
            directionPreviewEl.innerHTML = `<strong>Detected directions:</strong> ${directionLabels[0]} / ${directionLabels[1]}`;
        }
        const directionalHtml =
            buildDirectionalQueueTable(directionLabels[0], directionPeakHour, directionOffPeakHour, cvPercent, lanes, projectLabel) +
            buildDirectionalQueueTable(directionLabels[1], directionPeakHour, directionOffPeakHour, cvPercent, lanes, projectLabel);
        
        const queueSectionEl = document.getElementById('tiaDirectionalQueueSection');
        if (queueSectionEl) {
            queueSectionEl.innerHTML = directionalHtml;
        }

        // 13. Traffic Impact Analysis - VCR for different scenarios
        buildTrafficImpactAnalysis(directionLabels, directionPeakHour, directionOffPeakHour, designCapacity, lanes);

        // 14. Pedestrian Delay - Show assumptions
        const pedEl = document.getElementById('pedestrianDelaySection');
        if (pedEl) pedEl.style.display = 'block';

        // 17. Open collapsible sections to show results (skip detour/ped delay sections - user must configure)
        const gcResultsEl = document.getElementById('gcResultsSection');
        if (gcResultsEl) gcResultsEl.open = true;
        
        const gcQueueEl = document.getElementById('gcQueueSection');
        if (gcQueueEl) gcQueueEl.open = true;
        
        const gcImpactEl = document.getElementById('gcImpactSection');
        if (gcImpactEl) gcImpactEl.open = true;
        
        const gcPedEl = document.getElementById('gcPedestrianSection');
        if (gcPedEl) gcPedEl.open = true;

        // Pass data to unified calculation system
        const projectName = document.getElementById('tia_project').value || 'TIA Site';
        passToCalculations_TIA(projectName, curAADT, lanes, parseFloat(document.getElementById('tia_hv').value) || 5, yearData, growth, yearOpen);
        
        console.log('‚úÖ TIA calculation completed successfully!');
        
        } catch (error) {
            console.error('‚ùå Error in calculateTIA:', error);
            alert('‚ö†Ô∏è Calculation Error: ' + error.message);
        } finally {
            // Re-enable button
            const btn = document.getElementById('gcTiaCalcBtn');
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'üöÄ Run TIA Calculation';
            }
        }
    }

    function buildTrafficImpactAnalysis(directionLabels, dirPeakHour, dirOffPeakHour, designCap, laneCount) {
        const section = document.getElementById('trafficImpactAnalysisSection');
        const tbody = document.getElementById('tia_vcr_scenarios');
        const capDisplay = document.getElementById('tia_design_capacity');
        
        // Skip if elements don't exist
        if (!section || !tbody || !capDisplay) {
            console.warn('‚ö†Ô∏è Traffic Impact Analysis section elements not found, skipping VCR calculation');
            return;
        }
        
        section.style.display = 'block';
        capDisplay.textContent = Math.round(designCap).toLocaleString();

        // Calculate VCR for different scenarios
        const scenarios = [
            {
                label: directionLabels[0],
                peak: dirPeakHour / designCap,
                offPeak: dirOffPeakHour / designCap
            },
            {
                label: directionLabels[1],
                peak: dirPeakHour / designCap,
                offPeak: dirOffPeakHour / designCap
            },
            {
                label: `1 Lane Closure ${directionLabels[0]}`,
                peak: laneCount > 1 ? (dirPeakHour / (laneCount - 1)) / designCap : 'N/A',
                offPeak: laneCount > 1 ? (dirOffPeakHour / (laneCount - 1)) / designCap : 'N/A'
            },
            {
                label: `1 Lane Closure ${directionLabels[1]}`,
                peak: laneCount > 1 ? (dirPeakHour / (laneCount - 1)) / designCap : 'N/A',
                offPeak: laneCount > 1 ? (dirOffPeakHour / (laneCount - 1)) / designCap : 'N/A'
            },
            {
                label: 'Single Lane Reversible Flow',
                peak: (dirPeakHour * 2) / designCap,
                offPeak: (dirOffPeakHour * 2) / designCap
            }
        ];

        // Helper to get LOS color class
        function getVcrClass(vcr) {
            if (vcr === 'N/A') return '';
            if (vcr <= 0.60) return 'los-a';
            if (vcr <= 0.70) return 'los-b';
            if (vcr <= 0.90) return 'los-c';
            if (vcr <= 0.95) return 'los-d';
            if (vcr <= 1.00) return 'los-e';
            return 'los-f';
        }

        function formatVcr(vcr) {
            return vcr === 'N/A' ? 'N/A' : vcr.toFixed(2);
        }

        tbody.innerHTML = scenarios.map(s => `
            <tr>
                <td style="padding:8px; border:1px solid #ddd; font-weight:bold;">${s.label}</td>
                <td style="padding:8px; border:1px solid #ddd;"></td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center; ${s.peak !== 'N/A' ? 'background-color:' : ''}" class="${s.peak !== 'N/A' ? getVcrClass(s.peak) : ''}">${formatVcr(s.peak)}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center; ${s.offPeak !== 'N/A' ? 'background-color:' : ''}" class="${s.offPeak !== 'N/A' ? getVcrClass(s.offPeak) : ''}">${formatVcr(s.offPeak)}</td>
            </tr>
        `).join('');
    }

    function buildDetourRoutes(projectLabel) {
        const section = document.getElementById('detourRoutesSection');
        section.style.display = 'block';

        // Define multiple detour routes based on the screenshots
        const routes = [
            {
                name: 'Albatross Ave Traffic',
                distance: 0.4,
                controlledIntersections: 0,
                uncontrolledIntersections: 4,
                avgSpeed: 55
            },
            {
                name: 'Wave St Traffic',
                distance: 0.85,
                controlledIntersections: 0,
                uncontrolledIntersections: 5,
                avgSpeed: 55
            },
            {
                name: 'Surf St Traffic',
                distance: 0.9,
                controlledIntersections: 0,
                uncontrolledIntersections: 5,
                avgSpeed: 55
            }
        ];

        const html = routes.map(route => {
            const delayControlled = route.controlledIntersections * 60; // 60s per controlled
            const delayUncontrolled = route.uncontrolledIntersections * 10; // 10s per uncontrolled
            const travelTimeHrs = route.distance / route.avgSpeed;
            const travelTimeSec = travelTimeHrs * 3600;
            const totalTimeSec = travelTimeSec + delayControlled + delayUncontrolled;
            const totalTimeMin = (totalTimeSec / 60).toFixed(3);

            return `
                <div class="gc-detail-card">
                    <div class="gc-detail-title">Estimated Delay - Detour route (${route.name})</div>
                    <table style="width:100%; border-collapse:collapse; font-size:0.85em;">
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd; font-weight:bold;">Detour Route</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${route.distance} km</td>
                            <td style="padding:6px; border:1px solid #ddd;">(approx.)</td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;"># controlled intersections</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${route.controlledIntersections}</td>
                            <td style="padding:6px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;"># uncontrolled intersections</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${route.uncontrolledIntersections}</td>
                            <td style="padding:6px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;">Delay @ uncontrolled intersections</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${delayUncontrolled} s</td>
                            <td style="padding:6px; border:1px solid #ddd;">(assumed)</td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;">Delay @ controlled intersections</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${delayControlled} s</td>
                            <td style="padding:6px; border:1px solid #ddd;">(assumed)</td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;">avg. speed</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${route.avgSpeed.toFixed(2)} km/hr</td>
                            <td style="padding:6px; border:1px solid #ddd;">(assumed)</td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;">travel time</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${travelTimeHrs.toFixed(2)} hrs<br>${travelTimeSec.toFixed(0)} s</td>
                            <td style="padding:6px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr style="background:#fff3cd; font-weight:bold;">
                            <td style="padding:6px; border:1px solid #ddd;">total time</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${totalTimeSec.toFixed(0)} s<br>${totalTimeMin} minutes</td>
                            <td style="padding:6px; border:1px solid #ddd;">(Estimated)</td>
                        </tr>
                    </table>
                </div>
            `;
        }).join('');

        section.innerHTML = html;
    }

    function buildMaxPedestrianDelay() {
        const section = document.getElementById('maxPedestrianDelaySection');
        const tbody = document.getElementById('max_ped_delay_tbody');
        section.style.display = 'block';

        // Pedestrian delay example (Surf Parade, Broadbeach from screenshot)
        const location = 'Surf Parade, Broadbeach';
        const existingDist = 60;
        const detouredDist = 150;
        const controlledCrossings = 2;
        const uncontrolledCrossings = 0;
        const pedSpeed = 1.2; // m/s

        const existingTime = existingDist / pedSpeed;
        const detouredTime = detouredDist / pedSpeed + (controlledCrossings * 60) + (uncontrolledCrossings * 10);
        const addedDelay = detouredTime - existingTime;
        const addedDelayMins = (addedDelay / 60).toFixed(2);

        tbody.innerHTML = `
            <tr>
                <td style="padding:8px; border:1px solid #ddd; font-weight:bold;">${location}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${existingDist}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${detouredDist}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${controlledCrossings}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${uncontrolledCrossings}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${Math.round(existingTime)}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${Math.round(detouredTime)}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center; background:#fff3cd; font-weight:bold;">${Math.round(addedDelay)}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center; background:#ffc000; font-weight:bold;">${addedDelayMins}</td>
            </tr>
        `;
    }

    // New user-input-based functions for detour routes and pedestrian delay
    function generateDetourInputs() {
        const count = parseInt(document.getElementById('gc_detour_count').value);
        const container = document.getElementById('detourInputsSection');
        
        let html = '';
        for (let i = 1; i <= count; i++) {
            html += `
                <div style="margin:15px 0; padding:15px; background:#f8f9fa; border-radius:6px; border:1px solid #dee2e6;">
                    <h4 style="margin:0 0 10px 0; color:#1f5e63;">Detour Route ${i}</h4>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                        <div>
                            <label style="font-weight:bold; font-size:0.9em;">Route Name:</label>
                            <input type="text" id="detourName${i}" placeholder="e.g., Albatross Ave" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div>
                            <label style="font-weight:bold; font-size:0.9em;">Distance (km):</label>
                            <input type="number" id="detourDistance${i}" step="0.1" placeholder="e.g., 0.4" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div>
                            <label style="font-weight:bold; font-size:0.9em;">Controlled Intersections:</label>
                            <input type="number" id="detourControlled${i}" min="0" placeholder="0" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div>
                            <label style="font-weight:bold; font-size:0.9em;">Uncontrolled Intersections:</label>
                            <input type="number" id="detourUncontrolled${i}" min="0" placeholder="4" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div>
                            <label style="font-weight:bold; font-size:0.9em;">Avg Speed (km/hr):</label>
                            <input type="number" id="detourSpeed${i}" placeholder="55" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }

    function calculateDetourRoutes() {
        const count = parseInt(document.getElementById('gc_detour_count').value);
        const section = document.getElementById('detourRoutesSection');
        section.style.display = 'block';
        
        let html = '';
        for (let i = 1; i <= count; i++) {
            const name = document.getElementById(`detourName${i}`).value || `Route ${i}`;
            const distance = parseFloat(document.getElementById(`detourDistance${i}`).value) || 0;
            const controlled = parseInt(document.getElementById(`detourControlled${i}`).value) || 0;
            const uncontrolled = parseInt(document.getElementById(`detourUncontrolled${i}`).value) || 0;
            const avgSpeed = parseFloat(document.getElementById(`detourSpeed${i}`).value) || 55;
            
            const delayControlled = controlled * 60;
            const delayUncontrolled = uncontrolled * 10;
            const travelTimeHrs = distance / avgSpeed;
            const travelTimeSec = travelTimeHrs * 3600;
            const totalTimeSec = travelTimeSec + delayControlled + delayUncontrolled;
            const totalTimeMin = (totalTimeSec / 60).toFixed(3);
            
            html += `
                <div class="gc-detail-card">
                    <div class="gc-detail-title">Estimated Delay - Detour route (${name})</div>
                    <table style="width:100%; border-collapse:collapse; font-size:0.85em;">
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd; font-weight:bold;">Detour Route</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${distance} km</td>
                            <td style="padding:6px; border:1px solid #ddd;">(user input)</td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;"># controlled intersections</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${controlled}</td>
                            <td style="padding:6px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;"># uncontrolled intersections</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${uncontrolled}</td>
                            <td style="padding:6px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;">Delay @ uncontrolled intersections</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${delayUncontrolled} s</td>
                            <td style="padding:6px; border:1px solid #ddd;">(assumed 10s each)</td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;">Delay @ controlled intersections</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${delayControlled} s</td>
                            <td style="padding:6px; border:1px solid #ddd;">(assumed 60s each)</td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;">avg. speed</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${avgSpeed.toFixed(2)} km/hr</td>
                            <td style="padding:6px; border:1px solid #ddd;">(user input)</td>
                        </tr>
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;">travel time</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${travelTimeHrs.toFixed(2)} hrs<br>${travelTimeSec.toFixed(0)} s</td>
                            <td style="padding:6px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr style="background:#fff3cd; font-weight:bold;">
                            <td style="padding:6px; border:1px solid #ddd;">total time</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${totalTimeSec.toFixed(0)} s<br>${totalTimeMin} minutes</td>
                            <td style="padding:6px; border:1px solid #ddd;">(Estimated)</td>
                        </tr>
                    </table>
                </div>
            `;
        }
        
        section.innerHTML = html;
    }

    function calculateMaxPedestrianDelay() {
        const location = document.getElementById('ped_location').value || 'Unknown Location';
        const existingDist = parseFloat(document.getElementById('ped_existing_dist').value) || 0;
        const detouredDist = parseFloat(document.getElementById('ped_detoured_dist').value) || 0;
        const controlledCrossings = parseInt(document.getElementById('ped_controlled_cross').value) || 0;
        const uncontrolledCrossings = parseInt(document.getElementById('ped_uncontrolled_cross').value) || 0;
        const pedSpeed = 1.2; // m/s
        
        const existingTime = existingDist / pedSpeed;
        const detouredTime = detouredDist / pedSpeed + (controlledCrossings * 60) + (uncontrolledCrossings * 10);
        const addedDelay = detouredTime - existingTime;
        const addedDelayMins = (addedDelay / 60).toFixed(2);
        
        const section = document.getElementById('maxPedestrianDelaySection');
        section.style.display = 'block';
        const tbody = document.getElementById('max_ped_delay_tbody');
        tbody.innerHTML = `
            <tr>
                <td style="padding:8px; border:1px solid #ddd; font-weight:bold;">${location}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${existingDist}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${detouredDist}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${controlledCrossings}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${uncontrolledCrossings}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${Math.round(existingTime)}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center;">${Math.round(detouredTime)}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center; background:#fff3cd; font-weight:bold;">${Math.round(addedDelay)}</td>
                <td style="padding:8px; border:1px solid #ddd; text-align:center; background:#ffc000; font-weight:bold;">${addedDelayMins}</td>
            </tr>
        `;
    }

    // 2. Map & Embedded GeoJSON Loader
    let map;
    let embeddedGeoLayer;
    let gcSiteLayers = {};
    let selectedGcSiteId = null;
    let tiaSelectedLatLng = null;
    let gcDirectionLabelsBySite = {};
    window.currentGoldCoastDirectionLabels = ['Northbound', 'Southbound'];

    // ===== CONFIGURATION: External GeoJSON URL =====
    // To use Google Drive:
    // 1. Upload Gold Coast GeoJSON to Google Drive
    // 2. Right-click ‚Üí Share ‚Üí Change to "Anyone with the link"
    // 3. Copy the share link (e.g., https://drive.google.com/file/d/FILE_ID/view?usp=sharing)
    // 4. Convert to direct download link: https://drive.google.com/uc?export=download&id=FILE_ID
    // ================================================
    // Gold Coast GeoJSON - Loaded from separate GitHub file
    // ================================================

    async function getEmbeddedGeoJSON() { 
        // Use GitHub Gold Coast data (separate file)
        return await getGitHubGeoJSON();
    }

    function normalizeDirectionLabel(rawLabel, fallbackLabel) {
        if (!rawLabel) return fallbackLabel;
        const cleaned = String(rawLabel).trim();
        if (!cleaned) return fallbackLabel;

        if (/\bNB\b/i.test(cleaned) || /north/i.test(cleaned)) return 'Northbound';
        if (/\bSB\b/i.test(cleaned) || /south/i.test(cleaned)) return 'Southbound';
        if (/\bEB\b/i.test(cleaned) || /east/i.test(cleaned)) return 'Eastbound';
        if (/\bWB\b/i.test(cleaned) || /west/i.test(cleaned)) return 'Westbound';
        if (/\bgazettal\b/i.test(cleaned) && !/against/i.test(cleaned)) return 'Gazettal';
        if (/against\s+gazettal/i.test(cleaned)) return 'Against Gazettal';

        return cleaned;
    }

    function inferDirectionLabelsFromProps(props) {
        const pairCandidates = [
            ['DIR1', 'DIR2'],
            ['DIRECTION1', 'DIRECTION2'],
            ['DIRECTION_A', 'DIRECTION_B'],
            ['BOUND_1', 'BOUND_2'],
            ['PRIMARY_DIR', 'SECONDARY_DIR'],
            ['GAZETTAL_DIRECTION', 'AGAINST_GAZETTAL_DIRECTION']
        ];

        for (const [fieldA, fieldB] of pairCandidates) {
            if (props[fieldA] || props[fieldB]) {
                const labelA = normalizeDirectionLabel(props[fieldA], 'Northbound');
                const labelB = normalizeDirectionLabel(props[fieldB], 'Southbound');
                if (labelA !== labelB) return [labelA, labelB];
            }
        }

        const singleFieldCandidates = [
            'DIRECTIONS',
            'DIRECTION',
            'DIR',
            'TRAVEL_DIR',
            'GAZETTAL_DIRECTION'
        ];

        for (const field of singleFieldCandidates) {
            if (!props[field]) continue;
            const raw = String(props[field]);
            const parts = raw.split(/\s*(?:\/|,|&|\+| and )\s*/i).filter(Boolean);
            if (parts.length >= 2) {
                const labelA = normalizeDirectionLabel(parts[0], 'Northbound');
                const labelB = normalizeDirectionLabel(parts[1], 'Southbound');
                if (labelA !== labelB) return [labelA, labelB];
            }
        }

        const directionTextPool = Object.entries(props)
            .filter(([key, value]) => value != null && /(dir|direction|bound|gazettal)/i.test(key))
            .map(([, value]) => String(value));

        const foundLabels = [];
        directionTextPool.forEach(text => {
            if (/\bNB\b|north/i.test(text)) foundLabels.push('Northbound');
            if (/\bSB\b|south/i.test(text)) foundLabels.push('Southbound');
            if (/\bEB\b|east/i.test(text)) foundLabels.push('Eastbound');
            if (/\bWB\b|west/i.test(text)) foundLabels.push('Westbound');
            if (/against\s+gazettal/i.test(text)) foundLabels.push('Against Gazettal');
            if (/\bgazettal\b/i.test(text) && !/against/i.test(text)) foundLabels.push('Gazettal');
        });

        const unique = [...new Set(foundLabels)];
        if (unique.length >= 2) return [unique[0], unique[1]];

        return ['Northbound', 'Southbound'];
    }

    function renderGeoJSONOnMap(geoData) {
        if (embeddedGeoLayer) {
            map.removeLayer(embeddedGeoLayer);
        }

        gcSiteLayers = {};
        gcDirectionLabelsBySite = {};
        selectedGcSiteId = null;

        embeddedGeoLayer = L.geoJSON(geoData, {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 6,
                    fillColor: "#ff7800",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            },
            onEachFeature: function (feature, layer) {
                const props = feature.properties || {};
                const siteId = props.OBJECTID || props.id || feature.id || "N/A";
                const vpdRaw = props.VPD ?? props.ADT ?? props.AADT;
                const vpdValue = Number.isFinite(Number(vpdRaw)) ? Number(vpdRaw) : null;
                const vpdLabel = vpdValue !== null ? vpdValue : "N/A";
                const street = props.STREET || props.Road_Name || props.ROAD_NAME || "Unknown St";
                const loc = props.LOCATION || props.SITE_LOCATION || "";
                const surveyDate = props.SURVEY_DATE || props.SURVEYDATE || props.SURVEY_YEAR || props.COUNT_YEAR || props.COUNTYEAR || props.YEAR;
                const surveyYear = extractSurveyYear(surveyDate);
                const surveyLabel = surveyYear ? surveyYear : "N/A";
                const directionLabels = inferDirectionLabelsFromProps(props);
                gcDirectionLabelsBySite[String(siteId)] = directionLabels;

                layer.bindPopup(`
                    <strong>Site ID: ${siteId}</strong><br>
                    <strong>${street}</strong><br>
                    Loc: ${loc}<br>
                    VPD: ${vpdLabel}<br>
                    Count Year: ${surveyLabel}<br>
                    <button onclick="fillTIA('${siteId}', '${street}', ${vpdValue}, ${surveyYear || 'null'})" style="background-color: #4CAF50; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-top: 5px;">Use in TIA</button>
                `);

                gcSiteLayers[String(siteId)] = layer;
            }
        }).addTo(map);
    }

    function highlightGcSite(siteId) {
        if (selectedGcSiteId && gcSiteLayers[selectedGcSiteId]) {
            gcSiteLayers[selectedGcSiteId].setStyle({
                radius: 6,
                fillColor: "#ff7800",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        }

        const targetId = String(siteId);
        const layer = gcSiteLayers[targetId];
        if (!layer) return;

        selectedGcSiteId = targetId;
        layer.setStyle({
            radius: 9,
            fillColor: "#0056b3",
            color: "#003366",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.95
        });
        layer.openPopup();
    }

    async function loadEmbeddedGeoJSON() {
        try {
            initMap();
            const geoData = await getEmbeddedGeoJSON();
            renderGeoJSONOnMap(geoData);
        } catch (err) {
            console.error('Failed to load embedded GeoJSON:', err);
            alert('Failed to load embedded Gold Coast GeoJSON: ' + err.message);
        }
    }

    function initMap() {
        if(map) return; // already initialized
        // Center on Gold Coast
        map = L.map('interactiveMap').setView([-28.00, 153.40], 11);
        
        // Add OpenStreetMap tiles
        addTileLayerWithFallback(
            map,
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            { attribution: '&copy; OpenStreetMap contributors' },
            'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            { attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }
        );
    }

    // Helper to fill TIA form from Gold Coast Map
    function extractSurveyYear(value) {
        if (!value) return null;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        const text = String(value);
        const match = text.match(/\b(19|20)\d{2}\b/);
        if (match) return Number(match[0]);
        const parsed = new Date(text);
        if (!Number.isNaN(parsed.getTime())) return parsed.getFullYear();
        return null;
    }

    window.fillTIA = function(siteId, street, vpd, surveyYear) {
        document.getElementById('tia_project').value = `Site ${siteId} - ${street}`;
        selectedGcSiteId = String(siteId);
        window.currentGoldCoastDirectionLabels = gcDirectionLabelsBySite[String(siteId)] || ['Northbound', 'Southbound'];
        const directionPreviewEl = document.getElementById('tiaDirectionLabelsPreview');
        if (directionPreviewEl) {
            directionPreviewEl.innerHTML = `<strong>Detected directions:</strong> ${window.currentGoldCoastDirectionLabels[0]} / ${window.currentGoldCoastDirectionLabels[1]}`;
        }
        if (Number.isFinite(Number(vpd))) {
            document.getElementById('tia_aadt').value = vpd;
        }
        if (Number.isFinite(Number(surveyYear))) {
            document.getElementById('tia_year_data').value = surveyYear;
        }
        const layer = gcSiteLayers[String(siteId)];
        if (layer && typeof layer.getLatLng === 'function') {
            tiaSelectedLatLng = layer.getLatLng();
            
            // Display coordinates and Google Maps link
            const lat = tiaSelectedLatLng.lat;
            const lon = tiaSelectedLatLng.lng;
            document.getElementById('goldCoastCoordinates').innerText = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            document.getElementById('goldCoastMapLink').href = `https://www.google.com/maps?q=${lat},${lon}`;
            document.getElementById('goldCoastCoordDisplay').style.display = 'block';
        }
        // Switch tab
        document.querySelector("button[onclick*='tab-tia']").click();

        const aadtInput = document.getElementById('tia_aadt');
        if (aadtInput) {
            aadtInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            aadtInput.focus();
            aadtInput.style.transition = 'background-color 0.3s';
            aadtInput.style.backgroundColor = '#ffffcc';
            setTimeout(() => {
                aadtInput.style.backgroundColor = '';
            }, 1000);
        }
    };

    // Helper to fill TIA form from TMR site data
    window.fillTIAFromTMR = function(siteId) {
        const site = sitesData[siteId];
        if (!site) {
            alert('Site data not found');
            return;
        }

        // Calculate AADT from hourly data
        const gazData = site.directions['GAZETTAL'] || new Array(24).fill(0);
        const agData = site.directions['AGAINST GAZETTAL'] || new Array(24).fill(0);
        
        // Sum both directions for total daily volume
        const totalDaily = gazData.reduce((sum, val) => sum + val, 0) + 
                          agData.reduce((sum, val) => sum + val, 0);
        
        // AADT is essentially the daily total (already represents an average day)
        const aadt = Math.round(totalDaily);

        // Fill TIA form
        document.getElementById('tia_project').value = `${siteId} - ${site.road_name || 'TMR Site'}`;
        window.currentGoldCoastDirectionLabels = ['Gazettal', 'Against Gazettal'];
        const directionPreviewEl = document.getElementById('tiaDirectionLabelsPreview');
        if (directionPreviewEl) {
            directionPreviewEl.innerHTML = `<strong>Detected directions:</strong> ${window.currentGoldCoastDirectionLabels[0]} / ${window.currentGoldCoastDirectionLabels[1]}`;
        }
        document.getElementById('tia_aadt').value = aadt;
        
        // Optional: set year if available in data, otherwise keep default
        // document.getElementById('tia_year_data').value = 2020; // Could be extracted from data
        
        // Show confirmation (data saved, stay on TMR tab)
        alert(`TMR site "${siteId}" data saved to TIA\n\nCalculated AADT: ${aadt.toLocaleString()} vehicles/day\n\nSwitch to "Gold coast" tab to use this data in TIA analysis.`);
    };

    // Initialize maps when tabs are clicked (optimized with lazy loading)
    let goldCoastMapInitialized = false;
    let ipswichMapInitialized = false;
    let loganMapInitialized = false;
    let toowoombaMapInitialized = false;
    let tmrMapInitialized = false;
    
    const originalOpenTab = window.openTab;
    window.openTab = function(evt, tabName) {
        // Optimized tab switching
        const tabcontent = document.getElementsByClassName("tab-content");
        const tablinks = document.getElementsByClassName("tab-button");
        
        // Hide all tabs and remove active class
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].classList.remove("active");
        }
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        
        // Show the active tab
        document.getElementById(tabName).style.display = "block";
        document.getElementById(tabName).classList.add("active");
        if(evt) evt.currentTarget.classList.add("active");

        // Lazy initialize maps only when needed
        if(tabName === 'tab-tia' && !goldCoastMapInitialized) {
            goldCoastMapInitialized = true;
            setTimeout(loadEmbeddedGeoJSON, 100);
        } else if (tabName === 'tab-tia' && map) {
            map.invalidateSize();
        }
        
        if (tabName === 'tab-hourly' && hourlyMap) {
            hourlyMap.invalidateSize();
        }

        if (tabName === 'Ipswich') {
            if (!ipswichMapInitialized) {
                ipswichMapInitialized = true;
                initIpswich();
            } else if (ipswichMapInstance) {
                ipswichMapInstance.invalidateSize();
            }
        }

        if (tabName === 'Logan') {
            if (!loganMapInitialized) {
                loganMapInitialized = true;
                initLogan();
            } else if (loganMapInstance) {
                loganMapInstance.invalidateSize();
            }
        }

        if (tabName === 'tab-toowoomba') {
            if (!toowoombaMapInitialized) {
                toowoombaMapInitialized = true;
                initToowoomba();
            } else if (toowoombaMapInstance) {
                toowoombaMapInstance.invalidateSize();
            }
        }

        if (tabName === 'tab-traffic-analysis') {
            // Initialize S2 comparison on first load
            updateS2Comparison();
        }
    };
</script>
<!-- Gold Coast GeoJSON Data loaded from GitHub -->
<script>
    // Global variable to store Gold Coast data for searching
    window.goldCoastDataRaw = null;

    // 1. Modify the existing loadEmbeddedGeoJSON to save data globally
    const originalLoadGeo = window.loadEmbeddedGeoJSON;
    window.loadEmbeddedGeoJSON = async function() {
        try {
            initMap();
            const geoData = await getEmbeddedGeoJSON();
            window.goldCoastDataRaw = geoData; // Store globally for search
            renderGeoJSONOnMap(geoData);
        } catch (err) {
            console.error("Error storing GC data", err);
        }
    };

    // 2. UI Functions
    function closeLandingPage() {
        document.getElementById('landingPage').classList.add('hidden-overlay');
    }

    function goToHome() {
        document.getElementById('landingPage').classList.remove('hidden-overlay');
    }

    // ==================== UNIFIED TRAFFIC ANALYSIS FUNCTIONS ====================

    // Scenario Selection
    function selectScenario(scenarioNum) {
        const s1Panel = document.getElementById('scenario-1-panel');
        const s2Panel = document.getElementById('scenario-2-panel');
        
        if (scenarioNum === 1) {
            s1Panel.style.display = 'block';
            s2Panel.style.display = 'none';
            scrollToElement('scenario-1-panel');
        } else {
            s1Panel.style.display = 'none';
            s2Panel.style.display = 'block';
            scrollToElement('scenario-2-panel');
        }
    }

    function scrollToElement(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // SCENARIO 1: AUTOMATIC ANALYSIS
    function updateS1RoadCapacity() {
        const roadType = document.getElementById('s1_aadt_road_type').value;
        let capacity = 1800;
        
        switch(roadType) {
            case 'freeway-100': capacity = 2100; break;
            case 'highway-multi': capacity = 1800; break;
            case 'arterial': capacity = 1400; break;
            case 'urban-street': capacity = 1000; break;
        }
        
        document.getElementById('s1_aadt_cap').value = capacity;
    }

    function calculateScenario1() {
        const aadt = parseFloat(document.getElementById('s1_aadt_val').value) || 0;
        const dataYear = parseInt(document.getElementById('s1_aadt_year_data').value) || 2024;
        const projYear = parseInt(document.getElementById('s1_aadt_year_proj').value) || 2031;
        const growth = parseFloat(document.getElementById('s1_aadt_growth').value) || 3.0;
        const hv = parseFloat(document.getElementById('s1_aadt_hv').value) || 5.0;
        const lanes = parseInt(document.getElementById('s1_aadt_lanes').value) || 2;
        const capPerLane = parseFloat(document.getElementById('s1_aadt_cap').value) || 1800;
        const kFactor = parseFloat(document.getElementById('s1_aadt_k').value) || 10;
        const dirSplit = parseFloat(document.getElementById('s1_aadt_d').value) || 60;

        if (aadt <= 0) {
            alert('Please enter a valid AADT value');
            return;
        }

        // Calculate future AADT
        const years = projYear - dataYear;
        const futureAADT = aadt * Math.pow(1 + (growth / 100), years);
        
        // Calculate peak hour volume
        const peakHourVol = (futureAADT * (kFactor / 100) * (dirSplit / 100));
        
        // Calculate V/C ratio
        const designCapacity = lanes * capPerLane;
        const vcRatio = peakHourVol / designCapacity;
        
        // Determine Level of Service
        let los = 'F';
        if (vcRatio < 0.60) los = 'A';
        else if (vcRatio < 0.75) los = 'B';
        else if (vcRatio < 0.90) los = 'C';
        else if (vcRatio < 1.00) los = 'D';
        else los = 'E-F';

        // Display results
        document.getElementById('s1_res_fut_aadt').textContent = Math.round(futureAADT).toLocaleString();
        document.getElementById('s1_res_dhv').textContent = Math.round(peakHourVol).toLocaleString() + ' vph';
        document.getElementById('s1_res_vc').textContent = vcRatio.toFixed(2);
        document.getElementById('s1_res_los').textContent = los;

        // Calculate queue lengths for various durations
        const queueDurations = [2, 5, 10, 15, 30];
        const queueTable = document.getElementById('s1_queue_table');
        queueTable.innerHTML = '';

        queueDurations.forEach(mins => {
            const queueVol = peakHourVol * (mins / 60);
            const queueLength = Math.round(queueVol * 5); // Assuming 5m per vehicle
            
            const row = queueTable.insertRow();
            row.innerHTML = `
                <td>${mins} minutes</td>
                <td><strong>${queueLength.toLocaleString()} m</strong></td>
            `;
        });
    }

    // SCENARIO 2: CUSTOM INPUTS
    function updateS2Comparison() {
        const devContext = parseFloat(document.getElementById('s2_dev_context').value) || 7.4;
        const dwellings = parseInt(document.getElementById('s2_dwellings').value) || 50;
        const roadAssign = parseFloat(document.getElementById('s2_road_assign').value) || 100;
        const percentRef = parseFloat(document.getElementById('s2_percent_ref').value) || 50;
        
        // Method 1: Trip Generation
        const tripGenAADT = Math.round((devContext * dwellings * (roadAssign / 100)));
        document.getElementById('s2_trip_gen_result').textContent = tripGenAADT.toLocaleString() + ' vehicles';
        
        // Method 2: Percentage (need reference AADT - placeholder for now)
        // In actual implementation, this should come from selected site
        const referenceAADT = 10000; // Placeholder
        const percentAADT = Math.round(referenceAADT * (percentRef / 100));
        document.getElementById('s2_percent_result').textContent = percentAADT.toLocaleString() + ' vehicles';
        
        // Show greater of both
        const greaterVolume = Math.max(tripGenAADT, percentAADT);
        document.getElementById('s2_greater_volume').textContent = greaterVolume.toLocaleString() + ' vehicles';
    }

    function calculateScenario2() {
        const selectedAADT = parseInt(document.getElementById('s2_greater_volume').textContent) || 0;
        
        if (selectedAADT <= 0) {
            alert('Please calculate the volume first');
            return;
        }

        // Calculate peak hour volume (12% of AADT is typical peak hour)
        const peakHourVol = Math.round(selectedAADT * 0.12);
        
        // Calculate queue lengths
        const queueDurations = [2, 5, 10, 15, 30];
        const queueTable = document.getElementById('s2_queue_table');
        queueTable.innerHTML = '';

        queueDurations.forEach(mins => {
            const queueVol = peakHourVol * (mins / 60);
            const queueLength = Math.round(queueVol * 5); // 5m per vehicle
            
            const row = queueTable.insertRow();
            row.innerHTML = `
                <td>${mins} minutes</td>
                <td><strong>${queueLength.toLocaleString()} m</strong></td>
            `;
        });

        // Display results
        document.getElementById('s2_results_placeholder').style.display = 'none';
        document.getElementById('s2_results_container').style.display = 'block';
        document.getElementById('s2_res_aadt').textContent = selectedAADT.toLocaleString() + ' vehicles';
        document.getElementById('s2_res_peak').textContent = peakHourVol.toLocaleString() + ' vph';
        document.getElementById('s2_res_status').textContent = 'Estimated Volume';
    }

    function handleEnter(e) {
        if(e.key === 'Enter') executeSmartSearch();
    }

    function updateStatus(msg) {
        document.getElementById('searchStatus').textContent = msg;
    }

    function safeParseJson(rawText) {
        // Some datasets contain unquoted NaN values, which break JSON.parse.
        const sanitized = rawText.replace(/\bNaN\b/g, 'null');
        return JSON.parse(sanitized);
    }

    async function ensureSearchDataLoaded() {
        if (!window.goldCoastDataRaw) await window.loadEmbeddedGeoJSON();

        if (typeof ipswichDataGlobal === 'undefined' || !ipswichDataGlobal) {
            try {
                console.log('Loading Ipswich data...');
                const response = await fetch('https://raw.githubusercontent.com/crsanju/Cromton_Traffic_Analysis/main/Ipswich.geojson');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const rawText = await response.text();
                ipswichDataGlobal = safeParseJson(rawText);
         
                console.log('‚úì Ipswich data loaded');
            } catch (error) {
                console.error('‚úó Failed to load Ipswich data:', error);
            }
        }

        if (typeof loganDataGlobal === 'undefined' || !loganDataGlobal) {
            try {
                const url = 'https://raw.githubusercontent.com/crsanju/Cromton_Traffic_Analysis/main/logan.geojson';
                console.log('Loading Logan data from:', url);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: File not found at ${url}`);
                }
                loganDataGlobal = await response.json();
                console.log('‚úì Logan data loaded successfully:', loganDataGlobal.features ? loganDataGlobal.features.length : 0, 'features');
            } catch (error) {
                console.error('‚úó Failed to load Logan data:', error);
                console.warn('Using empty Logan dataset as fallback');
                loganDataGlobal = { type: 'FeatureCollection', features: [] };
            }
        }

        if (typeof toowoombaDataGlobal === 'undefined' || !toowoombaDataGlobal) {
            try {
                const url = 'https://raw.githubusercontent.com/crsanju/Cromton_Traffic_Analysis/main/toowoomba.geojson';
                console.log('Loading Toowoomba data from:', url);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: File not found at ${url}`);
                }
                toowoombaDataGlobal = await response.json();
                console.log('‚úì Toowoomba data loaded successfully:', toowoombaDataGlobal.features ? toowoombaDataGlobal.features.length : 0, 'features');
            } catch (error) {
                console.error('‚úó Failed to load Toowoomba data:', error);
                console.warn('Using empty Toowoomba dataset as fallback');
                toowoombaDataGlobal = { type: 'FeatureCollection', features: [] };
            }
        }
    }

    // 3. Main Search Logic
    const MAPS_CO_API_KEY = '';
    const IS_FILE_ORIGIN = window.location.protocol === 'file:';
    const HOUSEHOLD_TRIP_RATE = 2.5 * 4.5;

    function normalizeSearchQuery(raw) {
        return String(raw || '')
            .replace(/\s+/g, ' ')
            .trim();
    }

    function parseCoordinates(raw) {
        const text = normalizeSearchQuery(raw);
        const match = text.match(/^(-?\d+(?:\.\d+)?)[,;\s]+(-?\d+(?:\.\d+)?)$/);
        if (!match) return null;

        const lat = parseFloat(match[1]);
        const lon = parseFloat(match[2]);
        if (Number.isNaN(lat) || Number.isNaN(lon)) return null;
        if (lat < -90 || lat > 90 || lon < -180 || lon > 180) return null;
        return { lat, lon, roadName: null };
    }

    async function geocodeWithNominatim(query) {
        try {
            if (IS_FILE_ORIGIN) return null;
            const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=5&addressdetails=1&countrycodes=au&q=${encodeURIComponent(query)}`;
            const response = await fetch(url, {
                headers: {
                    'Accept-Language': 'en-AU,en;q=0.9'
                }
            });

            if (!response.ok) return null;
            const data = await response.json();
            if (!Array.isArray(data) || data.length === 0) return null;

            const address = data[0].address || {};
            const roadName = address.road || address.pedestrian || address.footway || address.cycleway || address.neighbourhood || null;
            return {
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon),
                roadName: roadName
            };
        } catch (error) {
            console.warn('Nominatim geocoding failed:', error);
            return null;
        }
    }

    async function geocodeWithMapsCo(query) {
        try {
            if (!MAPS_CO_API_KEY) return null;
            const url = `https://geocode.maps.co/search?q=${encodeURIComponent(query)}&country=au&api_key=${encodeURIComponent(MAPS_CO_API_KEY)}`;
            const response = await fetch(url);
            if (!response.ok) return null;
            const data = await response.json();
            if (!Array.isArray(data) || data.length === 0) return null;
            const address = data[0].address || {};
            const roadName = address.road || address.pedestrian || address.neighbourhood || null;
            return {
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon),
                roadName: roadName
            };
        } catch (error) {
            console.warn('Maps.co geocoding failed:', error);
            return null;
        }
    }

    async function geocodeWithPhoton(query) {
        try {
            const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5&lang=en&lat=-27.4698&lon=153.0251`;
            const response = await fetch(url);
            if (!response.ok) return null;
            const data = await response.json();
            const feature = data && data.features && data.features[0];
            const coords = feature && feature.geometry && feature.geometry.coordinates;
            if (!coords || coords.length < 2) return null;
            const props = feature.properties || {};
            const roadName = props.street || props.name || props.locality || null;
            return { lat: coords[1], lon: coords[0], roadName: roadName };
        } catch (error) {
            console.warn('Photon geocoding failed:', error);
            return null;
        }
    }

    async function geocodeLocation(query) {
        const normalized = normalizeSearchQuery(query);
        if (!normalized) return null;

        const directCoords = parseCoordinates(normalized);
        if (directCoords) return directCoords;

        const photon = await geocodeWithPhoton(`${normalized} Australia`);
        if (photon) return photon;

        const mapsCo = await geocodeWithMapsCo(`${normalized} Australia`);
        if (mapsCo) return mapsCo;

        const nominatim = await geocodeWithNominatim(`${normalized} Australia`);
        if (nominatim) return nominatim;

        return await geocodeWithPhoton(`${normalized} Australia`);
    }

    async function executeSmartSearch() {
        const query = document.getElementById('landingSearchInput').value;
        if (!normalizeSearchQuery(query)) return updateStatus("Please enter a location.");

        updateStatus("üîç Locating...");

        try {
            const coords = await geocodeLocation(query);

            if (!coords) {
                return updateStatus("‚ùå Location not found. Try a broader search or add suburb/state.");
            }

            updateStatus("üìç Location found. Finding nearest traffic site...");

            // Ensure data is loaded
            await ensureSearchDataLoaded();

            findNearestAndRedirect(coords.lat, coords.lon, coords.roadName);

        } catch (error) {
            console.error(error);
            const message = error && error.message ? error.message : 'Unknown error';
            updateStatus(`‚ö†Ô∏è Search failed: ${message}`);
        }
    }

    function useCurrentLocation() {
        if (!navigator.geolocation) return updateStatus("Geolocation not supported by your browser.");
        
        updateStatus("üõ∞Ô∏è Acquiring GPS...");
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                await ensureSearchDataLoaded();
                findNearestAndRedirect(position.coords.latitude, position.coords.longitude);
            },
            () => {
                updateStatus("‚ö†Ô∏è Unable to retrieve your location.");
            }
        );
    }

    // 4. Distance Calculation (Haversine)
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; // Radius of the earth in km
        var dLat = deg2rad(lat2-lat1);
        var dLon = deg2rad(lon2-lon1); 
        var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat1)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var d = R * c; 
        return d;
    }

    function deg2rad(deg) { return deg * (Math.PI/180); }

    // 5. Nearest Neighbor Logic
    function normalizeRoadName(value) {
        return String(value || '')
            .replace(/[^a-z0-9\s]/gi, ' ')
            .replace(/\s+/g, ' ')
            .trim()
            .toLowerCase();
    }

    function roadMatches(queryRoad, candidateRoad) {
        const query = normalizeRoadName(queryRoad);
        const candidate = normalizeRoadName(candidateRoad);
        if (!query || !candidate) return false;
        return candidate.includes(query) || query.includes(candidate);
    }

    function getSiteRoadName(sourceType, nearestSite) {
        if (!nearestSite) return '';
        if (sourceType === 'TMR') {
            return nearestSite.road_name || nearestSite.description || '';
        }
        const props = nearestSite.properties || {};
        if (sourceType === 'GC') {
            return props.STREET || props.Road_Name || props.ROAD_NAME || props.Location || '';
        }
        if (sourceType === 'IPSWICH') {
            return props["Road Name"] || props.Description || props.ROAD_NAME || props.Road_Name || props.STREET || props.Location || props.SITE_LOCATION || '';
        }
        if (sourceType === 'LOGAN') {
            return props.STREET_NAME || props.RoadName || props.ROAD_NAME || props.STREET || props.COUNTER_LOCATION_BETWEEN || props.COMMENTS || '';
        }
        if (sourceType === 'TOOWOOMBA') {
            return props.Road_Name || props.ROAD_NAME || props.Street || props.STREET || props.Location || props.COUNTER_LOCATION || '';
        }
        return '';
    }

    function getSiteAadt(sourceType, nearestSite) {
        if (!nearestSite) return 0;
        if (sourceType === 'TMR') {
            const gazData = nearestSite.directions && nearestSite.directions['GAZETTAL'] ? nearestSite.directions['GAZETTAL'] : [];
            const agData = nearestSite.directions && nearestSite.directions['AGAINST GAZETTAL'] ? nearestSite.directions['AGAINST GAZETTAL'] : [];
            const totalDaily = gazData.reduce((sum, val) => sum + (Number(val) || 0), 0) +
                agData.reduce((sum, val) => sum + (Number(val) || 0), 0);
            return Math.round(totalDaily);
        }

        const props = nearestSite.properties || {};
        if (sourceType === 'GC') {
            const vpdRaw = props.VPD ?? props.ADT ?? props.AADT;
            return Number.isFinite(Number(vpdRaw)) ? Number(vpdRaw) : 0;
        }
        if (sourceType === 'IPSWICH') {
            let aadt = props["Average Daily Traffic Adt Vehicles Per Day"] || props.ADT || props.AADT || 0;
            if (!aadt || aadt === 0) {
                const am = props["Weekday Avg AM Peak Flow Vehicles Per Hour"] || 0;
                const pm = props["Weekday Avg PM Peak Flow Vehicles Per Hour"] || 0;
                const maxPeak = Math.max(am, pm);
                if (maxPeak > 0) aadt = maxPeak * 10;
            }
            return Number(aadt) || 0;
        }
        if (sourceType === 'LOGAN') {
            let aadt = props.AADT ?? props.ADT ?? props.AAWT ?? props.Volume;
            if (aadt == null || isNaN(aadt)) {
                const vol1 = Number(props.VOL1 || 0);
                const vol2 = Number(props.VOL2 || 0);
                aadt = (isNaN(vol1) ? 0 : vol1) + (isNaN(vol2) ? 0 : vol2);
            }
            return Number(aadt) || 0;
        }
        if (sourceType === 'TOOWOOMBA') {
            let aadt = props.AADT ?? props.ADT ?? props.adt ?? props.Volume ?? props.Count;
            if (aadt == null || isNaN(aadt)) {
                aadt = 0;
            }
            return Number(aadt) || 0;
        }
        return 0;
    }

    let mismatchContext = null;

    function showMismatchPanel(queryRoadName, sourceType, nearestSite) {
        if (!queryRoadName) return false;
        const siteRoad = getSiteRoadName(sourceType, nearestSite);
        if (!siteRoad) return false;
        if (roadMatches(queryRoadName, siteRoad)) return false;

        mismatchContext = {
            queryRoadName: queryRoadName,
            sourceType: sourceType,
            nearestSite: nearestSite,
            baseAadt: getSiteAadt(sourceType, nearestSite),
            siteRoad: siteRoad
        };

        const summary = document.getElementById('mismatchSummary');
        summary.textContent = `"${queryRoadName}" is not in the database. Nearest known road: ${siteRoad}.`;

        document.getElementById('mismatchPercent').value = 100;
        document.getElementById('mismatchHouseholds').value = 0;
        document.getElementById('mismatchResult').textContent = '';

        document.getElementById('mismatchPanel').classList.remove('hidden-overlay');
        return true;
    }

    function closeMismatchPanel() {
        document.getElementById('mismatchPanel').classList.add('hidden-overlay');
        mismatchContext = null;
    }

    function applyMismatchInputs() {
        if (!mismatchContext) return;

        let percent = parseFloat(document.getElementById('mismatchPercent').value);
        if (!Number.isFinite(percent) || percent < 0) percent = 100;

        let households = parseFloat(document.getElementById('mismatchHouseholds').value);
        if (!Number.isFinite(households) || households < 0) households = 0;

        const percentAadt = mismatchContext.baseAadt * (percent / 100);
        const manualAadt = households * HOUSEHOLD_TRIP_RATE;
        const chosenAadt = Math.max(percentAadt, manualAadt);

        if (Math.abs(percentAadt - manualAadt) > 500) {
            document.getElementById('mismatchResult').textContent = 'Warning: Difference between AADT and manual calculation is greater than 500.';
        } else {
            document.getElementById('mismatchResult').textContent = '';
        }

        closeMismatchPanel();
        closeLandingPage();

        document.querySelector("button[onclick*='tab-aadt']").click();
        const aadtInput = document.getElementById('aadt_val');
        if (aadtInput) {
            aadtInput.value = Math.round(chosenAadt);
        }
        calculateAADTLogic();
    }

    function findNearestAndRedirect(targetLat, targetLon, queryRoadName) {
        let nearestSite = null;
        let minDistance = Infinity;
        let sourceType = ''; // 'TMR' or 'GC'

        // A. Search TMR Data (sitesData global variable)
        const tmrEntries = Object.entries(sitesData);
        for (const [id, site] of tmrEntries) {
            if (site.latitude && site.longitude) {
                const dist = getDistanceFromLatLonInKm(targetLat, targetLon, site.latitude, site.longitude);
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestSite = { id: id, ...site };
                    sourceType = 'TMR';
                }
            }
        }

        // B. Search Gold Coast Data (window.goldCoastDataRaw)
        if (window.goldCoastDataRaw && window.goldCoastDataRaw.features) {
            window.goldCoastDataRaw.features.forEach(feature => {
                const geometry = feature && feature.geometry;
                const coords = geometry && Array.isArray(geometry.coordinates) ? geometry.coordinates : null;
                if (!coords || coords.length < 2) return;

                // GeoJSON uses [Long, Lat]
                const dist = getDistanceFromLatLonInKm(targetLat, targetLon, coords[1], coords[0]);
                
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestSite = feature;
                    sourceType = 'GC';
                }
            });
        }

        // C. Search Ipswich Data
        if (typeof ipswichDataGlobal !== 'undefined' && ipswichDataGlobal && ipswichDataGlobal.features) {
            ipswichDataGlobal.features.forEach(feature => {
                const coords = feature.geometry && feature.geometry.coordinates;
                if (coords) {
                    const dist = getDistanceFromLatLonInKm(targetLat, targetLon, coords[1], coords[0]);
                    if (dist < minDistance) {
                        minDistance = dist;
                        nearestSite = feature;
                        sourceType = 'IPSWICH';
                    }
                }
            });
        }

        // D. Search Logan Data
        if (typeof loganDataGlobal !== 'undefined' && loganDataGlobal && loganDataGlobal.features) {
            loganDataGlobal.features.forEach(feature => {
                const geometry = feature && feature.geometry;
                const coords = geometry && Array.isArray(geometry.coordinates) ? geometry.coordinates : null;
                if (!coords || coords.length < 2) return;

                const dist = getDistanceFromLatLonInKm(targetLat, targetLon, coords[1], coords[0]);
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestSite = feature;
                    sourceType = 'LOGAN';
                }
            });
        }

        // E. Search Toowoomba Data
        if (typeof toowoombaDataGlobal !== 'undefined' && toowoombaDataGlobal && toowoombaDataGlobal.features) {
            toowoombaDataGlobal.features.forEach(feature => {
                const geometry = feature && feature.geometry;
                if (!geometry || !geometry.coordinates) return;

                let lat, lon;
                if (geometry.type === 'Point') {
                    lon = geometry.coordinates[0];
                    lat = geometry.coordinates[1];
                } else if (geometry.type === 'LineString' && geometry.coordinates.length > 0) {
                    // Use midpoint for LineString
                    const coords = geometry.coordinates;
                    const midIdx = Math.floor(coords.length / 2);
                    lon = coords[midIdx][0];
                    lat = coords[midIdx][1];
                } else {
                    return;
                }

                const dist = getDistanceFromLatLonInKm(targetLat, targetLon, lat, lon);
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestSite = feature;
                    sourceType = 'TOOWOOMBA';
                }
            });
        }

        // C. Redirect User
        if (nearestSite) {
            if (showMismatchPanel(queryRoadName, sourceType, nearestSite)) {
                return;
            }

            closeLandingPage();
            
            if (sourceType === 'TMR') {
                // Switch to TMR Tab
                document.querySelector("button[onclick*='tab-hourly']").click();
                
                // Use existing function to select site
                // Adding a small delay to ensure tab visibility
                setTimeout(() => {
                    selectSiteFromMap(nearestSite.id);
                    if (hourlyMap && nearestSite.latitude && nearestSite.longitude) {
                        hourlyMap.setView([nearestSite.latitude, nearestSite.longitude], 15);
                        highlightHourlyMarker(nearestSite.id);
                    }
                    alert(`Nearest Site Found (${minDistance.toFixed(2)}km away):\n${nearestSite.id} - ${nearestSite.road_name}`);
                }, 500);

            } else if (sourceType === 'GC') {
                // Switch to GC/TIA Tab
                const props = nearestSite.properties;
                const siteId = props.OBJECTID || props.id;
                const street = props.STREET || props.Road_Name || "Unknown";
                const vpd = props.VPD || props.ADT || props.AADT || 0;
                
                // Need to extract year logic similar to render function
                let year = 2020; // default
                const dateStr = props.SURVEY_DATE || props.SURVEYDATE || props.YEAR;
                if(dateStr) {
                    const match = String(dateStr).match(/\b(19|20)\d{2}\b/);
                    if(match) year = Number(match[0]);
                }

                document.querySelector("button[onclick*='tab-tia']").click();

                setTimeout(() => {
                    fillTIA(siteId, street, vpd, year);
                    alert(`Nearest Site Found (${minDistance.toFixed(2)}km away):\nGold Coast Site: ${street}`);
                    
                    // Center map on the site
                    if(map && nearestSite.geometry && Array.isArray(nearestSite.geometry.coordinates)) {
                        const coords = nearestSite.geometry.coordinates;
                        if (coords.length >= 2) {
                            map.setView([coords[1], coords[0]], 15);
                        }
                    }

                    highlightGcSite(siteId);
                }, 500);
            } else if (sourceType === 'IPSWICH') {
                document.querySelector("button[onclick*='Ipswich']").click();

                setTimeout(() => {
                    const props = nearestSite.properties || {};
                    const id = props.Site || props.SITE || props.OBJECTID || props.id || nearestSite.id;
                    const name = props.Description || props.ROAD_NAME || props.Road_Name || props.STREET || props.Location || props.SITE_LOCATION || 'Ipswich Site';
                    selectIpswichSite(id);
                    alert(`Nearest Site Found (${minDistance.toFixed(2)}km away):\nIpswich: ${name}`);
                }, 500);
            } else if (sourceType === 'LOGAN') {
                document.querySelector("button[onclick*='Logan']").click();

                setTimeout(() => {
                    const props = nearestSite.properties || {};
                    const id = props.OBJECTID || props.SiteID;
                    selectLoganSite(id);
                    const name = props.STREET_NAME || props.RoadName || props.ROAD_NAME || props.STREET || props.COUNTER_LOCATION_BETWEEN || 'Logan Site';
                    alert(`Nearest Site Found (${minDistance.toFixed(2)}km away):\nLogan: ${name}`);
                }, 500);
            } else if (sourceType === 'TOOWOOMBA') {
                document.querySelector("button[onclick*='tab-toowoomba']").click();

                setTimeout(() => {
                    const props = nearestSite.properties || {};
                    const id = props.OBJECTID || props.SiteID || props.Site_ID;
                    selectToowoombaSite(id);
                    const name = props.Road_Name || props.ROAD_NAME || props.Street || props.STREET || props.Location || 'Toowoomba Site';
                    alert(`Nearest Site Found (${minDistance.toFixed(2)}km away):\nToowoomba: ${name}`);
                }, 500);
            }
        } else {
            updateStatus("‚ùå No traffic sites found in database.");
        }
    }

    // --- IPSWICH MODULE (Updated with Excel Logic) ---

    let ipswichDataGlobal = [];
    let ipswichLayerGroup = L.layerGroup();
    let ipswichMapInstance = null;

    async function initIpswich() {
        if (!ipswichMapInstance) {
            ipswichMapInstance = L.map('ipswichMap').setView([-27.6144, 152.7608], 12);
            addTileLayerWithFallback(
                ipswichMapInstance,
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                { attribution: '&copy; OpenStreetMap contributors' },
                'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                { attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }
            );
        }

        if (ipswichDataGlobal.length === 0) {
            try {
                console.log('Fetching Ipswich data with retry mechanism...');
                const ipswichUrl = 'https://raw.githubusercontent.com/crsanju/Cromton_Traffic_Analysis/refs/heads/main/Ipswich.geojson';
                const parsed = await fetchGitHubData(ipswichUrl);
                ipswichDataGlobal = parsed.features ? parsed.features : parsed;
                console.log('‚úì Ipswich data loaded successfully');

                populateIpswichMap();
                populateIpswichList();
            } catch (error) {
                console.error("Error loading Ipswich data:", error);
                console.warn("Using empty Ipswich dataset as fallback");
                ipswichDataGlobal = [];
            }
        }
        setTimeout(() => { ipswichMapInstance.invalidateSize(); }, 200);
    }

    function populateIpswichMap() {
        ipswichLayerGroup.clearLayers();
        
        ipswichDataGlobal.forEach(item => {
            // Normalize properties whether it's GeoJSON or flat JSON
            const p = item.properties || item; 
            const geom = item.geometry;
            
            let lat, lon;
            if (geom && geom.coordinates) {
                if (geom.type === 'Point') {
                    lon = geom.coordinates[0];
                    lat = geom.coordinates[1];
                } else if (geom.type === 'LineString' && geom.coordinates.length > 0) {
                    const midIdx = Math.floor(geom.coordinates.length / 2);
                    lon = geom.coordinates[midIdx][0];
                    lat = geom.coordinates[midIdx][1];
                }
            } else {
                // Flat JSON fallback
                lat = p["GPS Latitude"] || p.Latitude || p.lat;
                lon = p["GPS Longitude"] || p.Longitude || p.lon;
            }

            if (lat && lon) {
                const name = p["Road Name"] || p.Description || p.ROAD_NAME || p.Road_Name || p.STREET || p.Location || p.SITE_LOCATION || "Unknown";
                const id = p["Id"] || p.ID || p.Site || p.SITE || p.OBJECTID || "0";

                const marker = L.circleMarker([lat, lon], {
                    radius: 6, fillColor: "#d35400", color: "#fff", weight: 1, fillOpacity: 0.8
                });
                
                // Store full data in marker for easy retrieval
                marker.siteData = p; 

                marker.bindPopup(`<b>${name}</b><br>ID: ${id}<br><button onclick="selectIpswichSite('${id}')">Analyze</button>`);
                marker.on('click', () => selectIpswichSite(id));
                ipswichLayerGroup.addLayer(marker);
            }
        });
        ipswichLayerGroup.addTo(ipswichMapInstance);
    }

    function populateIpswichList() {
        const select = document.getElementById('ipswichSiteSelect');
        select.innerHTML = "";
        // Sort by name
        const list = [...ipswichDataGlobal].sort((a, b) => {
            const na = (a.properties || a)["Road Name"] || (a.properties || a).Description || (a.properties || a).ROAD_NAME || "";
            const nb = (b.properties || b)["Road Name"] || (b.properties || b).Description || (b.properties || b).ROAD_NAME || "";
            return na.localeCompare(nb);
        });

        list.forEach(item => {
            const p = item.properties || item;
            const name = p["Road Name"] || p.Description || p.ROAD_NAME || p.Road_Name || p.STREET || p.Location || p.SITE_LOCATION;
            const id = p["Id"] || p.ID || p.Site || p.SITE || p.OBJECTID;
            const opt = document.createElement("option");
            opt.value = id;
            opt.innerText = `${name} (${id})`;
            select.appendChild(opt);
        });
    }

    function filterIpswichList() {
        const query = document.getElementById('ipswichSearch').value.toLowerCase();
        const select = document.getElementById('ipswichSiteSelect');
        select.innerHTML = "";

        ipswichDataGlobal.filter(item => {
            const p = item.properties || item;
            const name = String(p["Road Name"] || p.Description || p.ROAD_NAME || p.Road_Name || p.STREET || p.Location || p.SITE_LOCATION || "").toLowerCase();
            const id = String(p["Id"] || p.ID || p.Site || p.SITE || p.OBJECTID || "").toLowerCase();
            return name.includes(query) || id.includes(query);
        }).forEach(item => {
            const p = item.properties || item;
            const name = p["Road Name"] || p.Description || p.ROAD_NAME || p.Road_Name || p.STREET || p.Location || p.SITE_LOCATION;
            const id = p["Id"] || p.ID || p.Site || p.SITE || p.OBJECTID;
            const opt = document.createElement("option");
            opt.value = id;
            opt.innerText = `${name} (${id})`;
            select.appendChild(opt);
        });
    }

    // Global state for current calculation
    let currentIpswichData = null;

    function selectIpswichSite(siteId) {
        // Find the data object
        const feature = ipswichDataGlobal.find(i => {
            const p = i.properties || i;
            return String(p["Id"]) === String(siteId) || String(p["ID"]) === String(siteId) || String(p["Site"]) === String(siteId) || String(p["SITE"]) === String(siteId) || String(p.OBJECTID) === String(siteId);
        });
        
        if (!feature) return;

        currentIpswichData = feature.properties || feature;
        const p = currentIpswichData;

        // Show UI
        document.getElementById('ipswichCalcArea').style.display = 'block';
        document.getElementById('ipswichSelectedName').innerText = p["Road Name"] || p.Description || p.ROAD_NAME || p.Road_Name || p.STREET || p.Location || p.SITE_LOCATION;
        document.getElementById('ipswichAnalysisRoad').placeholder = p["Road Name"] || p.Description || p.ROAD_NAME || p.Road_Name || "Analysis Road";

        // Extract and display coordinates
        if (feature.geometry && feature.geometry.coordinates) {
            const coords = feature.geometry.coordinates;
            let lat, lon;
            
            if (feature.geometry.type === 'Point') {
                lon = coords[0];
                lat = coords[1];
            } else if (feature.geometry.type === 'LineString' && coords.length > 0) {
                // Use midpoint for line features
                const midIndex = Math.floor(coords.length / 2);
                lon = coords[midIndex][0];
                lat = coords[midIndex][1];
            }
            
            if (lat && lon) {
                document.getElementById('ipswichCoordinates').innerText = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                document.getElementById('ipswichMapLink').href = `https://www.google.com/maps?q=${lat},${lon}`;
            } else {
                document.getElementById('ipswichCoordinates').innerText = '-';
                document.getElementById('ipswichMapLink').href = '#';
            }
        } else {
            document.getElementById('ipswichCoordinates').innerText = '-';
            document.getElementById('ipswichMapLink').href = '#';
        }

        // 1. EXTRACT AADT
        // Priority: 'Average Daily Traffic...' > 'ADT' > 'AADT' > Estimate from Peak
        let aadt = p["Average Daily Traffic Adt Vehicles Per Day"] || p["ADT"] || p["AADT"] || 0;
        
        // If AADT is 0/missing, try to estimate from Peak Flows (AADT approx 10x Peak)
        if (!aadt || aadt === 0) {
            const am = p["Weekday Avg AM Peak Flow Vehicles Per Hour"] || 0;
            const pm = p["Weekday Avg PM Peak Flow Vehicles Per Hour"] || 0;
            const maxPeak = Math.max(am, pm);
            if (maxPeak > 0) aadt = maxPeak * 10; 
        }

        if (!aadt || aadt === 0) {
            let latestYear = 0;
            let latestVal = 0;
            Object.keys(p).forEach(key => {
                if (!isNaN(key) && Number(key) > 2000 && Number(key) < 2100) {
                    const val = p[key];
                    if (val && !isNaN(val) && Number(key) > latestYear) {
                        latestYear = Number(key);
                        latestVal = Number(val);
                    }
                }
            });
            if (latestVal > 0) aadt = latestVal;
        }
        
        // 2. EXTRACT OTHER METRICS
        const year = p["Year"] || p["YEAR"] || 2022; // Default if missing
        const hv = p["Percentage Commercial Vehicles"] || p["HV%"] || 0.05; // Decimal 0.05
        const growth = p["Growth Rate"] || 2.5;

        // 3. POPULATE INPUTS
        document.getElementById('ipswichBaseYear').innerText = year;
        document.getElementById('ipswichInputAADT').value = Math.round(aadt);
        
        // Handle HV formatting (JSON might be 0.04 or 4.0)
        let hvDisplay = hv;
        if (hv < 1) hvDisplay = hv * 100;
        document.getElementById('ipswichInputHV').value = hvDisplay.toFixed(1);

        document.getElementById('ipswichInputGrowth').value = growth;
        
        // Trigger Calculation
        updateIpswichAnalysis();

        // Zoom Map
        const geom = feature.geometry;
        if (geom && geom.coordinates) {
            let lat, lon;
            if (geom.type === 'Point') {
                lon = geom.coordinates[0];
                lat = geom.coordinates[1];
            } else if (geom.type === 'LineString' && geom.coordinates.length > 0) {
                const midIdx = Math.floor(geom.coordinates.length / 2);
                lon = geom.coordinates[midIdx][0];
                lat = geom.coordinates[midIdx][1];
            }
            if (lat && lon) {
                ipswichMapInstance.setView([lat, lon], 15);
            }
        }
    }

    function updateIpswichAnalysis() {
        const baseAADT = parseFloat(document.getElementById('ipswichInputAADT').value) || 0;
        const baseYear = parseInt(document.getElementById('ipswichBaseYear').innerText);
        const targetYear = parseInt(document.getElementById('ipswichTargetYear').value);
        const growthRate = parseFloat(document.getElementById('ipswichInputGrowth').value) / 100;
        const hvPercent = parseFloat(document.getElementById('ipswichInputHV').value) / 100;
        const analysisPct = parseFloat(document.getElementById('ipswichAnalysisPct').value) / 100;

        const years = Math.max(0, targetYear - baseYear);
        const projectedAADT = baseAADT * Math.pow((1 + growthRate), years);
        const finalAADT = projectedAADT * analysisPct;

        const peakHour80th = (finalAADT * 0.15) * 0.85;
        const offPeakHour = ((finalAADT - peakHour80th) * 0.15) * 0.45;

        const lanes = 1;
        const hourlyPerLane = peakHour80th / lanes;
        const vol5MinPerLane = hourlyPerLane / 12;

        const volLV = vol5MinPerLane * (1 - hvPercent);
        const volHV = vol5MinPerLane * hvPercent;

        const dayLimit = 750;
        const calc30thHour = Math.round((0.15 * dayLimit) / 2);
        const designCapacity = Math.max(calc30thHour, 500);

        const vcr = peakHour80th / designCapacity;

        let los = "F";
        let losClass = "los-f";
        if (vcr <= 0.60) { los = "A"; losClass = "los-a"; }
        else if (vcr <= 0.70) { los = "B"; losClass = "los-b"; }
        else if (vcr <= 0.90) { los = "C"; losClass = "los-c"; }
        else if (vcr <= 0.95) { los = "D"; losClass = "los-d"; }
        else if (vcr <= 1.00) { los = "E"; losClass = "los-e"; }

        document.getElementById('ipswichResAADT').innerText = Math.round(finalAADT).toLocaleString();
        document.getElementById('ipswichResPeakFlow').innerText = Math.round(peakHour80th).toLocaleString() + ' veh/hr';
        document.getElementById('ipswichResVCR').innerText = vcr.toFixed(3);

        const badge = document.getElementById('ipswichResLOS');
        if (badge) {
            badge.innerText = "LOS " + los;
            badge.className = "";
            badge.classList.add(losClass);
            badge.style.padding = "5px 10px";
            badge.style.borderRadius = "4px";
            badge.style.fontWeight = "bold";
        }

        document.getElementById('ipswichCapacity').value = designCapacity;

        const resultsSection = document.getElementById('ipswichResultsSection');
        if (resultsSection) {
            resultsSection.open = true;
        }

        buildIpswichDirectionalQueues(peakHour80th, offPeakHour, hvPercent, lanes);
        buildIpswichTrafficImpactAnalysis(peakHour80th, offPeakHour, designCapacity, lanes);

        const roadName = document.getElementById('ipswichSelectedName').innerText || 'Ipswich Site';
        passToCalculations_Manual(
            roadName,
            baseAADT,
            lanes,
            parseFloat(document.getElementById('ipswichInputHV').value) || 9.6,
            0,
            baseYear,
            parseFloat(document.getElementById('ipswichInputGrowth').value) || 2.5,
            targetYear
        );
    }

    function buildIpswichDirectionalQueues(peakHour, offPeakHour, cvRatio, laneCount) {
        const section = document.getElementById('ipswichQueueSection');
        const contentElement = document.getElementById('ipswichQueueContent');

        if (!section || !contentElement) return;

        const directionLabels = ['Direction 1', 'Direction 2'];
        const directionPeakHour = peakHour / 2;
        const directionOffPeakHour = offPeakHour / 2;

        function buildDirectionalQueue(directionLabel, dirPeakHour, dirOffPeakHour, cvRatio, laneCount) {
            const hourlyPeak = dirPeakHour;
            const hourlyPeakCv = hourlyPeak * cvRatio;
            const hourlyOffPeak = dirOffPeakHour;
            const hourlyOffPeakCv = hourlyOffPeak * cvRatio;

            const hourlyPeakPerLane = hourlyPeak / laneCount;
            const hourlyPeakCvPerLane = hourlyPeakCv / laneCount;
            const hourlyOffPeakPerLane = hourlyOffPeak / laneCount;
            const hourlyOffPeakCvPerLane = hourlyOffPeakCv / laneCount;

            const peakVol5 = hourlyPeakPerLane / 12;
            const peakCvVol5 = hourlyPeakCvPerLane / 12;
            const offPeakVol5 = hourlyOffPeakPerLane / 12;
            const offPeakCvVol5 = hourlyOffPeakCvPerLane / 12;

            function queueLength(volume5Total, volume5Cv, lvFactor, hvFactor) {
                return (volume5Total * lvFactor) + (volume5Cv * hvFactor);
            }

            const q2Peak = queueLength(peakVol5, peakCvVol5, 2.4, 8);
            const q5Peak = queueLength(peakVol5, peakCvVol5, 6, 20);
            const q10Peak = queueLength(peakVol5, peakCvVol5, 12, 40);
            const q15Peak = queueLength(peakVol5, peakCvVol5, 18, 60);

            const q2Off = queueLength(offPeakVol5, offPeakCvVol5, 2.4, 8);
            const q5Off = queueLength(offPeakVol5, offPeakCvVol5, 6, 20);
            const q10Off = queueLength(offPeakVol5, offPeakCvVol5, 12, 40);
            const q15Off = queueLength(offPeakVol5, offPeakCvVol5, 18, 60);

            return `
                <div style="margin:15px 0; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #dee2e6;">
                    <h4 style="margin:0 0 15px 0; color:#1f5e63;">Queue Length Estimation: Ipswich - ${directionLabel}</h4>
                    <table style="width:100%; border-collapse:collapse; font-size:0.88em;">
                        <tr style="background:#f4f6f8; font-weight:bold;">
                            <td style="padding:8px; border:1px solid #ddd;" colspan="2"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">80th Highest Hour<br>(Peak traffic estimate)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">CV</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">Off-peak traffic<br>(Estimated Highest Hour - 45% of remaining volume)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">CV</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd; font-weight:bold;" colspan="2">Hourly Average</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakCv).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakCv).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd; font-weight:bold;" colspan="2">Hourly Average per Lane</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakPerLane).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakCvPerLane).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakPerLane).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakCvPerLane).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd; font-weight:bold;" colspan="2">Queue length estimation</td>
                            <td style="padding:8px; border:1px solid #ddd;" colspan="4"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">Volume</td>
                            <td style="padding:8px; border:1px solid #ddd;">per 5 mins</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(peakVol5).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(peakCvVol5).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(offPeakVol5).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(offPeakCvVol5).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">2 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q2Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right; background:#cfe8b3;">${Math.round(q2Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">5 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q5Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q5Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">10 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q10Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q10Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">15 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q15Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q15Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        const html = buildDirectionalQueue(directionLabels[0], directionPeakHour, directionOffPeakHour, cvRatio, laneCount) +
                     buildDirectionalQueue(directionLabels[1], directionPeakHour, directionOffPeakHour, cvRatio, laneCount);

        if (contentElement) {
            contentElement.innerHTML = html;
        }

        if (section) {
            section.open = true;
        }
    }

    function buildIpswichTrafficImpactAnalysis(peakHour, offPeakHour, designCap, laneCount) {
        const section = document.getElementById('ipswichImpactSection');
        const contentElement = document.getElementById('ipswichImpactContent');
        const placeholder = document.getElementById('ipswichImpactPlaceholder');

        if (!section || !contentElement) return;

        if (placeholder) placeholder.style.display = 'none';
        contentElement.style.display = 'block';

        const dirPeakHour = peakHour / 2;
        const dirOffPeakHour = offPeakHour / 2;

        function getVcrClass(vcr) {
            if (vcr === 'N/A') return '';
            if (vcr <= 0.60) return 'los-a';
            if (vcr <= 0.70) return 'los-b';
            if (vcr <= 0.90) return 'los-c';
            if (vcr <= 0.95) return 'los-d';
            if (vcr <= 1.00) return 'los-e';
            return 'los-f';
        }

        function formatVcr(vcr) {
            return vcr === 'N/A' ? 'N/A' : vcr.toFixed(2);
        }

        const scenarios = [
            {
                label: 'Direction 1',
                peak: dirPeakHour / designCap,
                offPeak: dirOffPeakHour / designCap
            },
            {
                label: 'Direction 2',
                peak: dirPeakHour / designCap,
                offPeak: dirOffPeakHour / designCap
            },
            {
                label: '1 Lane Closure Direction 1',
                peak: laneCount > 1 ? (dirPeakHour / (laneCount - 1)) / designCap : 'N/A',
                offPeak: laneCount > 1 ? (dirOffPeakHour / (laneCount - 1)) / designCap : 'N/A'
            },
            {
                label: '1 Lane Closure Direction 2',
                peak: laneCount > 1 ? (dirPeakHour / (laneCount - 1)) / designCap : 'N/A',
                offPeak: laneCount > 1 ? (dirOffPeakHour / (laneCount - 1)) / designCap : 'N/A'
            },
            {
                label: 'Single Lane Reversible Flow',
                peak: (dirPeakHour * 2) / designCap,
                offPeak: (dirOffPeakHour * 2) / designCap
            }
        ];

        const html = `
            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                <tr style="background:#f4f6f8; font-weight:bold;">
                    <td style="padding:8px; border:1px solid #ddd; font-weight:bold;">Design Volume (Capacity) *</td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">${Math.round(designCap).toLocaleString()}</td>
                    <td style="padding:8px; border:1px solid #ddd;" colspan="2"></td>
                </tr>
                <tr style="background:#f4f6f8; font-weight:bold;">
                    <td style="padding:8px; border:1px solid #ddd;">VCR (Degrees of Saturation)</td>
                    <td style="padding:8px; border:1px solid #ddd;"></td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">Peak</td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">Off-Peak</td>
                </tr>
                ${scenarios.map(s => `
                    <tr>
                        <td style="padding:8px; border:1px solid #ddd; font-weight:bold;">${s.label}</td>
                        <td style="padding:8px; border:1px solid #ddd;"></td>
                        <td style="padding:8px; border:1px solid #ddd; text-align:center; ${s.peak !== 'N/A' ? 'background-color:' : ''}" class="${s.peak !== 'N/A' ? getVcrClass(s.peak) : ''}">${formatVcr(s.peak)}</td>
                        <td style="padding:8px; border:1px solid #ddd; text-align:center; ${s.offPeak !== 'N/A' ? 'background-color:' : ''}" class="${s.offPeak !== 'N/A' ? getVcrClass(s.offPeak) : ''}">${formatVcr(s.offPeak)}</td>
                    </tr>
                `).join('')}
            </table>
        `;

        contentElement.innerHTML = html;
        section.open = true;
    }

    function getColorForQueue(len) {
        if (len > 100) return "#e74c3c"; // Red warning for long queues
        if (len > 50) return "#f1c40f";  // Yellow
        return "#fff";
    }

    // --- LOGAN MODULE ---

    let loganDataGlobal = null;
    let loganLayerGroup = L.layerGroup();
    let loganMapInstance = null;

    function getLoganName(props) {
        return props.STREET_NAME || props.RoadName || props.ROAD_NAME || props.STREET || props.COUNTER_LOCATION_BETWEEN || props.COMMENTS || props.Location || "Unknown Road";
    }

    function getLoganId(props, fallbackId) {
        return props.OBJECTID || props.SiteID || props.LOCATION_ID || props.id || fallbackId || "N/A";
    }

    async function initLogan() {
        // 1. Initialize Map
        if (!loganMapInstance) {
            loganMapInstance = L.map('loganMap').setView([-27.64, 153.10], 11); // Center on Logan
            addTileLayerWithFallback(
                loganMapInstance,
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                { attribution: '&copy; OpenStreetMap contributors' },
                'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                { attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }
            );
        }

        // 2. Fetch Data using robust retry mechanism
        if (!loganDataGlobal) {
            try {
                console.log('Fetching Logan data with retry mechanism...');
                const loganUrl = 'https://raw.githubusercontent.com/crsanju/Cromton_Traffic_Analysis/main/logan.geojson';
                loganDataGlobal = await fetchGitHubData(loganUrl);
                console.log('‚úì Logan data loaded successfully');
                
                populateLoganMap();
                populateLoganList();
            } catch (error) {
                console.error("Error loading Logan data:", error);
                console.warn("Using empty Logan dataset as fallback");
                loganDataGlobal = { type: 'FeatureCollection', features: [] };
            }
        }
        
        // Resize fix
        setTimeout(() => { loganMapInstance.invalidateSize(); }, 200);
    }

    function populateLoganMap() {
        loganLayerGroup.clearLayers();
        
        if (loganDataGlobal && loganDataGlobal.features) {
            loganDataGlobal.features.forEach(feature => {
                const props = feature.properties || {};
                const geom = feature.geometry;

                // Extract Name and ID (Flexible check for common keys)
                const name = getLoganName(props);
                const id = getLoganId(props, feature.id);
                
                // Extract Coordinates (GeoJSON is [Lon, Lat])
                if (geom && geom.coordinates) {
                    let lat, lon;
                    if (geom.type === 'Point') {
                        lon = geom.coordinates[0];
                        lat = geom.coordinates[1];
                    } else if (geom.type === 'LineString' && geom.coordinates.length > 0) {
                        const midIdx = Math.floor(geom.coordinates.length / 2);
                        lon = geom.coordinates[midIdx][0];
                        lat = geom.coordinates[midIdx][1];
                    }

                    if (lat && lon) {
                        const marker = L.circleMarker([lat, lon], {
                            radius: 5,
                            fillColor: "#28a745", // Green for Logan
                            color: "#fff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });

                        marker.bindPopup(`<b>${name}</b><br>ID: ${id}<br><button onclick="selectLoganSite('${id}')">Analyze</button>`);
                        marker.on('click', () => selectLoganSite(id));
                        loganLayerGroup.addLayer(marker);
                    }
                }
            });
            loganLayerGroup.addTo(loganMapInstance);
        }
    }

    function populateLoganList() {
        const select = document.getElementById('loganSiteSelect');
        select.innerHTML = "";
        
        if (loganDataGlobal && loganDataGlobal.features) {
            // Sort alphabetically by road name
            const features = [...loganDataGlobal.features].sort((a, b) => {
                const nameA = getLoganName(a.properties || {});
                const nameB = getLoganName(b.properties || {});
                return nameA.localeCompare(nameB);
            });

            features.forEach(feature => {
                const props = feature.properties || {};
                const name = getLoganName(props);
                const id = getLoganId(props, feature.id); // Use unique ID
                
                const opt = document.createElement("option");
                opt.value = id;
                opt.innerText = `${name} (${id})`;
                select.appendChild(opt);
            });
        }
    }

    function filterLoganList() {
        const query = document.getElementById('loganSearch').value.toLowerCase();
        const select = document.getElementById('loganSiteSelect');
        select.innerHTML = "";
        
        if (loganDataGlobal && loganDataGlobal.features) {
            loganDataGlobal.features.filter(f => {
                const p = f.properties || {};
                const text = `${p.STREET_NAME || ''} ${p.RoadName || ''} ${p.ROAD_NAME || ''} ${p.STREET || ''} ${p.COUNTER_LOCATION_BETWEEN || ''} ${p.COMMENTS || ''} ${p.SUBURB || ''} ${p.OBJECTID || ''} ${p.SiteID || ''}`.toLowerCase();
                return text.includes(query);
            }).forEach(feature => {
                const props = feature.properties || {};
                const name = getLoganName(props);
                const id = getLoganId(props, feature.id);
                
                const opt = document.createElement("option");
                opt.value = id;
                opt.innerText = `${name} (${props.SUBURB || ''})`;
                select.appendChild(opt);
            });
        }
    }

    // Store current selection
    let currentLoganFeature = null;

    function selectLoganSite(siteId) {
        // Find feature by ID (converting to string to be safe)
        if (!loganDataGlobal || !loganDataGlobal.features) return;

        currentLoganFeature = loganDataGlobal.features.find(feature => {
            const props = feature.properties || {};
            const featureId = getLoganId(props, feature.id);
            return String(featureId) === String(siteId) || 
                String(props.SiteID || '') === String(siteId);
        });
        
        if (!currentLoganFeature) return;

        const props = currentLoganFeature.properties || {};

        // Show Calc Area
        document.getElementById('loganCalcArea').style.display = 'block';

        // Extract Name
        const name = getLoganName(props);
        document.getElementById('loganSelectedName').innerText = name;
        document.getElementById('loganAnalysisRoad').placeholder = name || "Analysis Road";

        // Extract and display coordinates
        if (currentLoganFeature.geometry && currentLoganFeature.geometry.coordinates) {
            const coords = currentLoganFeature.geometry.coordinates;
            let lat, lon;
            
            if (currentLoganFeature.geometry.type === 'Point') {
                lon = coords[0];
                lat = coords[1];
            } else if (currentLoganFeature.geometry.type === 'LineString' && coords.length > 0) {
                // Use midpoint for line features
                const midIndex = Math.floor(coords.length / 2);
                lon = coords[midIndex][0];
                lat = coords[midIndex][1];
            }
            
            if (lat && lon) {
                document.getElementById('loganCoordinates').innerText = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                document.getElementById('loganMapLink').href = `https://www.google.com/maps?q=${lat},${lon}`;
            } else {
                document.getElementById('loganCoordinates').innerText = '-';
                document.getElementById('loganMapLink').href = '#';
            }
        } else {
            document.getElementById('loganCoordinates').innerText = '-';
            document.getElementById('loganMapLink').href = '#';
        }

        // Extract Traffic Data (prefer AADT; fallback to AAWT or VOL1+VOL2)
        let aadt = props.AADT ?? props.ADT ?? props.AAWT ?? props.Volume;
        if (aadt == null || isNaN(aadt)) {
            const vol1 = Number(props.VOL1 || 0);
            const vol2 = Number(props.VOL2 || 0);
            aadt = (isNaN(vol1) ? 0 : vol1) + (isNaN(vol2) ? 0 : vol2);
        }

        let year = props.YEAR || props.Year || 2020; // Default if missing

        // Try to parse year from date fields if present
        if (props.AADT_DATE || props.AAWT_DATE || props.COUNT_DATE || props.COMP_DATE) {
            const d = new Date(props.AADT_DATE || props.AAWT_DATE || props.COUNT_DATE || props.COMP_DATE);
            if (!isNaN(d.getFullYear())) year = d.getFullYear();
        }

        // Default Growth Rate (2.5% standard or use property if exists)
        let growth = props.GROWTH_RATE || 2.5; 
        if (growth < 1) growth = growth * 100;

        // Heavy vehicle percent if available; default to 5.0
        let hv = props.HV_PCT ?? props.HV ?? props.OV_PCENT ?? 5.0;
        if (hv < 1) hv = hv * 100;

        // Update inputs
        document.getElementById('loganBaseYear').innerText = year;
        document.getElementById('loganInputAADT').value = Math.round(Number(aadt) || 0);
        document.getElementById('loganInputGrowth').value = Number(growth).toFixed(1);
        document.getElementById('loganInputHV').value = Number(hv).toFixed(1);

        // Zoom Map
        const geom = currentLoganFeature.geometry;
        if (geom && geom.coordinates) {
            let lat, lon;
            if (geom.type === 'Point') {
                lon = geom.coordinates[0];
                lat = geom.coordinates[1];
            } else if (geom.type === 'LineString' && geom.coordinates.length > 0) {
                const midIdx = Math.floor(geom.coordinates.length / 2);
                lon = geom.coordinates[midIdx][0];
                lat = geom.coordinates[midIdx][1];
            }
            if (lat && lon) {
                loganMapInstance.setView([lat, lon], 15);
            }
        }

        updateLoganAnalysis();
    }

    // ========== TIA VOLUME ADJUSTMENT MODAL ==========
    let tiaVolumeState = {
        projectName: '',
        baseVolume: 0,
        nearestSiteId: null,
        tripGenVolume: 0,
        percentageVolume: 0,
        selectedAadt: 0
    };

    function initiateCustomTIA() {
        const projectName = document.getElementById('tia_project').value.trim();
        
        if (!projectName) {
            document.getElementById('roadNotFoundMsg').style.display = 'none';
            return;
        }

        // Check if project exists in database
        const foundInDB = Object.keys(sitesData).some(key => {
            const site = sitesData[key];
            const searchStr = `${key} ${site.road_name || ''} ${site.description || ''}`.toLowerCase();
            return searchStr.includes(projectName.toLowerCase());
        });

        if (foundInDB) {
            document.getElementById('roadNotFoundMsg').style.display = 'none';
            return;
        }

        // Road not in database - show message
        document.getElementById('roadNotFoundMsg').style.display = 'block';
    }

    // ============================================
    // INTEGRATION FUNCTIONS - Pass Data to Calculations
    // ============================================

    // From TMR/Hourly Tab - Pass site data to calculations
    function passToCalculations_TMR(siteData) {
        updateRoadData({
            source: 'TMR_Database',
            roadName: siteData.name || 'TMR Site',
            aadt: siteData.aadt || 0,
            direction1AADT: siteData.d1_aadt || (siteData.aadt * 0.5),
            direction2AADT: siteData.d2_aadt || (siteData.aadt * 0.5),
            lanes: siteData.lanes || 2,
            hvPercent: siteData.hv_percent || 15,
            rtPercent: siteData.rt_percent || 0,
            year: siteData.countYear || new Date().getFullYear(),
            growthRate: 2.5,
            targetYear: new Date().getFullYear() + 5,
            rtrApplicable: siteData.rtr_applicable || false
        });
        console.log('TMR data loaded for calculations');
    }

    // From Logan/Toowoomba Tab - Manual input
    function passToCalculations_Manual(roadName, aadt, lanes, hv, rt, year, growth, targetYear) {
        updateRoadData({
            source: 'Manual_Input',
            roadName: roadName || 'Manual Analysis',
            aadt: parseFloat(aadt) || 0,
            direction1AADT: (parseFloat(aadt) || 0) * 0.5,
            direction2AADT: (parseFloat(aadt) || 0) * 0.5,
            lanes: parseInt(lanes) || 2,
            hvPercent: parseFloat(hv) || 15,
            rtPercent: parseFloat(rt) || 0,
            year: parseInt(year) || new Date().getFullYear(),
            growthRate: parseFloat(growth) || 2.5,
            targetYear: parseInt(targetYear) || (new Date().getFullYear() + 5),
            rtrApplicable: false
        });
        console.log('Manual data loaded for calculations');
    }

    // From Custom TIA Tab
    function passToCalculations_TIA(projectName, aadt, lanes, cvPercent, year, growth, targetYear) {
        updateRoadData({
            source: 'Custom_TIA',
            roadName: projectName || 'TIA Analysis',
            aadt: parseFloat(aadt) || 0,
            direction1AADT: (parseFloat(aadt) || 0) * 0.5,
            direction2AADT: (parseFloat(aadt) || 0) * 0.5,
            lanes: parseInt(lanes) || 2,
            hvPercent: parseFloat(cvPercent) || 15,
            rtPercent: 0,
            year: parseInt(year) || new Date().getFullYear(),
            growthRate: parseFloat(growth) || 2.5,
            targetYear: parseInt(targetYear) || (new Date().getFullYear() + 5),
            rtrApplicable: false
        });
        console.log('TIA data loaded for calculations');
    }

    // Quick navigation from any tab to calculations
    function quickCalculate(event) {
        navigateToCalculations(event);
        return false;
    }

    // ============================================
    // DATA SENDING FUNCTIONS - FROM ALL TABS
    // ============================================

    // From Gold Coast TIA Tab
    function sendTIADataToCalc() {
        const aadt = parseFloat(document.getElementById('tia_aadt').value) || 0;
        const yearData = parseInt(document.getElementById('tia_year_data').value);
        const yearOpen = parseInt(document.getElementById('tia_year_open').value);
        const growth = parseFloat(document.getElementById('tia_growth').value) || 2.5;
        const hv = parseFloat(document.getElementById('tia_hv').value) || 5;
        const lanes = parseInt(document.getElementById('tia_lanes').value) || 1;
        const project = document.getElementById('tia_project').value || 'TIA Site';

        if (aadt === 0) {
            alert('Please enter AADT value');
            return;
        }

        passToCalculations_TIA(project, aadt, lanes, hv, yearData, (yearOpen - yearData) * (1 + (growth / 100)), yearOpen);
        navigateToCalculations();
    }

    // From Custom TIA Tab
    function sendCustomTIADataToCalc() {
        const selectedVolume = parseFloat(document.getElementById('customGreaterVolumeDisplay').innerText) || 0;
        const projectName = document.getElementById('customTiaProject').value || 'Custom TIA';
        const year = new Date().getFullYear();
        const targetYear = year + 5;

        if (selectedVolume === 0) {
            alert('Please calculate custom TIA volume first');
            return;
        }

        passToCalculations_Manual(
            projectName,
            selectedVolume,
            1,
            5,
            0,
            year,
            2.5,
            targetYear
        );
        navigateToCalculations();
    }

    // From TMR Roads Tab
    function sendTMRDataToCalc() {
        const dataYear = parseInt(document.getElementById('dataYear').value);
        const openingYear = parseInt(document.getElementById('openingYear').value);
        const growth = parseFloat(document.getElementById('growthRate').value) || 3;
        const hv = parseFloat(document.getElementById('hvPercent').value) || 7;
        const lanes = parseInt(document.getElementById('lanes').value) || 2;
        const roadNameEl = document.getElementById('roadName');
        const roadName = roadNameEl ? roadNameEl.innerText || 'TMR Site' : 'TMR Site';

        // Get calculated DHV from results if available
        const dhvEl = document.getElementById('res_dhv');
        let aadt = 0;
        
        if (dhvEl && dhvEl.innerText !== '-') {
            // Extract number from "XXXX veh/hr"
            const dhvStr = dhvEl.innerText.replace(' veh/hr', '');
            const dhv = parseFloat(dhvStr) || 0;
            // Convert DHV back to AADT using K-factor
            const kFactor = parseFloat(document.getElementById('kFactor').value) / 100 || 0.1;
            const dSplit = parseFloat(document.getElementById('dSplit').value) / 100 || 0.6;
            aadt = dhv / (kFactor * dSplit);
        } else {
            alert('Please run Calculate Analysis first');
            return;
        }

        passToCalculations_Manual(
            roadName,
            aadt,
            lanes,
            hv,
            0,
            dataYear,
            growth,
            openingYear
        );
        navigateToCalculations();
    }

    function setupGoldCoastProjectListener() {
        const projectInput = document.getElementById('tia_project');
        if (projectInput) {
            projectInput.addEventListener('change', initiateCustomTIA);
            projectInput.addEventListener('blur', initiateCustomTIA);
        }
    }

    function updateCustomComparison() {
        const rate = parseFloat(document.getElementById('customDevContext').value) || 7.4;
        const units = parseFloat(document.getElementById('customDwellings').value) || 0;
        const assignment = (parseFloat(document.getElementById('customRoadAssign').value) || 100) / 100;
        const percentage = parseFloat(document.getElementById('customPercentRef').value) || 50;

        // Get nearest site AADT
        const nearestSite = findNearestSiteData();
        const baseVolume = nearestSite ? (nearestSite.aadt || 0) : 1000;

        // Update reference site display
        if (nearestSite) {
            document.getElementById('customNearestSiteRef').innerText = `${nearestSite.id} (${nearestSite.road_name || 'Unknown'}) - ${Math.round(baseVolume)} vph`;
        }

        // Trip generation
        const tripGenAADT = units * rate * assignment;
        document.getElementById('customTripGenResult').innerText = Math.round(tripGenAADT) + ' vph';

        // Percentage of nearest site
        const percentageAADT = (baseVolume * percentage) / 100;
        document.getElementById('customPercentRefResult').innerText = Math.round(percentageAADT) + ' vph';

        // Show which is greater
        const greaterVolume = Math.max(tripGenAADT, percentageAADT);
        const greaterMethod = tripGenAADT >= percentageAADT ? 'Trip Generation' : 'Percentage Method';
        
        document.getElementById('customGreaterVolumeDisplay').innerHTML = `
            <strong style="color: #1f5e63;">Using: ${greaterMethod}</strong><br>
            <strong style="font-size: 1.2em; color: #d36b2c;">${Math.round(greaterVolume)} vph</strong>
        `;

        // Store for next step
        window.customTIAvolume = {
            aadt: greaterVolume,
            method: greaterMethod,
            projectName: document.getElementById('customTiaProject').value
        };
    }

    function applyCustomTIAToGoldCoast() {
        const projectName = document.getElementById('customTiaProject').value.trim();
        
        if (!projectName) {
            alert('Please enter a project name in the Custom TIA tab');
            return;
        }

        // Update comparison to ensure we have latest values
        updateCustomComparison();
        
        // Apply to Gold Coast TIA form
        if (window.customTIAvolume) {
            document.getElementById('tia_project').value = window.customTIAvolume.projectName;
            document.getElementById('tia_aadt').value = Math.round(window.customTIAvolume.aadt);
            document.getElementById('tia_year_data').value = new Date().getFullYear();
        }
        
        // Switch to Gold Coast TIA tab
        const tabButtons = document.querySelectorAll(".tab-button");
        for (let btn of tabButtons) {
            if (btn.textContent.includes('Gold coast')) {
                btn.click();
                break;
            }
        }
        setTimeout(() => {
            const aadtInput = document.getElementById('tia_aadt');
            if (aadtInput) {
                aadtInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 150);
    }

    function findNearestSiteData() {
        // Return the first/reference site with AADT data
        for (const [id, site] of Object.entries(sitesData)) {
            const aadt = site.AADT || site.ADT || site.Volume || 0;
            if (aadt > 0) {
                return {
                    id: id,
                    road_name: site.road_name || site.STREET || 'Site',
                    aadt: aadt
                };
            }
        }
        return null;
    }

    function showHouseholdEstimationModal() {
        // Find nearest site for reference volume
        const nearestSite = findNearestSiteData();
        if (nearestSite) {
            tiaVolumeState.nearestSiteId = nearestSite.id;
            tiaVolumeState.baseVolume = nearestSite.aadt || 0;
            document.getElementById('nearestSiteRef').innerText = `${nearestSite.id} (${nearestSite.road_name || 'Unknown'}) - ${Math.round(nearestSite.aadt)} vph`;
        }
        
        document.getElementById('tiaProjectDisplay').innerText = tiaVolumeState.projectName;
        document.getElementById('householdModal').classList.add('show');
        updateComparisonResults();
    }

    function closeHouseholdModal() {
        document.getElementById('householdModal').classList.remove('show');
    }

    /**
     * Exact TMR Calculations based on Traffic ANALYSIS_TMR_formulas.json
     * Mapping to JSON Cells: AC36 (AADT), AC41 (DHV), AC42 (Peak Flow)
     */
    function calculateTMRSpecifics(aadtValue) {
        // 1. Total AADT (Reference Cell AC36)
        const totalAADT = parseFloat(aadtValue) || 0;

        // 2. Design Hour Volume (Reference Cell AC41)
        // Formula: =ROUNDUP(0.12 * AC36, 0)
        const designHourVolume = Math.ceil(0.12 * totalAADT);

        // 3. Peak Directional Flow (Reference Cell AC42)
        // Formula: =ROUNDUP(0.85 * AC41, 0)
        const peakDirectionalFlow = Math.ceil(0.85 * designHourVolume);

        return {
            aadt: totalAADT,
            dhv: designHourVolume,
            peakFlow: peakDirectionalFlow
        };
    }

    function updateComparisonResults() {
        const rate = parseFloat(document.getElementById('devContext').value) || 7.4;
        const units = parseFloat(document.getElementById('dwellings').value) || 0;
        const assignment = (parseFloat(document.getElementById('roadAssign').value) || 100) / 100;
        const percentage = parseFloat(document.getElementById('percentRef').value) || 50;

        // Method 1 (Trip generation AADT -> TMR specifics)
        const tripGenAADT = units * rate * assignment;
        const tripGenTMR = calculateTMRSpecifics(tripGenAADT);
        tiaVolumeState.tripGenVolume = tripGenTMR.peakFlow;
        document.getElementById('tripGenResult').innerText = Math.round(tripGenTMR.peakFlow) + ' vph';

        // Method 2 (Percentage-based AADT -> TMR specifics)
        const percentageAADT = (tiaVolumeState.baseVolume * percentage) / 100;
        const percentageTMR = calculateTMRSpecifics(percentageAADT);
        tiaVolumeState.percentageVolume = percentageTMR.peakFlow;
        document.getElementById('percentRefResult').innerText = Math.round(percentageTMR.peakFlow) + ' vph';

        // Show which is greater (based on AC42 Peak Directional Flow)
        const greaterVolume = Math.max(tripGenTMR.peakFlow, percentageTMR.peakFlow);
        const useTripGen = tripGenTMR.peakFlow >= percentageTMR.peakFlow;
        const greaterMethod = useTripGen ? 'Trip Generation' : 'Percentage of Nearest Site';
        const selectedTMR = useTripGen ? tripGenTMR : percentageTMR;
        
        document.getElementById('greaterVolumeDisplay').innerHTML = `
            <strong style="color: #1f5e63; font-size: 1.1em;">Using: ${greaterMethod}</strong><br>
            <strong style="font-size: 1.2em; color: #d36b2c;">${Math.round(greaterVolume)} vph</strong>
        `;
        
        tiaVolumeState.selectedAadt = selectedTMR.aadt;
    }

    function applyCustomTIAVolume() {
        updateComparisonResults();
        document.getElementById('tia_aadt').value = Math.round(tiaVolumeState.selectedAadt);
        document.getElementById('tia_year_data').value = new Date().getFullYear();
        
        closeHouseholdModal();
        
        // Switch to TIA tab and scroll to calculation
        document.querySelector("button[onclick*='tab-tia']").click();
        setTimeout(() => {
            document.getElementById('tia_aadt').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }

    function updateLoganAnalysis() {
        const baseAADT = parseFloat(document.getElementById('loganInputAADT').value) || 0;
        const baseYear = parseInt(document.getElementById('loganBaseYear').innerText);
        const targetYear = parseInt(document.getElementById('loganTargetYear').value);
        const growthRate = parseFloat(document.getElementById('loganInputGrowth').value) / 100;
        const hvPercent = parseFloat(document.getElementById('loganInputHV').value) / 100;
        const analysisPct = parseFloat(document.getElementById('loganAnalysisPct').value) / 100;

        const years = Math.max(0, targetYear - baseYear);
        const projectedAADT = baseAADT * Math.pow((1 + growthRate), years);
        const finalAADT = projectedAADT * analysisPct;

        const peakHour80th = (finalAADT * 0.15) * 0.85;
        const offPeakHour = ((finalAADT - peakHour80th) * 0.15) * 0.45;

        const lanes = 1;
        const hourlyPerLane = peakHour80th / lanes;
        const vol5MinPerLane = hourlyPerLane / 12;
        const volLV = vol5MinPerLane * (1 - hvPercent);
        const volHV = vol5MinPerLane * hvPercent;

        const dayLimit = 750;
        const calc30thHour = Math.round((0.15 * dayLimit) / 2);
        const designCapacity = Math.max(calc30thHour, 500);

        document.getElementById('loganCapacity').value = designCapacity;

        const vcr = peakHour80th / designCapacity;

        let los = "F";
        let losClass = "los-f";
        if (vcr <= 0.60) { los = "A"; losClass = "los-a"; }
        else if (vcr <= 0.70) { los = "B"; losClass = "los-b"; }
        else if (vcr <= 0.90) { los = "C"; losClass = "los-c"; }
        else if (vcr <= 0.95) { los = "D"; losClass = "los-d"; }
        else if (vcr <= 1.00) { los = "E"; losClass = "los-e"; }

        document.getElementById('loganResAADT').innerText = Math.round(finalAADT).toLocaleString();
        document.getElementById('loganResPeakFlow').innerText = Math.round(peakHour80th).toLocaleString() + ' veh/hr';
        document.getElementById('loganResVCR').innerText = vcr.toFixed(3);

        const badge = document.getElementById('loganResLOS');
        if (badge) {
            badge.innerText = "LOS " + los;
            badge.className = "";
            badge.classList.add(losClass);
            badge.style.padding = "5px 10px";
            badge.style.borderRadius = "4px";
            badge.style.fontWeight = "bold";
        }

        const resultsSection = document.getElementById('loganResultsSection');
        if (resultsSection) {
            resultsSection.open = true;
        }

        buildLoganDirectionalQueues(peakHour80th, offPeakHour, hvPercent, lanes);
        buildLoganTrafficImpactAnalysis(peakHour80th, offPeakHour, designCapacity, lanes);

        // Pass data to unified calculation system
        const roadName = document.getElementById('loganSelectedName').innerText || 'Logan Site';
        passToCalculations_Manual(
            roadName,
            baseAADT,
            lanes,
            parseFloat(document.getElementById('loganInputHV').value) || 20.4,
            0,
            baseYear,
            parseFloat(document.getElementById('loganInputGrowth').value) || 2.5,
            targetYear
        );
    }

    function buildLoganDirectionalQueues(peakHour, offPeakHour, cvRatio, laneCount) {
        const section = document.getElementById('loganQueueSection');
        const contentElement = document.getElementById('loganQueueContent');

        if (!section || !contentElement) return;

        const directionLabels = ['Direction 1', 'Direction 2'];
        const directionPeakHour = peakHour / 2;
        const directionOffPeakHour = offPeakHour / 2;

        function buildDirectionalQueue(directionLabel, dirPeakHour, dirOffPeakHour, cvRatio, laneCount) {
            const hourlyPeak = dirPeakHour;
            const hourlyPeakCv = hourlyPeak * cvRatio;
            const hourlyOffPeak = dirOffPeakHour;
            const hourlyOffPeakCv = hourlyOffPeak * cvRatio;

            const hourlyPeakPerLane = hourlyPeak / laneCount;
            const hourlyPeakCvPerLane = hourlyPeakCv / laneCount;
            const hourlyOffPeakPerLane = hourlyOffPeak / laneCount;
            const hourlyOffPeakCvPerLane = hourlyOffPeakCv / laneCount;

            const peakVol5 = hourlyPeakPerLane / 12;
            const peakCvVol5 = hourlyPeakCvPerLane / 12;
            const offPeakVol5 = hourlyOffPeakPerLane / 12;
            const offPeakCvVol5 = hourlyOffPeakCvPerLane / 12;

            function queueLength(volume5Total, volume5Cv, lvFactor, hvFactor) {
                return (volume5Total * lvFactor) + (volume5Cv * hvFactor);
            }

            const q2Peak = queueLength(peakVol5, peakCvVol5, 2.4, 8);
            const q5Peak = queueLength(peakVol5, peakCvVol5, 6, 20);
            const q10Peak = queueLength(peakVol5, peakCvVol5, 12, 40);
            const q15Peak = queueLength(peakVol5, peakCvVol5, 18, 60);

            const q2Off = queueLength(offPeakVol5, offPeakCvVol5, 2.4, 8);
            const q5Off = queueLength(offPeakVol5, offPeakCvVol5, 6, 20);
            const q10Off = queueLength(offPeakVol5, offPeakCvVol5, 12, 40);
            const q15Off = queueLength(offPeakVol5, offPeakCvVol5, 18, 60);

            return `
                <div style="margin:15px 0; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #dee2e6;">
                    <h4 style="margin:0 0 15px 0; color:#1f5e63;">Queue Length Estimation: Logan - ${directionLabel}</h4>
                    <table style="width:100%; border-collapse:collapse; font-size:0.88em;">
                        <tr style="background:#f4f6f8; font-weight:bold;">
                            <td style="padding:8px; border:1px solid #ddd;" colspan="2"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">80th Highest Hour<br>(Peak traffic estimate)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">CV</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">Off-peak traffic<br>(Estimated Highest Hour - 45% of remaining volume)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:center;">CV</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd; font-weight:bold;" colspan="2">Hourly Average</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakCv).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakCv).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd; font-weight:bold;" colspan="2">Hourly Average per Lane</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakPerLane).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyPeakCvPerLane).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakPerLane).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(hourlyOffPeakCvPerLane).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd; font-weight:bold;" colspan="2">Queue length estimation</td>
                            <td style="padding:8px; border:1px solid #ddd;" colspan="4"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">Volume</td>
                            <td style="padding:8px; border:1px solid #ddd;">per 5 mins</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(peakVol5).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(peakCvVol5).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(offPeakVol5).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(offPeakCvVol5).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">2 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q2Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right; background:#cfe8b3;">${Math.round(q2Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">5 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q5Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q5Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">10 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q10Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q10Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid #ddd;">15 mins. Queue</td>
                            <td style="padding:8px; border:1px solid #ddd;">Length (m)</td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q15Peak).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                            <td style="padding:8px; border:1px solid #ddd; text-align:right;">${Math.round(q15Off).toLocaleString()}</td>
                            <td style="padding:8px; border:1px solid #ddd;"></td>
                        </tr>
                    </table>
                </div>
            `;
        }

        const html = buildDirectionalQueue(directionLabels[0], directionPeakHour, directionOffPeakHour, cvRatio, laneCount) +
                     buildDirectionalQueue(directionLabels[1], directionPeakHour, directionOffPeakHour, cvRatio, laneCount);

        contentElement.innerHTML = html;
        section.open = true;
    }

    function buildLoganTrafficImpactAnalysis(peakHour, offPeakHour, designCap, laneCount) {
        const section = document.getElementById('loganImpactSection');
        const contentElement = document.getElementById('loganImpactContent');
        const placeholder = document.getElementById('loganImpactPlaceholder');

        if (!section || !contentElement) return;

        if (placeholder) placeholder.style.display = 'none';
        contentElement.style.display = 'block';

        const dirPeakHour = peakHour / 2;
        const dirOffPeakHour = offPeakHour / 2;

        function getVcrClass(vcr) {
            if (vcr === 'N/A') return '';
            if (vcr <= 0.60) return 'los-a';
            if (vcr <= 0.70) return 'los-b';
            if (vcr <= 0.90) return 'los-c';
            if (vcr <= 0.95) return 'los-d';
            if (vcr <= 1.00) return 'los-e';
            return 'los-f';
        }

        function formatVcr(vcr) {
            return vcr === 'N/A' ? 'N/A' : vcr.toFixed(2);
        }

        const scenarios = [
            {
                label: 'Direction 1',
                peak: dirPeakHour / designCap,
                offPeak: dirOffPeakHour / designCap
            },
            {
                label: 'Direction 2',
                peak: dirPeakHour / designCap,
                offPeak: dirOffPeakHour / designCap
            },
            {
                label: '1 Lane Closure Direction 1',
                peak: laneCount > 1 ? (dirPeakHour / (laneCount - 1)) / designCap : 'N/A',
                offPeak: laneCount > 1 ? (dirOffPeakHour / (laneCount - 1)) / designCap : 'N/A'
            },
            {
                label: '1 Lane Closure Direction 2',
                peak: laneCount > 1 ? (dirPeakHour / (laneCount - 1)) / designCap : 'N/A',
                offPeak: laneCount > 1 ? (dirOffPeakHour / (laneCount - 1)) / designCap : 'N/A'
            },
            {
                label: 'Single Lane Reversible Flow',
                peak: (dirPeakHour * 2) / designCap,
                offPeak: (dirOffPeakHour * 2) / designCap
            }
        ];

        const html = `
            <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                <tr style="background:#f4f6f8; font-weight:bold;">
                    <td style="padding:8px; border:1px solid #ddd; font-weight:bold;">Design Volume (Capacity) *</td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">${Math.round(designCap).toLocaleString()}</td>
                    <td style="padding:8px; border:1px solid #ddd;" colspan="2"></td>
                </tr>
                <tr style="background:#f4f6f8; font-weight:bold;">
                    <td style="padding:8px; border:1px solid #ddd;">VCR (Degrees of Saturation)</td>
                    <td style="padding:8px; border:1px solid #ddd;"></td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">Peak</td>
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">Off-Peak</td>
                </tr>
                ${scenarios.map(s => `
                    <tr>
                        <td style="padding:8px; border:1px solid #ddd; font-weight:bold;">${s.label}</td>
                        <td style="padding:8px; border:1px solid #ddd;"></td>
                        <td style="padding:8px; border:1px solid #ddd; text-align:center; ${s.peak !== 'N/A' ? 'background-color:' : ''}" class="${s.peak !== 'N/A' ? getVcrClass(s.peak) : ''}">${formatVcr(s.peak)}</td>
                        <td style="padding:8px; border:1px solid #ddd; text-align:center; ${s.offPeak !== 'N/A' ? 'background-color:' : ''}" class="${s.offPeak !== 'N/A' ? getVcrClass(s.offPeak) : ''}">${formatVcr(s.offPeak)}</td>
                    </tr>
                `).join('')}
            </table>
        `;

        contentElement.innerHTML = html;
        section.open = true;
    }
</script>

    <!-- Modal: Household-Based Estimation for Custom TIA -->
    <div id="householdModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Custom TIA - Road Not in Traffic Count Database</div>
            <div class="modal-body">
                <p><strong>Project:</strong> <span style="color:#1f5e63;" id="tiaProjectDisplay"></span></p>
                
                <div style="background: #f0f8f7; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #1f5e63;">
                    <p style="margin: 0; font-size: 0.9em;"><strong>Reference Site (Nearest):</strong></p>
                    <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;" id="nearestSiteRef">Loading...</p>
                </div>

                <div class="option-section">
                    <div class="option-title">Method 1: Trip Generation from Households</div>
                    <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                        Estimate AADT from residential units based on development context
                    </p>
                    <div class="option-inputs">
                        <div>
                            <label style="margin-bottom: 3px;">Development Context</label>
                            <select id="devContext" onchange="updateComparisonResults()">
                                <option value="10.7">Metropolitan (Sydney/High Growth)</option>
                                <option value="7.4" selected>Regional / QLD (Standard)</option>
                                <option value="2.4">High Density Apartment</option>
                            </select>
                        </div>
                        <div>
                            <label style="margin-bottom: 3px;">Number of Dwellings (Units):</label>
                            <input type="number" id="dwellings" value="50" min="1" oninput="updateComparisonResults()">
                        </div>
                        <div>
                            <label style="margin-bottom: 3px;">Road Assignment Factor (%):</label>
                            <input type="number" id="roadAssign" value="100" min="0" max="100" step="5" oninput="updateComparisonResults()">
                        </div>
                        <div style="background: #e8f4f2; padding: 10px; border-radius: 4px;">
                            <strong style="color: #1f5e63;">Trip Generation AADT:</strong> <span id="tripGenResult">0</span> vph
                        </div>
                    </div>
                </div>

                <div class="option-section">
                    <div class="option-title">Method 2: Percentage of Reference Site</div>
                    <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                        Use a percentage of the nearest site's traffic volume
                    </p>
                    <div class="option-inputs">
                        <div>
                            <label style="margin-bottom: 3px;">Apply Percentage of Reference (%):</label>
                            <input type="number" id="percentRef" value="50" min="0" max="100" step="5" oninput="updateComparisonResults()">
                        </div>
                        <div style="background: #e8f4f2; padding: 10px; border-radius: 4px;">
                            <strong style="color: #1f5e63;">Percentage-Based AADT:</strong> <span id="percentRefResult">0</span> vph
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #fffbf0; border: 2px solid #d36b2c; border-radius: 6px;">
                    <p style="font-size: 0.9em; margin: 0 0 10px 0;">
                        <strong style="color: #1f5e63;">Selected Volume (Greater of Both Methods):</strong>
                    </p>
                    <div id="greaterVolumeDisplay" style="font-size: 1.15em; color: #d36b2c;">
                        0 vph
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="applyCustomTIAVolume()">Continue with TIA Calculation</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeHouseholdModal()">Cancel</button>
            </div>
        </div>
    </div>

</body>
</html>
